name: Build e Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:

    # ===============================
    # Checkout do código
    # ===============================
    - name: Checkout
      uses: actions/checkout@v4
      with:
        persist-credentials: true
        fetch-depth: 0

    # ===============================
    # Limpar cache WPF
    # ===============================
    - name: Limpar bin e obj
      run: |
        Get-ChildItem -Path . -Recurse -Directory -Include bin,obj | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force SistemaJuridico/bin -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force SistemaJuridico/obj -ErrorAction SilentlyContinue
      shell: pwsh

    # ===============================
    # Setup .NET
    # ===============================
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # ===============================
    # Corrigir dependências automaticamente
    # ===============================
    - name: Garantir versões MaterialDesign
      run: |
        dotnet add SistemaJuridico/SistemaJuridico.csproj package MaterialDesignColors --version 3.1.0
        dotnet add SistemaJuridico/SistemaJuridico.csproj package MaterialDesignThemes --version 5.1.0

    # ===============================
    # Commit automático se houver mudanças
    # ===============================
    - name: Commit alterações automáticas
      shell: pwsh
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add .

        if (git diff --cached --quiet) {
          Write-Host "Nenhuma alteração para commit."
        } else {
          git commit -m "CI: Atualização automática de dependências"
          git push
        }

    # ===============================
    # Restore
    # ===============================
    - name: Restaurar dependências
      run: dotnet restore SistemaJuridico/SistemaJuridico.csproj

    # ===============================
    # Build
    # ===============================
    - name: Build
      run: dotnet build SistemaJuridico/SistemaJuridico.csproj --configuration Release --no-restore

    # ===============================
    # Publish EXE
    # ===============================
    - name: Publicar executável
      run: |
        dotnet publish SistemaJuridico/SistemaJuridico.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:EnableCompressionInSingleFile=true `
          -o publish
      shell: pwsh

    # ===============================
    # Gerar versão automática
    # ===============================
    - name: Criar versão automática
      id: version
      run: |
        $version = "v$(Get-Date -Format yyyy.MM.dd.HHmm)"
        echo "version=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh

    # ===============================
    # Compactar build
    # ===============================
    - name: Compactar build
      id: zip
      shell: pwsh
      run: |
        $zipName = "SistemaJuridico-${{ steps.version.outputs.version }}.zip"
        Compress-Archive -Path publish\* -DestinationPath $zipName
        echo "zipName=$zipName" >> $env:GITHUB_OUTPUT

    # ===============================
    # Criar Release
    # ===============================
    - name: Criar Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: Release ${{ steps.version.outputs.version }}
        files: ${{ steps.zip.outputs.zipName }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
