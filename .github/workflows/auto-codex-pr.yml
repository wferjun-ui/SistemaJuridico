name: auto-codex-pr

on:
  push:
    branches-ignore:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    if: github.ref_type == 'branch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Criar PR para main (se ainda não existir)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ github.ref_name }}
        shell: bash
        run: |
          if [ "$BRANCH_NAME" = "main" ]; then
            echo "Branch main não gera PR automático"
            exit 0
          fi

          existing_pr=$(gh pr list --base main --head "$BRANCH_NAME" --state open --json number --jq '.[0].number')
          if [ -n "$existing_pr" ] && [ "$existing_pr" != "null" ]; then
            echo "PR já existente #$existing_pr para $BRANCH_NAME"
            exit 0
          fi

          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "chore: auto PR da branch $BRANCH_NAME" \
            --body "PR criado automaticamente pelo workflow auto-codex-pr."
