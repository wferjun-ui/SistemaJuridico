name: Auto Codex PR

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Instrução para o modelo gerar a mudança"
        required: true
        type: string
      base_branch:
        description: "Branch base para abrir o PR"
        required: false
        default: "main"
        type: string
      model:
        description: "Modelo OpenAI (ex: gpt-4.1-mini, gpt-5)"
        required: false
        default: "gpt-4.1-mini"
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install "openai>=1.40.0" "PyGithub>=2.3.0"

      - name: Generate PR via OpenAI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          PROMPT: ${{ github.event.inputs.prompt }}
          BASE_BRANCH: ${{ github.event.inputs.base_branch }}
          OPENAI_MODEL: ${{ github.event.inputs.model }}
        run: |
          python3 - << 'EOF'
          import json
          import os
          from datetime import datetime, timezone

          from github import Github
          from github.GithubException import GithubException
          from openai import OpenAI


          def fail(msg: str) -> None:
              raise SystemExit(msg)


          openai_api_key = os.getenv("OPENAI_API_KEY")
          github_token = os.getenv("GITHUB_TOKEN")
          repo_name = os.getenv("REPO_NAME")
          prompt = os.getenv("PROMPT", "").strip()
          base_branch = os.getenv("BASE_BRANCH", "main").strip()
          model = os.getenv("OPENAI_MODEL", "gpt-4.1-mini").strip()

          if not openai_api_key:
              fail("OPENAI_API_KEY não está configurada.")
          if not github_token:
              fail("GITHUB_TOKEN não está disponível.")
          if not repo_name:
              fail("REPO_NAME não informado.")
          if not prompt:
              fail("Informe um prompt ao disparar o workflow_dispatch.")

          client = OpenAI(api_key=openai_api_key)
          github = Github(github_token)
          repo = github.get_repo(repo_name)

          try:
              base_commit_sha = repo.get_branch(base_branch).commit.sha
          except GithubException as exc:
              fail(f"Branch base '{base_branch}' não encontrada: {exc}")

          run_id = os.getenv("RUN_ID", "manual")
          branch_name = f"codex-auto-{run_id}"

          try:
              repo.get_branch(branch_name)
          except GithubException:
              repo.create_git_ref(ref=f"refs/heads/{branch_name}", sha=base_commit_sha)

          system_prompt = (
              "Você é um assistente para automação de PR no GitHub. "
              "Retorne SOMENTE JSON válido com as chaves: title, body, file_path, file_content."
          )

          response = client.responses.create(
              model=model,
              instructions=system_prompt,
              input=prompt,
          )

          raw_output = (response.output_text or "").strip()
          if not raw_output:
              fail("Modelo retornou resposta vazia.")

          try:
              parsed = json.loads(raw_output)
          except json.JSONDecodeError:
              fail(
                  "A resposta do modelo não foi JSON válido. "
                  f"Resposta recebida: {raw_output[:500]}"
              )

          title = str(parsed.get("title", "PR automática via OpenAI")).strip() or "PR automática via OpenAI"
          body = str(parsed.get("body", "Gerada automaticamente via GitHub Actions + OpenAI API.")).strip()
          file_path = str(parsed.get("file_path", "codex_output.txt")).strip() or "codex_output.txt"
          file_content = str(parsed.get("file_content", "")).strip()

          if not file_content:
              now = datetime.now(timezone.utc).isoformat()
              file_content = f"Nenhum conteúdo foi gerado. Timestamp: {now}\nPrompt: {prompt}\n"

          commit_message = f"chore: conteúdo gerado via OpenAI ({run_id})"

          try:
              existing = repo.get_contents(file_path, ref=branch_name)
              repo.update_file(
                  path=file_path,
                  message=commit_message,
                  content=file_content,
                  sha=existing.sha,
                  branch=branch_name,
              )
          except GithubException:
              repo.create_file(
                  path=file_path,
                  message=commit_message,
                  content=file_content,
                  branch=branch_name,
              )

          open_pulls = repo.get_pulls(state="open", head=f"{repo.owner.login}:{branch_name}", base=base_branch)
          if open_pulls.totalCount > 0:
              print(f"PR já existe: {open_pulls[0].html_url}")
          else:
              pr = repo.create_pull(
                  title=title,
                  body=body,
                  head=branch_name,
                  base=base_branch,
              )
              print(f"PR criada: {pr.html_url}")
          EOF
