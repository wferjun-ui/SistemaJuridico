<UserControl x:Class="SistemaJuridico.Views.ContasView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:SistemaJuridico.ViewModels"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <Style x:Key="EntradaCellStyle" TargetType="TextBlock">
            <Setter Property="Foreground" Value="#15803D"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
        </Style>
        <Style x:Key="SaidaCellStyle" TargetType="TextBlock">
            <Setter Property="Foreground" Value="#B91C1C"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
        </Style>
    </UserControl.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="#F8FAFC" BorderBrush="#E2E8F0" BorderThickness="1" CornerRadius="8" Padding="12" Margin="0,0,0,8"
                Visibility="{Binding ExibirFormularioContas, Converter={StaticResource BoolToVis}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="1.3*"/>
                    <ColumnDefinition Width="1.1*"/>
                    <ColumnDefinition Width="1.1*"/>
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- ===== ROW 0: Tipo de Registro | Data | Responsável (não Alvará) ===== -->
                <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,8,6">
                    <TextBlock Text="Tipo de Registro *" FontWeight="SemiBold"/>
                    <ComboBox SelectedValuePath="Content"
                              SelectedValue="{Binding TipoLancamentoSelecionado, UpdateSourceTrigger=PropertyChanged}">
                        <ComboBoxItem Content="Alvará"/>
                        <ComboBoxItem Content="Tratamento"/>
                        <ComboBoxItem Content="Despesa Geral"/>
                    </ComboBox>
                </StackPanel>

                <StackPanel Grid.Row="0" Grid.Column="1" Margin="8,0,8,6">
                    <TextBlock Text="{Binding RotuloDataLancamento}" FontWeight="SemiBold"/>
                    <DatePicker SelectedDateFormat="Short"
                                Text="{Binding EdicaoConta.DataMovimentacao, UpdateSourceTrigger=PropertyChanged}"
                                Loaded="DatePicker_Loaded"/>
                </StackPanel>

                <StackPanel Grid.Row="0" Grid.Column="2" Margin="8,0,0,6" Visibility="{Binding ExibirCampoResponsavel, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="Responsável" FontWeight="SemiBold"/>
                    <TextBox Text="{Binding EdicaoConta.Responsavel, UpdateSourceTrigger=PropertyChanged}"/>
                </StackPanel>

                <!-- ===== ROW 1 (Alvará): Mov. processo | Valor Alvará | Nº Alvará ===== -->
                <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,8,6" Visibility="{Binding IsAlvara, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="Mov. processo *" FontWeight="SemiBold"/>
                    <TextBox Text="{Binding EdicaoConta.MovProcesso, UpdateSourceTrigger=PropertyChanged}"/>
                </StackPanel>

                <StackPanel Grid.Row="1" Grid.Column="1" Margin="8,0,8,6" Visibility="{Binding IsAlvara, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="Valor do Alvará *" FontWeight="SemiBold" Foreground="#15803D"/>
                    <TextBox Text="{Binding ValorAlvaraTexto, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" TextChanged="ValorAlvara_TextChanged"/>
                </StackPanel>

                <StackPanel Grid.Row="1" Grid.Column="2" Margin="8,0,0,6" Visibility="{Binding IsAlvara, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="Nº Alvará *" FontWeight="SemiBold"/>
                    <TextBox Text="{Binding EdicaoConta.NumNfAlvara, UpdateSourceTrigger=PropertyChanged}"/>
                </StackPanel>

                <!-- ===== ROW 1 (Tratamento/Despesa Geral): Mov. NF (Anexo/Digitar) | Mov digitado | Nº NF ===== -->
                <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,8,6" Visibility="{Binding IsMovProcessoComboVisivel, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="Mov. processo *" FontWeight="SemiBold"/>
                    <ComboBox SelectedValue="{Binding ModoMovimentoConta, UpdateSourceTrigger=PropertyChanged}" SelectedValuePath="Content">
                        <ComboBoxItem Content="Anexo"/>
                        <ComboBoxItem Content="Digitar"/>
                    </ComboBox>
                </StackPanel>

                <StackPanel Grid.Row="1" Grid.Column="1" Margin="8,0,8,6" Visibility="{Binding ExibirCampoMovimentoDigitado, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="Nº movimento digitado *" FontWeight="SemiBold"/>
                    <TextBox Text="{Binding MovimentoContaDigitado, UpdateSourceTrigger=PropertyChanged}"/>
                </StackPanel>

                <StackPanel Grid.Row="1" Grid.Column="2" Margin="8,0,0,6" Visibility="{Binding IsMovProcessoComboVisivel, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="{Binding RotuloNumeroDocumento}" FontWeight="SemiBold"/>
                    <TextBox Text="{Binding EdicaoConta.NumNfAlvara, UpdateSourceTrigger=PropertyChanged}"/>
                </StackPanel>

                <!-- ===== ROW 2 (Tratamento): Terapia dropdown | Valor NF | Terapia manual (se OUTRO) ===== -->
                <StackPanel Grid.Row="2" Grid.Column="0" Margin="0,0,8,6" Visibility="{Binding ExibirCampoTerapia, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="Terapia / Medicamento *" FontWeight="SemiBold"/>
                    <ComboBox ItemsSource="{Binding TerapiasMedicamentosDisponiveis}" SelectedItem="{Binding EdicaoConta.TerapiaMedicamentoNome, UpdateSourceTrigger=PropertyChanged}"/>
                </StackPanel>

                <!-- ===== ROW 2 (Despesa Geral): Nome da despesa por extenso ===== -->
                <StackPanel Grid.Row="2" Grid.Column="0" Margin="0,0,8,6" Visibility="{Binding IsDespesaGeral, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="Tipo de Despesa (por extenso) *" FontWeight="SemiBold"/>
                    <TextBox Text="{Binding NomeDespesaGeral, UpdateSourceTrigger=PropertyChanged}"/>
                </StackPanel>

                <!-- Valor da NF/Conta (Tratamento e Despesa Geral) -->
                <StackPanel Grid.Row="2" Grid.Column="1" Margin="8,0,8,6" Visibility="{Binding IsMovProcessoComboVisivel, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="Valor da NF *" FontWeight="SemiBold" Foreground="#B91C1C"/>
                    <TextBox Text="{Binding ValorContaTexto, Mode=OneWay, UpdateSourceTrigger=PropertyChanged}" TextChanged="ValorConta_TextChanged"/>
                </StackPanel>

                <!-- Terapia manual (quando OUTRO selecionado - Tratamento) -->
                <StackPanel Grid.Row="2" Grid.Column="2" Margin="8,0,0,6" Visibility="{Binding ExibirCampoTerapiaManual, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="Outro (informar) *" FontWeight="SemiBold"/>
                    <TextBox Text="{Binding TerapiaManual, UpdateSourceTrigger=PropertyChanged}"/>
                </StackPanel>

                <!-- ===== ROW 3 (Tratamento + Despesa Geral): Quantidade (com ▲▼) | Mês Ref | Ano Ref ===== -->
                <Grid Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="3" Margin="0,0,0,6" Visibility="{Binding IsMovProcessoComboVisivel, Converter={StaticResource BoolToVis}}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Grid.Column="0" Margin="0,0,8,0">
                        <TextBlock Text="Quantidade" FontWeight="SemiBold"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="20"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="QtdContaTextBox" Grid.Column="0" Text="{Binding EdicaoConta.Quantidade, UpdateSourceTrigger=PropertyChanged}" MaxLength="12" VerticalContentAlignment="Center"/>
                            <StackPanel Grid.Column="1" Margin="2,0,0,0">
                                <Button Content="▲" Width="18" Height="12" Padding="0" FontSize="8" Click="IncrementarQuantidade_Click" CommandParameter="{Binding ElementName=QtdContaTextBox}"/>
                                <Button Content="▼" Width="18" Height="12" Padding="0" FontSize="8" Click="DecrementarQuantidade_Click" CommandParameter="{Binding ElementName=QtdContaTextBox}"/>
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                    <StackPanel Grid.Column="1" Margin="8,0,8,0">
                        <TextBlock Text="Mês Referência" FontWeight="SemiBold"/>
                        <TextBox Text="{Binding EdicaoConta.MesReferencia, UpdateSourceTrigger=PropertyChanged}" MaxLength="2"/>
                    </StackPanel>
                    <StackPanel Grid.Column="2" Margin="8,0,0,0">
                        <TextBlock Text="Ano Referência" FontWeight="SemiBold"/>
                        <TextBox Text="{Binding EdicaoConta.AnoReferencia, UpdateSourceTrigger=PropertyChanged}" MaxLength="4"/>
                    </StackPanel>
                </Grid>

                <!-- ===== ROW 4 (Tratamento + Despesa Geral): Observações ===== -->
                <StackPanel Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="3" Margin="0,0,0,6" Visibility="{Binding IsMovProcessoComboVisivel, Converter={StaticResource BoolToVis}}">
                    <TextBlock Text="Observações" FontWeight="SemiBold"/>
                    <TextBox Text="{Binding EdicaoConta.Observacoes, UpdateSourceTrigger=PropertyChanged}" Height="56" AcceptsReturn="True" TextWrapping="Wrap"/>
                </StackPanel>

            </Grid>
        </Border>

        <ScrollViewer Grid.Row="1"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Disabled"
                      Margin="0,0,0,8"
                      Visibility="{Binding ExibirFormularioContas, Converter={StaticResource BoolToVis}}">
            <WrapPanel HorizontalAlignment="Left" ItemHeight="38">
            <Button Content="Adicionar ao rascunho" Command="{Binding AdicionarRascunhoCommand}" IsEnabled="{Binding PodeCadastrar}" Margin="4" MinWidth="165" Padding="12,7"/>
            <Button Content="Confirmar rascunhos" Command="{Binding ConfirmarRascunhosCommand}" IsEnabled="{Binding PodeCadastrar}" Margin="4" MinWidth="160" Padding="12,7"/>
            <Button Content="Limpar rascunhos" Command="{Binding LimparRascunhosCommand}" IsEnabled="{Binding PodeCadastrar}" Margin="4" MinWidth="145" Padding="12,7"/>
            <Button Content="Salvar edição" Command="{Binding SalvarEdicaoContaCommand}" IsEnabled="{Binding PodeEditar}" Margin="4" MinWidth="130" Padding="12,7"/>
            <Button Content="Editar selecionada" Command="{Binding EditarContaCommand}" IsEnabled="{Binding PodeEditar}" Margin="4" MinWidth="145" Padding="12,7"/>
            <Button Content="Excluir selecionada" Command="{Binding ExcluirContaCommand}" IsEnabled="{Binding PodeExcluir}" Margin="4" MinWidth="150" Padding="12,7"/>
            <Button Content="Lançar selecionada" Command="{Binding FecharContaCommand}" IsEnabled="{Binding PodeEditar}" Margin="4" MinWidth="150" Padding="12,7"/>
                <Button Content="Exportar PDF" Command="{Binding ExportarPrestacaoContasPdfCommand}" Margin="4" MinWidth="120" Padding="12,7"/>
            </WrapPanel>
        </ScrollViewer>

        <GroupBox Header="Rascunhos de contas" Grid.Row="2" Margin="0,0,0,8"
                  Visibility="{Binding ExibirFormularioContas, Converter={StaticResource BoolToVis}}">
            <DataGrid ItemsSource="{Binding ContasRascunho}" AutoGenerateColumns="False" IsReadOnly="True" PreviewMouseWheel="DataGrid_PreviewMouseWheel">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Data" Binding="{Binding DataMovimentacao}" Width="SizeToHeader"/>
                    <DataGridTextColumn Header="Tipo" Binding="{Binding TipoLancamento}" Width="SizeToHeader"/>
                    <DataGridTextColumn Header="Mov. Proc." Binding="{Binding MovProcesso}" Width="SizeToHeader"/>
                    <DataGridTextColumn Header="Histórico" Binding="{Binding Historico}" Width="*"/>
                    <DataGridTextColumn Header="Entrada" Binding="{Binding ValorAlvara, StringFormat=R$ {0:N2}}" Width="SizeToHeader"/>
                    <DataGridTextColumn Header="Saída" Binding="{Binding ValorConta, StringFormat=R$ {0:N2}}" Width="SizeToHeader"/>
                    <DataGridTemplateColumn Header="Ações" Width="SizeToCells">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <WrapPanel>
                                    <Button ToolTip="Editar rascunho"
                                            Command="{Binding DataContext.EditarRascunhoCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            Padding="8,6"
                                            MinWidth="36">
                                        <materialDesign:PackIcon Kind="Pencil" Width="16" Height="16"/>
                                    </Button>
                                    <Button ToolTip="Confirmar este rascunho"
                                            Command="{Binding DataContext.ConfirmarRascunhoCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            Padding="8,6"
                                            MinWidth="36">
                                        <materialDesign:PackIcon Kind="CheckBold" Width="16" Height="16"/>
                                    </Button>
                                    <Button ToolTip="Remover rascunho"
                                            Command="{Binding DataContext.RemoverRascunhoCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            Padding="8,6"
                                            MinWidth="36">
                                        <materialDesign:PackIcon Kind="Delete" Width="16" Height="16"/>
                                    </Button>
                                </WrapPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </GroupBox>

        <GroupBox Header="Prestação de contas (saldo progressivo)" Grid.Row="3">
            <DataGrid ItemsSource="{Binding HistoricoContas}" SelectedItem="{Binding ContaSelecionada}" AutoGenerateColumns="False" IsReadOnly="True" PreviewMouseWheel="DataGrid_PreviewMouseWheel">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Data" Binding="{Binding Conta.DataMovimentacao}" Width="SizeToHeader"/>
                    <DataGridTextColumn Header="Tipo" Binding="{Binding Conta.TipoLancamento}" Width="SizeToHeader"/>
                    <DataGridTextColumn Header="Mov. Processo" Binding="{Binding Conta.MovProcesso}" Width="SizeToHeader"/>
                    <DataGridTextColumn Header="Nº Alvará / NF" Binding="{Binding Conta.NumNfAlvara}" Width="SizeToHeader"/>
                    <DataGridTextColumn Header="Histórico/Detalhes" Binding="{Binding Conta.Historico}" Width="*"/>
                    <DataGridTextColumn Header="Crédito" Binding="{Binding Conta.ValorAlvara, StringFormat=R$ {0:N2}}" Width="SizeToHeader" ElementStyle="{StaticResource EntradaCellStyle}"/>
                    <DataGridTextColumn Header="Débito" Binding="{Binding Conta.ValorConta, StringFormat=R$ {0:N2}}" Width="SizeToHeader" ElementStyle="{StaticResource SaidaCellStyle}"/>
                    <DataGridTextColumn Header="Observações" Binding="{Binding Conta.Observacoes}" Width="220"/>
                    <DataGridTextColumn Header="Saldo parcial" Binding="{Binding SaldoParcial, StringFormat=R$ {0:N2}}" Width="SizeToHeader"/>
                    <DataGridTemplateColumn Header="Ações" Width="SizeToCells">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <WrapPanel>
                                    <Button ToolTip="Editar conta"
                                            Command="{Binding DataContext.EditarContaHistoricoCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            IsEnabled="{Binding Conta.PodeEditar}"
                                            Padding="8,6"
                                            MinWidth="36">
                                        <materialDesign:PackIcon Kind="Pencil" Width="16" Height="16"/>
                                    </Button>
                                    <Button ToolTip="Excluir conta"
                                            Command="{Binding DataContext.ExcluirContaHistoricoCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            IsEnabled="{Binding Conta.PodeEditar}"
                                            Padding="8,6"
                                            MinWidth="36">
                                        <materialDesign:PackIcon Kind="Delete" Width="16" Height="16"/>
                                    </Button>
                                    <Button ToolTip="Lançar conta"
                                            Command="{Binding DataContext.LancarContaHistoricoCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            IsEnabled="{Binding Conta.PodeEditar}"
                                            Padding="8,6"
                                            MinWidth="36">
                                        <iconPacks:PackIconFontAwesome Kind="MoneyCheckDollarSolid" Width="16" Height="16"/>
                                    </Button>
                                </WrapPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </GroupBox>
    </Grid>
</UserControl>
