<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V0.3.0 Open Beta - Stable - Controle de Processos Jurídicos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .tab-btn {
      transition: all 0.3s ease;
      border-bottom: 2px solid transparent;
      padding-bottom: 8px;
    }

    .tab-btn.active {
      border-bottom-color: #4f46e5;
      /* indigo-600 */
      color: #4f46e5;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

.modal-content {
  background-color: white;
  border-radius: 0.5rem;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  max-width: 95%;
  width: 950px; /* <-- NOVA LARGURA MAIOR */
  max-height: 90vh;
  overflow-y: auto;
}

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border-left-color: #fff;
      animation: spin 1s ease infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Estilos para a nova caixa de mensagem (showMessageBox) - HIGHER Z-INDEX */
    .message-box-modal {
      z-index: 60;
    }

    .message-box-modal .modal-content {
      max-width: 400px;
      padding: 2rem;
      text-align: center;
    }

    .message-box-modal .icon-wrapper {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .message-box-modal .message-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .message-box-modal .message-text {
      font-size: 1rem;
      color: #6b7280;
      /* gray-500 */
      margin-bottom: 1.5rem;
    }

    .message-box-modal .button-group {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    /* Estilos para o modal de carregamento global */
    #global-loading-modal {
      z-index: 50;
    }

    #global-loading-modal .modal-content {
      max-width: 300px;
      padding: 2rem;
      text-align: center;
    }

    #global-loading-modal .spinner {
      width: 40px;
      height: 40px;
      border-width: 4px;
      border-left-color: #4f46e5;
      /* indigo-600 */
    }

    /* NOVO: Estilos para Toast Notifications */
    #toast-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 70;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: flex-end;
    }

    .toast {
      background-color: #333;
      color: white;
      padding: 0.75rem 1.25rem;
      border-radius: 0.375rem;
      /* rounded-md */
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.2);
      opacity: 0;
      transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      transform: translateY(100%);
      min-width: 200px;
      max-width: 300px;
      display: flex;
      align-items: center;
      font-size: 0.875rem;
      /* text-sm */
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.info {
      background-color: #3b82f6;
      /* blue-500 */
    }

    .toast.success {
      background-color: #22c55e;
      /* green-500 */
    }

    .toast.warning {
      background-color: #f97316;
      /* orange-500 */
    }

    .toast.error {
      background-color: #ef4444;
      /* red-500 */
    }

    .toast i {
      margin-right: 0.5rem;
    }
  </style>
</head>

<body>
  <div class="bg-white shadow-md pb-4">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 pb-0">
      <div class="flex justify-between items-center mb-4">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center">
          <i class="fas fa-gavel mr-2"></i>Controle de Processos
          <span id="sync-indicator" class="ml-4 text-sm font-normal text-gray-500 items-center hidden">
            <div class="spinner !w-4 !h-4 !border-2 !border-l-indigo-600 mr-2"></div>
            Sincronizando... </span>
        <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-gavel mr-2"></i>Controle de Processos</h1>
        <div class="flex space-x-2">
          <button id="open-report-advanced-search-modal-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
       <i class="fas fa-chart-bar mr-2"></i>Relatórios / Busca
      </button>
          <button id="open-admin-config-modal-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
       <i class="fas fa-users-cog mr-2"></i>Configurações do App
      </button>
        </div>
      </div>
      <!-- Processos Atrasados e Para Atrasar (topo) -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div id="atrasados-panel" class="bg-red-100 p-4 rounded-lg border border-red-200 text-red-800">
          <h3 class="text-lg font-semibold text-red-700 mb-2 flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            Processos Atrasados (<span id="count-atrasados">0</span>)
          </h3>
          <ul id="list-atrasados" class="space-y-1 text-sm max-h-24 overflow-y-auto">
          </ul>
          <p id="no-atrasados" class="text-sm text-red-500 hidden">Nenhum processo atrasado.</p>
        </div>
        <div id="para-atrasar-panel" class="bg-yellow-100 p-4 rounded-lg border border-yellow-200 text-yellow-800">
          <h3 class="text-lg font-semibold text-yellow-700 mb-2 flex items-center">
            <i class="fas fa-clock mr-2"></i>
            Para Atrasar (<span id="count-para-atrasar">0</span>)
          </h3>
          <ul id="list-para-atrasar" class="space-y-1 text-sm max-h-24 overflow-y-auto">
          </ul>
          <p id="no-para-atrasar" class="text-sm text-orange-500 hidden">Nenhum processo para atrasar.</p>
        </div>
      </div>
      <!-- Barra de Pesquisa/Cadastro (esquerda) e Usuários Ativos (direita) -->
      <div class="flex flex-col md:flex-row gap-4 mb-6">
        <div class="flex-grow flex flex-col gap-4">
          <!-- Content for search and new process -->
          <div class="relative" id="custom-process-selector">
            <label for="search-select-input" class="block text-sm font-medium text-gray-700"><i class="fas fa-search mr-1"></i>Pesquisar e Selecionar Processo</label>
            <input type="text" id="search-select-input" placeholder="Digite 3+ letras para pesquisar ou clique para ver a lista..." class="w-full mt-1 p-2 border border-gray-300 rounded-md shadow-sm pr-10 focus:ring-2 focus:ring-indigo-500" autocomplete="off">
            <div class="pointer-events-none absolute inset-y-0 right-0 top-7 flex items-center px-3 text-gray-400">
              <i class="fas fa-caret-down"></i>
            </div>
            <div id="options-panel"
              class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-60 overflow-y-auto hidden">
            </div>
          </div>
          <button id="open-novo-processo-modal-btn" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 flex-shrink-0">
       <i class="fas fa-plus mr-2"></i>Novo Processo
      </button>
        </div>
        <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 shadow-sm md:w-1/3 md:ml-4">
          <h3 class="text-md font-semibold text-blue-700 mb-2 flex items-center">
            <i class="fas fa-users mr-2"></i>Usuários Ativos Recentemente
          </h3>
          <div id="active-users-list" class="space-y-1 text-sm max-h-24 overflow-y-auto">
            <p class="text-gray-500 text-sm">Carregando...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="page-content-wrapper" class="container mx-auto p-4 sm:p-6 lg:p-8 pt-0">
    <main id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6 hidden"></main>
    <div id="initial-state" class="text-center p-10 bg-white rounded-lg shadow-md">
      <div id="loader" class="flex justify-center items-center flex-col">
        <div class="spinner !w-10 !h-10 !border-4 !border-l-indigo-600"></div>
        <p class="mt-4 text-gray-500">Carregando...</p>
      </div>
      <div id="welcome-message" class="hidden">
        <i class="fas fa-folder-open text-4xl text-gray-400 mb-4"></i>
        <h2 class="text-xl font-semibold">Nenhum processo selecionado</h2>
        <p class="text-gray-500">Pesquise ou selecione um processo na lista acima, ou clique em "Novo Processo"
          para começar.</p>
      </div>
      <div id="user-check-prompt" class="hidden mt-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
        <p id="user-check-message" class="text-blue-700 font-medium mb-4"></p>
        <form id="register-user-form" class="hidden space-y-4">
          <div>
            <label for="register-name" class="block text-sm font-medium text-gray-700">Seu Nome:</label>
            <input type="text" id="register-name" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm" required autocomplete="name">
          </div>
          <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Registrar Meu Nome</button>
        </form>
      </div>
    </div>
  </div>
  <div id="modals-container"></div>
  <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
  <div id="global-loading-modal" class="modal-backdrop hidden fade-in">
    <div class="modal-content">
      <div class="flex flex-col items-center justify-center">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-700 font-semibold">Carregando...</p>
      </div>
    </div>
  </div>
  <!-- Novo Modal de Relatórios e Busca Avançada -->
  <div id="report-advanced-search-modal" class="modal-backdrop hidden fade-in">
    <div class="modal-content">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-gray-800"><i class="fas fa-chart-bar mr-2"></i>Relatórios e
            Busca Avançada</h3>
          <button class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl leading-none" data-modal-id="report-advanced-search-modal">&times;</button>
        </div>
        <div class="mb-6 border-b pb-4">
          <h4 class="font-semibold text-lg mb-2"><i class="fas fa-file-alt mr-2"></i>Gerar Relatório Resumo
          </h4>
          <p class="text-sm text-gray-600 mb-3">Obtenha contagens totais de processos por status e tipo.</p>
          <button id="generate-report-btn" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
         <i class="fas fa-sync-alt mr-2"></i>Gerar Relatório
        </button>
          <button id="export-pdf-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 ml-2">
         <i class="fas fa-file-pdf mr-2"></i>Exportar para PDF
        </button>
          <div id="report-summary-output"
            class="mt-4 p-3 bg-gray-50 rounded-md text-sm max-h-60 overflow-y-auto hidden">
          </div>
        </div>
        <div>
          <h4 class="font-semibold text-lg mb-2"><i class="fas fa-filter mr-2"></i>Busca Avançada de Processos
          </h4>
          <form id="advanced-search-form" class="space-y-4">
            <div>
              <label for="adv-search-term" class="block text-sm font-medium text-gray-700"><i class="fas fa-search mr-1"></i>Termo de Busca (Número, Paciente, Genitor)</label>
              <input type="text" id="adv-search-term" placeholder="Ex: 0012345-67 ou João Silva" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm" autocomplete="off">
            </div>
            <div>
              <label for="adv-filter-status" class="block text-sm font-medium text-gray-700"><i class="fas fa-info-circle mr-1"></i>Status do Processo</label>
              <select id="adv-filter-status" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white">
           <option value="">Todos os Status</option>
           <option>Cumprimento de Sentença</option><option>Cumprimento Provisório de Sentença</option><option>Conhecimento</option><option>Recurso Inominado</option><option>Apelação</option><option>Agravo</option><option>Suspenso</option><option>Arquivado</option><option>Cumprimento Extinto</option><option>Desistência da Parte</option>
          </select>
            </div>
            <div>
              <label for="adv-filter-type" class="block text-sm font-medium text-gray-700"><i class="fas fa-tag mr-1"></i>Tipo de Processo</label>
              <select id="adv-filter-type" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white">
           <option value = disabled selected> Selecione um tipo...</option>
           <option value="">Todos os Tipos</option>
           <option>Ação Coletiva</option>
           <option>Mandado de Segurança</option>
           <option>Indenizatória</option>
           <option>Tributária</option>
           <option>Previdenciária</option>
           <option>Cível (Geral)</option>
           <option>Saúde</option>
          </select>
            </div>
            <div>
              <label for="adv-filter-judge" class="block text-sm font-medium text-gray-700"><i class="fas fa-user-tie mr-1"></i>Nome do Juiz(a)</label>
              <input type="text" id="adv-filter-judge" placeholder="Nome do Juiz" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm" autocomplete="off">
            </div>
            <!-- NOVO: Filtros de Ordenação -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="adv-sort-by" class="block text-sm font-medium text-gray-700"><i class="fas fa-sort mr-1"></i>Ordenar por</label>
                <select id="adv-sort-by" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white">
          <option value="none">Padrão</option>
          <option value="paciente">Paciente</option>
          <option value="numero">Número do Processo</option>
          <option value="juiz">Juiz(a)</option>
          <option value="tipo">Tipo de Processo</option>
          <option value="statusProcesso">Status do Processo</option>
         </select>
              </div>
              <div>
                <label for="adv-sort-order" class="block text-sm font-medium text-gray-700"><i class="fas fa-sort-amount-down mr-1"></i>Ordem</label>
                <select id="adv-sort-order" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white">
          <option value="asc">Crescente</option>
          <option value="desc">Decrescente</option>
         </select>
              </div>
            </div>
            <div class="flex justify-end gap-2">
              <button type="reset" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300"><i class="fas fa-eraser mr-2"></i>Limpar Filtros</button>
              <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"><i class="fas fa-search mr-2"></i>Buscar Processos</button>
            </div>
          </form>
          <div id="advanced-search-results-output" class="mt-4 space-y-2 max-h-60 overflow-y-auto hidden">
          </div>
          <div id="advanced-search-pagination" class="flex justify-center mt-4 hidden">
            <button id="adv-prev-page" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md mr-2 hover:bg-gray-300"><i class="fas fa-chevron-left"></i> Anterior</button>
            <span id="adv-page-info" class="text-gray-700 flex items-center">Página 1</span>
            <button id="adv-next-page" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md ml-2 hover:bg-gray-300">Próxima <i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // app.js
 document.addEventListener('DOMContentLoaded', () => {
  // Objeto de estado global para a aplicação
  // --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Objeto: appState) ---
    const appState = {
        db: { 
            processos: [],
            painelAtrasados: [],
            painelParaAtrasar: [] 
        },
        processoSelecionado: null,
        isEditing: false,
        terapiasAdicionadas: [],
        medicamentosAdicionadas: [],
        cirurgiasAdicionadas: [],
        outrosItensAdicionados: [],
        contasEmRascunho: [],
        currentVerificationFormData: {},
        currentUser: {
            isRegistered: false, // Está na lista de usuários?
            isAdmin: false,
            isDomainUser: false, // É do domínio da instituição?
            email: null,
            nome: 'Não identificado',
            id: null
},
        config: {}, // <--- ADIÇÃO AQUI
        advancedSearch: {
            currentPage: 1,
            itemsPerPage: 10,
            results: [],
            sortBy: 'none',
            sortOrder: 'asc',
            visibleColumns: {
                'paciente': true, 'numero': true, 'juiz': true, 'tipo': true,
                'statusProcesso': true, 'genitor': true, 'ultimaprescricao': true,
                'id': false, 'verificacoes': false, 'terapias': false,
                'medicamentos': false, 'cirurgias': false, 'outrosItens': false
            }
        }
    };
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---
  // Constantes e Utilitários Globais
  const MIN_PROCESS_NUMBER_LENGTH = 15;
  /**
   * @module Utils
   * Funções utilitárias e auxiliares.
   */
  const Utils = (() => {
   function showToast(message, type = 'info', duration = 3000) {
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) return;
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    let iconHtml = '';
    switch (type) {
     case 'success': iconHtml = '<i class="fas fa-check-circle"></i>'; break;
     case 'error': iconHtml = '<i class="fas fa-times-circle"></i>'; break;
     case 'warning': iconHtml = '<i class="fas fa-exclamation-triangle"></i>'; break;
     default: iconHtml = '<i class="fas fa-info-circle"></i>'; break;
    }
    toast.innerHTML = `${iconHtml}<span>${message}</span>`;
    toastContainer.appendChild(toast);
    void toast.offsetWidth;
    toast.classList.add('show');
    setTimeout(() => {
     toast.classList.remove('show');
     toast.addEventListener('transitionend', () => toast.remove());
    }, duration);
   }
// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: calculateRunningBalance) ---
  function calculateRunningBalance(contas) {
   if (!contas || !Array.isArray(contas)) {
    return 0;
   }
   // Lógica corrigida para ler o array de contas.
   return contas.reduce((saldo, conta) => {
    const entrada = parseFloat(conta.valorAlvara) || 0;
    const saida = parseFloat(conta.valorConta) || 0;
    return saldo + entrada - saida;
   }, 0);
  }
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---
 // --- INÍCIO DO NOVO CÓDIGO ---
  /**
   * Formata um valor numérico para uma string de moeda BRL (R$).
   * @param {number | string} value O valor a ser formatado.
   * @returns {string} A string formatada, ex: "R$ 1.234,56".
   */
  function formatAsBRL(value) {
   if (value === null || value === undefined) return '';
   // Pega apenas os dígitos do valor de entrada
   let onlyDigits = String(value).replace(/\D/g, '');
   if (onlyDigits === '') return '';
   // Converte a string de dígitos em um número (ex: "12345" se torna 123.45)
   const numericValue = parseFloat(onlyDigits) / 100;
   // Usa a API Intl para formatar corretamente
   return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL'
   }).format(numericValue);
  }
  /**
   * Converte uma string de moeda formatada de volta para um número.
   * @param {string} formattedValue A string formatada, ex: "R$ 1.234,56".
   * @returns {number} O valor numérico, ex: 1234.56.
   */
  function parseBRL(formattedValue) {
   if (!formattedValue || typeof formattedValue !== 'string') return 0;
   // Pega apenas os dígitos e os converte para o formato numérico correto (1234.56)
   const onlyDigits = formattedValue.replace(/\D/g, '');
   if (onlyDigits === '') return 0;
   return parseFloat(onlyDigits) / 100;
  }
  // --- FIM DO NOVO CÓDIGO ---
   function showMessageBox(message, type = 'info', title = 'Atenção!') {
    return new Promise((resolve) => {
     const modalsContainer = document.getElementById('modals-container');
     let messageBox = document.getElementById('messageBox');
     if (!messageBox) {
      const div = document.createElement('div');
      div.id = 'messageBox';
      div.className = 'modal-backdrop hidden fade-in message-box-modal';
      div.innerHTML = `
       <div class="modal-content">
        <div class="icon-wrapper"></div>
        <h3 class="message-title"></h3>
        <p class="message-text"></p>
        <div class="button-group">
         <button id="messageConfirmBtn" class="py-2 px-5 text-white rounded-md focus:outline-none"></button>
         <button id="messageCancelBtn" class="py-2 px-5 bg-gray-400 text-white rounded-md hover:bg-gray-500 focus:outline-none hidden">Cancelar</button>
        </div>
       </div>
      `;
      modalsContainer.appendChild(div);
      messageBox = document.getElementById('messageBox');
     }
     
     const iconWrapper = messageBox.querySelector('.icon-wrapper');
     const messageTitle = messageBox.querySelector('.message-title');
     const messageText = messageBox.querySelector('.message-text');
     const oldConfirmBtn = messageBox.querySelector('#messageConfirmBtn');
     const newConfirmBtn = oldConfirmBtn.cloneNode(true);
     oldConfirmBtn.parentNode.replaceChild(newConfirmBtn, oldConfirmBtn);
     const oldCancelBtn = messageBox.querySelector('#messageCancelBtn');
     const newCancelBtn = oldCancelBtn.cloneNode(true);
     oldCancelBtn.parentNode.replaceChild(newCancelBtn, oldCancelBtn);
     
     const currentConfirmBtn = newConfirmBtn;
     const currentCancelBtn = newCancelBtn;
     
     currentCancelBtn.classList.add('hidden');
     messageText.textContent = message;
     messageTitle.textContent = title;
     
     let iconHtml = '';
     let confirmBtnClasses = [];
     switch (type) {
      case 'error':
       iconHtml = '<i class="fas fa-times-circle text-red-500"></i>';
       confirmBtnClasses = ['bg-red-600', 'hover:bg-red-700'];
       messageTitle.textContent = 'Erro!';
       currentConfirmBtn.textContent = 'OK';
       break;
      case 'warning':
       iconHtml = '<i class="fas fa-exclamation-triangle text-orange-500"></i>';
       confirmBtnClasses = ['bg-orange-600', 'hover:bg-orange-700'];
       messageTitle.textContent = 'Alerta!';
       currentConfirmBtn.textContent = 'OK';
       break;
      case 'confirm':
       iconHtml = '<i class="fas fa-question-circle text-blue-500"></i>';
       confirmBtnClasses = ['bg-blue-600', 'hover:bg-blue-700'];
       messageTitle.textContent = title;
       currentConfirmBtn.textContent = 'Sim';
       currentCancelBtn.classList.remove('hidden');
       currentCancelBtn.addEventListener('click', () => {
        messageBox.classList.add('hidden');
        resolve(false);
       }, { once: true });
       break;
      default:
       iconHtml = '<i class="fas fa-info-circle text-indigo-500"></i>';
       confirmBtnClasses = ['bg-indigo-600', 'hover:bg-indigo-700'];
       currentConfirmBtn.textContent = 'OK';
       break;
     }
     
     iconWrapper.innerHTML = iconHtml;
     currentConfirmBtn.className = 'py-2 px-5 text-white rounded-md focus:outline-none'; // Reset classes
     currentConfirmBtn.classList.add(...confirmBtnClasses);
     currentConfirmBtn.addEventListener('click', () => {
      messageBox.classList.add('hidden');
      resolve(true);
     }, { once: true });
     
     messageBox.classList.remove('hidden');
    });
   }
  function formatTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    let interval = seconds / 31536000;
    if (interval > 1) return `${Math.floor(interval)} ano(s) atrás`;
    interval = seconds / 2592000;
    if (interval > 1) return `${Math.floor(interval)} mês(es) atrás`;
    interval = seconds / 86400;
    if (interval > 1) return `${Math.floor(interval)} dia(s) atrás`;
    interval = seconds / 3600;
    if (interval > 1) return `${Math.floor(interval)} hora(s) atrás`;
    interval = seconds / 60;
    if (interval > 1) return `${Math.floor(interval)} minuto(s) atrás`;
    return `agora mesmo`;
   }
   
   function getDaysSinceDate(dateString) {
    if (!dateString) return null;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const targetDate = new Date(dateString + 'T00:00:00');
    if (isNaN(targetDate.getTime())) return null;
    const diffTime = today.getTime() - targetDate.getTime();
    return Math.floor(diffTime / (1000 * 60 * 60 * 24));
   }
 function showGlobalLoading() {
    document.getElementById('global-loading-modal').classList.remove('hidden');
   }
   function hideGlobalLoading() {
    document.getElementById('global-loading-modal').classList.add('hidden');
   }
// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: callBackend) ---
function callBackend(backendFunctionName, args = [], showGlobalLoader = true) {
    return new Promise((resolve, reject) => {
        if (showGlobalLoader) showGlobalLoading();

        const successHandler = (result) => {
            if (showGlobalLoader) hideGlobalLoading();
            resolve(result);
        };

        const failureHandler = (error) => {
    
            if (showGlobalLoader) hideGlobalLoading();
            console.error(`Erro na chamada ao backend (${backendFunctionName}):`, error);
            if (error.message && (error.message.includes('NetworkError') || error.message.includes('HTTP 502') || error.message.includes('Falha na conexão'))) {
                Utils.showMessageBox('Sua sessão expirou ou a conexão foi perdida. Por favor, recarregue a página para continuar.', 'warning', 'Falha na Conexão');
            } else {
 
               Utils.showMessageBox('Ocorreu um erro inesperado ao processar sua solicitação. A equipe técnica foi notificada. Por favor, tente novamente.', 'error');
            }
            reject(error);
        };
        const runner = google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler);
        switch (backendFunctionName) {
            case 'salvarNovaVerificacao':         runner.salvarNovaVerificacao(...args); break; // <-- ADIÇÃO CRUCIAL
            case 'getProcessDetails':             runner.getProcessDetails(...args); break; 
            case 'getAppConfiguration':           runner.getAppConfiguration(...args); break;
            case 'getInitialDashboardData':       runner.getInitialDashboardData(...args); break;
            case 'getDashboardPanelData':         runner.getDashboardPanelData(...args); break;
            case 'getActiveUserRegisteredInfo':   runner.getActiveUserRegisteredInfo(...args); break;
            case 'recordUserActivity':            runner.recordUserActivity(...args); break;
            case 'getRecentUserActivity':         runner.getRecentUserActivity(...args); break;
            case 'salvarLoteDeContas':            runner.salvarLoteDeContas(...args); break;
            case 'createProcessoInSheet':         runner.createProcessoInSheet(...args); break;
            case 'updateProcessoInSheet':         runner.updateProcessoInSheet(...args); break;
            case 'deleteProcessoInSheet':         runner.deleteProcessoInSheet(...args); break;
            case 'undoLastVerification':          runner.undoLastVerification(...args); break;
            case 'updateIndividualConta':         runner.updateIndividualConta(...args); break;
            case 'deleteIndividualConta':         runner.deleteIndividualConta(...args); break;
            case 'undoContasLote':                runner.undoContasLote(...args); break;
            case 'authenticateAdmin':             runner.authenticateAdmin(...args); break;
            case 'getAllUsers':                   runner.getAllUsers(...args);
            break;
            case 'toggleUserAdminStatus':         runner.toggleUserAdminStatus(...args); break;
            case 'deleteUser':                    runner.deleteUser(...args);
            break;
            case 'registerNewUser':               runner.registerNewUser(...args); break;
            case 'generateProcessReportSummary':  runner.generateProcessReportSummary(...args); break;
            default:
                console.error(`Função de backend desconhecida: ${backendFunctionName}`);
                if (showGlobalLoader) hideGlobalLoading();
                reject(new Error(`Função de backend desconhecida: ${backendFunctionName}`));
        }
    });
}
   
   function scrollToFirstInvalidField(form) {
    const invalidFields = form.querySelectorAll(':invalid:not(fieldset):not([disabled])');
    if (invalidFields.length > 0) {
     const firstInvalid = invalidFields[0];
     firstInvalid.focus();
     firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
     return true;
    }
    return false;
   }
   return {
    showToast,
    showMessageBox,
    formatTimeAgo,
    getDaysSinceDate,
    showGlobalLoading,
    hideGlobalLoading,
    callBackend,
    scrollToFirstInvalidField,
    calculateRunningBalance,
    formatAsBRL,
    parseBRL
   };
  })();
 // CÓDIGO NOVO (SUBSTITUIÇÃO)
 /**
  * Aplica a lógica dinâmica E preenche as opções de terapia/medicamento
  * em um formulário de contas (lançamento ou edição).
  * @param {HTMLFormElement} formElement - O elemento do formulário a ser configurado.
  * @param {object} appState - O objeto de estado global da aplicação.
  */
 function setupDynamicAccountFields(formElement, appState) {
  // Seleciona os elementos do formulário de forma mais genérica
  const tipoSelect = formElement.querySelector('select[id$="-contas-tipo"]');
  const tratamentoFields = formElement.querySelector('div[id$="-contas-tratamento-fields"]');
  const outrosFields = formElement.querySelector('div[id$="-contas-outros-fields"]');
  const valorAlvaraInput = formElement.querySelector('input[id$="-contas-valor-alvara"]');
  const valorContaInput = formElement.querySelector('input[id$="-contas-valor-conta"]');
  const movChoice = formElement.querySelector('select[id$="-contas-mov-processo-choice"]');
  const movInput = formElement.querySelector('input[id$="-contas-mov-processo-input"]');
  const terapiaSelect = formElement.querySelector('select[id$="-contas-terapia-select"]');
  const terapiaNomeManual = formElement.querySelector('input[id$="-contas-terapia-nome-manual"]');
  if (!tipoSelect || !movInput || !terapiaSelect) return;

  // Lógica de preenchimento da lista de terapias
  if (appState.processoSelecionado) {
   while (terapiaSelect.options.length > 2) { terapiaSelect.remove(2); }
   const terapias = (appState.processoSelecionado.terapias || []).map(t => t.nome);
   const medicamentos = (appState.processoSelecionado.medicamentos || []).map(m => m.nome);
   const allItems = [...new Set([...terapias, ...medicamentos])];
   allItems.sort().forEach(item => {
    const option = document.createElement('option');
    option.value = item; option.textContent = item;
    terapiaSelect.appendChild(option);
   });
   terapiaSelect.addEventListener('change', (e) => {
    if (e.target.value === 'OUTRO') {
     terapiaNomeManual?.classList.remove('hidden');
     terapiaNomeManual?.setAttribute('required', 'true');
    } else {
     terapiaNomeManual?.classList.add('hidden');
     terapiaNomeManual?.removeAttribute('required');
    }
   });
  }

  // Permite apenas dígitos e ponto no campo de movimento
  movInput.addEventListener('input', (e) => {
   e.target.value = e.target.value.replace(/[^\d.]/g, '');
  });
  
  // CORREÇÃO APLICADA AQUI
  const updateFieldsVisibility = () => {
   const selectedType = tipoSelect.value;
   
   // Esconde todas as seções por padrão
   if (tratamentoFields) tratamentoFields.classList.add('hidden');
   if (outrosFields) outrosFields.classList.add('hidden');
   
   // Desativa e limpa ambos os campos de valor por padrão
   if (valorAlvaraInput) { valorAlvaraInput.disabled = true; valorAlvaraInput.value = ''; }
   if (valorContaInput) { valorContaInput.disabled = true; valorContaInput.value = ''; }
   
   if (movChoice) movChoice.classList.remove('hidden');
   if (movChoice && movChoice.value === 'Digitar') {
    movInput.classList.remove('hidden');
    movInput.setAttribute('required', 'true');
   } else {
    movInput.classList.add('hidden');
    movInput.removeAttribute('required');
    movInput.value = '';
   }

   // Ativa os campos com base no tipo selecionado
   if (selectedType === 'Alvará') {
    if (valorAlvaraInput) valorAlvaraInput.disabled = false;
    if (movChoice) movChoice.classList.add('hidden');
    movInput.classList.remove('hidden');
    movInput.setAttribute('required', 'true');
   } else if (selectedType === 'Tratamento') {
    if (valorContaInput) valorContaInput.disabled = false;
    if (tratamentoFields) tratamentoFields.classList.remove('hidden');
   } else if (selectedType === 'Despesa Geral') {
    if (valorContaInput) valorContaInput.disabled = false;
    if (outrosFields) outrosFields.classList.remove('hidden');
   }
  };
  
  if(tipoSelect) tipoSelect.addEventListener('change', updateFieldsVisibility);
  if(movChoice) movChoice.addEventListener('change', updateFieldsVisibility);
  
  // Chama a função uma vez na inicialização para definir o estado inicial
  updateFieldsVisibility();
 }

// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---
 /**
  * Configura os listeners de Foco, Input e Desfoque para um campo de moeda,
  * garantindo uma experiência de digitação e edição fluida.
  * @param {HTMLInputElement} inputElement O elemento do campo de input.
  */
 function setupCurrencyInputListeners(inputElement) {
  if (!inputElement) return;

  // Enquanto o usuário ESTÁ DIGITANDO (input)
  const onInput = (event) => {
   // Mantém apenas dígitos e uma única vírgula
   let value = event.target.value.replace(/\D/g, '');
   
   // Formatação automática enquanto digita
   value = (parseInt(value, 10) / 100).toFixed(2);
   value = value.replace('.', ',');
   value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
   
   event.target.value = "R$ " + value;
  };

  // Quando o usuário SAI DO CAMPO (desfoque/blur)
  const onBlur = (event) => {
   let value = event.target.value.replace(/\D/g, '');
   if (value === '' || parseInt(value, 10) === 0) {
    event.target.value = ''; // Limpa o campo se for zero ou vazio
   } else {
    // Garante a formatação final correta
    value = (parseInt(value, 10) / 100).toFixed(2);
    value = value.replace('.', ',');
    value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
    event.target.value = "R$ " + value;
   }
  };

  // Limpa o campo para digitação quando o usuário clica
  const onFocus = (event) => {
      event.target.value = '';
  }

  // Remove os listeners antigos para evitar duplicação
  inputElement.removeEventListener('input', onInput);
  inputElement.removeEventListener('blur', onBlur);
  inputElement.removeEventListener('focus', onFocus);
  
  // Adiciona os novos listeners
  inputElement.addEventListener('input', onInput);
  inputElement.addEventListener('blur', onBlur);
  inputElement.addEventListener('focus', onFocus);
 }
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---
  /**
   * @module Modals
   * Funções para gerenciamento de modais.
   */
  const Modals = (() => {
   function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
     modal.classList.remove('hidden');
    }
   }
   function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    if (modalId === 'novo-processo-modal') {
     appState.isEditing = false;
     appState.terapiasAdicionadas = [];
     appState.medicamentosAdicionadas = [];
     appState.cirurgiasAdicionadas = [];
     appState.outrosItensAdicionados = [];
     
     const form = document.getElementById('form-novo-processo');
     if (form) {
      form.innerHTML = ''; // Limpa o conteúdo do formulário para reconstrução
     }
     DataService.trackUserActivity(
      appState.processoSelecionado ? appState.processoSelecionado.id : null,
      appState.processoSelecionado ? appState.processoSelecionado.numero : null,
      appState.processoSelecionado ? appState.processoSelecionado.paciente : '(fechou edição)'
     );
     UIService.renderActiveUsersPanel();
    } else if (modalId === 'admin-login-modal') {
     const form = document.getElementById('admin-login-form');
     if(form) form.reset();
     document.getElementById('admin-login-error')?.classList.add('hidden');
    } else if (modalId === 'report-advanced-search-modal') {
     document.getElementById('report-summary-output')?.classList.add('hidden');
     document.getElementById('advanced-search-results-output')?.classList.add('hidden');
     document.getElementById('advanced-search-pagination')?.classList.add('hidden');
     document.getElementById('advanced-search-form')?.reset();
     appState.advancedSearch.currentPage = 1;
     appState.advancedSearch.results = [];
    } else if (modalId === 'edit-conta-modal') {
     document.getElementById('form-edit-conta')?.reset();
    }
    modal.classList.add('hidden');
   }
   return { openModal, closeModal };
  })();
   /**
    * @module DataService
    * Funções para interação com o backend (Google Apps Script).
    */
   const DataService = (() => {
     // Dentro do módulo DataService (const DataService = (() => { ... })();)
 // Adicione esta nova função:
 async function fetchDashboardPanels() {
  try {
   // Chamada para a nova função do backend
   const result = await Utils.callBackend('getDashboardPanelData', [], false); // 'false' para não mostrar o loader global aqui
   appState.db.painelAtrasados = result.painelAtrasados || [];
   appState.db.painelParaAtrasar = result.painelParaAtrasar || [];
   UIService.renderStatusPanels(); // Renderiza os painéis com os novos dados
  } catch (error) {
   console.error("Erro ao buscar dados dos painéis de dashboard:", error);
   // O showMessageBox já é tratado por Utils.callBackend para erros de rede/session
   // Utils.showMessageBox('Erro ao carregar painéis de resumo.', 'error'); // Se quiser uma mensagem específica
  }
 }
 // Certifique-se de que ela está no return final do DataService:
 return { trackUserActivity, fetchAllData, checkUserStatusAndFetchData, fetchDashboardPanels }; // Adicione fetchDashboardPanels aqui
    /**
     * Registra a atividade do utilizador no backend.
     * @param {string} [processId=null] O ID do processo com o qual o utilizador interagiu.
     * @param {string} [processNumero=null] O número do processo.
     * @param {string} [processPaciente=null] O nome do paciente.
     */
    async function trackUserActivity(processId = null, processNumero = null, processPaciente = null) {
   if (!appState.currentUser.isRegistered) return;
   try {
    await google.script.run
     .withSuccessHandler(() => console.log('User activity tracked.'))
     .withFailureHandler(e => console.error('Error tracking user activity:', e))
     .recordUserActivity(appState.currentUser.email, appState.currentUser.nome, processId, processNumero, processPaciente);
   } catch (e) {
    // Erro já tratado em withFailureHandler
   }
  }

// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: fetchAllData com Cache Local) ---
 async function fetchAllData() {
  console.log('fetchAllData: Iniciando busca de dados com estratégia de cache local.');
  const loaderDiv = document.getElementById('loader');
  const welcomeMessageDiv = document.getElementById('welcome-message');
  const cacheKey = 'processos_app_cache';
  // 1. TENTA CARREGAR OS DADOS DO LOCALSTORAGE IMEDIATAMENTE
  const cachedData = localStorage.getItem(cacheKey);
  if (cachedData) {
    console.log('fetchAllData: Dados encontrados no cache local. Renderizando UI imediatamente.');
    try {
        const parsedData = JSON.parse(cachedData);
        appState.db.processos = parsedData.allProcesses || [];
        appState.db.painelAtrasados = parsedData.painelAtrasados || [];
        appState.db.painelParaAtrasar = parsedData.painelParaAtrasar || [];
        // Renderiza a UI com os dados cacheados para uma experiência instantânea
        UIService.renderOptionsPanel();
        UIService.renderStatusPanels();
        if(loaderDiv) loaderDiv.classList.add('hidden');
        if(welcomeMessageDiv) welcomeMessageDiv.classList.remove('hidden');

    } catch (e) {
        console.error("Erro ao parsear dados do cache local:", e);
        localStorage.removeItem(cacheKey); // Limpa o cache corrompido
    }
  } else {
    // Se não houver cache, mostra o spinner de carregamento
    if (loaderDiv) {
        loaderDiv.classList.remove('hidden');
        if (welcomeMessageDiv) welcomeMessageDiv.classList.add('hidden');
    }
  }
  
  // 2. BUSCA DADOS ATUALIZADOS DO BACKEND EM SEGUNDO PLANO (REVALIDATE)
  try {
   console.log('fetchAllData: Buscando dados atualizados do backend em segundo plano...');
   // A chamada ao backend não mostra o loader global para não interromper a UI
   const result = await Utils.callBackend('getInitialDashboardData', [], false);
   console.log('fetchAllData: Dados atualizados recebidos do backend.', result);

   // 3. ATUALIZA O ESTADO E O CACHE LOCAL
   appState.db.processos = result.allProcesses || [];
   appState.db.painelAtrasados = result.painelAtrasados || [];
   appState.db.painelParaAtrasar = result.painelParaAtrasar || [];
   // Salva os novos dados no localStorage para a próxima visita
   localStorage.setItem(cacheKey, JSON.stringify(result));
  } catch(error) {
   console.error("Erro CRÍTICO ao buscar dados atualizados do backend:", error);
   // Se a busca inicial falhou e não havia cache, mostra o erro.
   if (!cachedData && loaderDiv) {
        loaderDiv.innerHTML = `<p class="text-red-500">Erro ao carregar dados.<br> Por favor, recarregue a página.</p>`;
   }
   // Se a busca em segundo plano falhou, podemos opcionalmente notificar o usuário com um toast.
   Utils.showToast('Não foi possível sincronizar os dados mais recentes.', 'warning');

  } finally {
   // 4. RENDERIZA A UI FINAL COM OS DADOS MAIS RECENTES
   // Esconde o spinner de carregamento inicial, se ele estava visível
   if(loaderDiv) loaderDiv.classList.add('hidden');
   if(appState.processoSelecionado === null && welcomeMessageDiv) {
       welcomeMessageDiv.classList.remove('hidden');
   }
   // Renderiza novamente para garantir que a UI reflita os dados mais frescos
   UIService.renderOptionsPanel();
   UIService.renderStatusPanels();
  }
 }

// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---


 // CÓDIGO CORRIGIDO PARA SUBSTITUIÇÃO (2 de 2)
      /**
     * Verifica o estado do utilizador (logado, registado, admin) e decide o próximo passo (registo, UI principal).
     */

async function checkUserStatusAndFetchData() {
    console.log('checkUserStatusAndFetchData: Verificando estado do utilizador.');
    const loaderDiv = document.getElementById('loader');
    const welcomeMessageDiv = document.getElementById('welcome-message');
    loaderDiv.classList.remove('hidden');
    welcomeMessageDiv.classList.add('hidden');
    
    try {
        const userInfo = await Utils.callBackend('getActiveUserRegisteredInfo', [], true);
        console.log('checkUserStatusAndFetchData: userInfo recebido:', userInfo);
        appState.currentUser = userInfo;

        if (userInfo.isDomainUser) { // <<-- A CONDIÇÃO CHAVE: se for do domínio, carrega os dados
            let welcomeMessage = `Bem-vindo, ${userInfo.nome}!`;
            if (!userInfo.isRegistered) {
                welcomeMessage += ' (Acesso de Consulta)';
            }
            Utils.showToast(welcomeMessage, 'success');
            await fetchAllData(); // <--- CHAMADA CRÍTICA PARA O VISITANTE
            trackUserActivity();
        } else {
            document.getElementById('user-check-prompt').classList.remove('hidden');
            document.getElementById('user-check-message').textContent = `O seu e-mail (${userInfo.email || 'desconhecido'}) não está autorizado a aceder a esta aplicação.`;
        }
    } catch (error) {
        document.getElementById('user-check-prompt').classList.remove('hidden');
        document.getElementById('user-check-message').textContent = `Erro ao iniciar: ${error.message}.`;
    } finally {
        loaderDiv.classList.add('hidden');
        if (!appState.currentUser.isDomainUser) {
            welcomeMessageDiv.classList.remove('hidden');
        }
    }
    
    UIService.renderUIForUser();
}

return { trackUserActivity, fetchAllData, checkUserStatusAndFetchData };
   })();
   /**
  * @module UIService
  * Funções para renderização e manipulação da interface do usuário.
  */
 const UIService = (() => {
   
 // CÓDIGO CORRIGIDO PARA SUBSTITUIÇÃO (2 de 3)
  /**
   * Renderiza o painel de utilizadores ativos recentemente.
   */
  async function renderActiveUsersPanel() {
   const activeUsersDiv = document.getElementById('active-users-list');
   if (!activeUsersDiv) return;
   if (!appState.currentUser.isRegistered) {
    activeUsersDiv.innerHTML = '<p class="text-gray-500 text-sm">Funcionalidade disponível para usuários registrados.</p>';
    return;
   }
   // CORREÇÃO PREVENTIVA: Usando crases para o HTML
   activeUsersDiv.innerHTML = `<p class="text-gray-500 text-sm flex items-center"><div class="spinner !w-4 !h-4 !border-2 !border-l-indigo-600 mr-2"></div> Carregando...</p>`;
   try {
    const activeUsers = await Utils.callBackend('getRecentUserActivity', [], false);
    activeUsersDiv.innerHTML = '';
    if (activeUsers.length === 0) {
     activeUsersDiv.innerHTML = '<p class="text-gray-500 text-sm">Nenhum utilizador ativo recentemente.</p>';
    } else {
     activeUsers.forEach(user => {
      const lastActivityTime = new Date(user.lastActivityTimestamp);
      const timeAgo = Utils.formatTimeAgo(lastActivityTime);
      let processInfo = '';
      if (user.lastProcessNumero && user.lastProcessPaciente) {
       processInfo = ` - em <span class="font-semibold">${user.lastProcessPaciente} (${user.lastProcessNumero})</span>`;
      }
      // CORREÇÃO PREVENTIVA: Usando crases para o HTML
      activeUsersDiv.innerHTML += `
       <div class="text-xs p-1 border-b last:border-b-0">
        <span class="font-medium">${user.userName}</span> ${processInfo}
        <span class="text-gray-500">(${timeAgo})</span>
       </div>
      `;
     });
    }
   } catch (e) {
    activeUsersDiv.innerHTML = '<p class="text-red-500 text-xs">Erro ao carregar utilizadores ativos.</p>';
    console.error('Error rendering active users:', e);
   }
  }
 // CÓDIGO CORRIGIDO PARA SUBSTITUIÇÃO (2 de 3)
// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: renderStatusPanels) ---
 function renderStatusPanels() {
  console.log('renderStatusPanels: Iniciando renderização dos painéis de status a partir de dados pré-calculados.');
  const listAtrasados = document.getElementById('list-atrasados');
  const countAtrasados = document.getElementById('count-atrasados');
  const noAtrasados = document.getElementById('no-atrasados');
  const listParaAtrasar = document.getElementById('list-para-atrasar');
  const countParaAtrasar = document.getElementById('count-para-atrasar');
  const noParaAtrasar = document.getElementById('no-para-atrasar');
  listAtrasados.innerHTML = '';
  listParaAtrasar.innerHTML = '';
  const painelAtrasados = appState.db.painelAtrasados || [];
  const painelParaAtrasar = appState.db.painelParaAtrasar || [];
  
  // Renderiza Painel de Atrasados
  countAtrasados.textContent = painelAtrasados.length;
  if (painelAtrasados.length === 0) {
   noAtrasados.classList.remove('hidden');
  } else {
   noAtrasados.classList.add('hidden');
   painelAtrasados.forEach(processo => {
    const listItem = document.createElement('li');
    listItem.className = 'cursor-pointer hover:underline text-gray-900'; 
    listItem.innerHTML = `${processo.paciente} (${processo.numero}) - <span class="${processo.prazoCor}">${processo.prazoTipo}: ${processo.prazoData}</span>`;
    listItem.addEventListener('click', () => {
     const fullProcess = appState.db.processos.find(p => p.id === processo.id);
     if(fullProcess) UIService.selectProcesso(fullProcess);
    });
    listAtrasados.appendChild(listItem);
   });
  }
  
  // Renderiza Painel Para Atrasar
  countParaAtrasar.textContent = painelParaAtrasar.length;
  if (painelParaAtrasar.length === 0) {
   noParaAtrasar.classList.remove('hidden');
  } else {
   noParaAtrasar.classList.add('hidden');
   painelParaAtrasar.forEach(processo => {
    const listItem = document.createElement('li');
    listItem.className = 'cursor-pointer hover:underline text-gray-900'; 
    listItem.innerHTML = `${processo.paciente} (${processo.numero}) - <span class="${processo.prazoCor}">${processo.prazoTipo}: ${processo.prazoData}</span>`;
    listItem.addEventListener('click', () => {
     const fullProcess = appState.db.processos.find(p => p.id === processo.id);
     if(fullProcess) UIService.selectProcesso(fullProcess);
    });
    listParaAtrasar.appendChild(listItem);
   });
  }
  console.log('renderStatusPanels: Finalizado. Atrasados:', painelAtrasados.length, 'Para Atrasar:', painelParaAtrasar.length);
  
 }
  
  /**
   * Renderiza o conteúdo principal do processo selecionado, incluindo a estrutura de abas.
   */
  const renderMainContent = () => {
   console.log('renderMainContent: Renderizando conteúdo principal para processo:', appState.processoSelecionado);
   const mainContentDiv = document.getElementById('main-content');
   
   // Lógica para definir qual aba será a ativa
   const isVisitor = !appState.currentUser.isRegistered && appState.currentUser.isDomainUser;
   const verificacaoTabClass = isVisitor ? '' : 'active';
   const contasTabClass = ''; // Contas nunca é a primeira aba ativa
   const historicoTabClass = isVisitor ? 'active' : '';

   mainContentDiv.innerHTML = `
    <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md fade-in h-fit">
     <h2 class="text-xl font-bold mb-4 border-b pb-2">Resumo do Processo</h2>
     <div id="dashboard-content" class="space-y-3 text-sm"></div>
    </div>
    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md fade-in">
     <div class="border-b border-gray-200 mb-6">
      <nav class="flex space-x-6" aria-label="Tabs">
       <button class="tab-btn ${verificacaoTabClass}" data-tab="verificacao"><i class="fas fa-clipboard-check mr-2"></i>Verificação Geral</button>
       <button class="tab-btn ${contasTabClass}" data-tab="contas"><i class="fas fa-file-invoice-dollar mr-2"></i>Prestação de Contas</button>
       <button class="tab-btn ${historicoTabClass}" data-tab="historico"><i class="fas fa-history mr-2"></i>Histórico</button>
      </nav>
     </div>
     <div>
      <div id="tab-verificacao" class="tab-content ${verificacaoTabClass}"></div>
      <div id="tab-contas" class="tab-content ${contasTabClass}"></div>
      <div id="tab-historico" class="tab-content ${historicoTabClass}"></div>
     </div>
    </div>`;
   
   mainContentDiv.classList.remove('hidden');
   document.getElementById('initial-state').classList.add('hidden');
   
   document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', handleTabClick));
   
   if (appState.processoSelecionado) {
    const ultimaVerificacaoGeral = [...(appState.processoSelecionado.verificacoes || [])]
        .filter(v => !['Lançamento Contábil de Lote', 'Edição de Conta Individual', 'Exclusão de Conta Individual', 'Verificação Desfeita'].includes(v.statusProcesso))
        .sort((a,b) => new Date(b.data) - new Date(a.data))[0] || {};
    appState.currentVerificationFormData = {
     statusProcesso: ultimaVerificacaoGeral.statusProcesso || 'Não iniciado',
     diligencia: '', descricao: '', pendencias: '', prazoDiligencia: '',
     valorPrestacaoContas: '', valorBloqueio: '',
     terapias: JSON.parse(JSON.stringify(appState.processoSelecionado.terapias || [])),
     medicamentos: JSON.parse(JSON.stringify(appState.processoSelecionado.medicamentos || [])),
     cirurgias: JSON.parse(JSON.stringify(appState.processoSelecionado.cirurgias || [])),
     outrosItens: JSON.parse(JSON.stringify(appState.processoSelecionado.outrosItens || [])),
     prescricaoData: appState.processoSelecionado.ultimaprescricao || ''
    };
   }

   // Renderiza o conteúdo da aba que estiver ativa
   if (isVisitor) {
       renderHistory();
   } else {
       renderVerificationForm();
   }
   renderDashboard();
  };

// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: renderDashboard) ---
 const renderDashboard = () => {
  console.log('renderDashboard: Iniciando renderização do dashboard.');
  if (!appState.processoSelecionado) return;
  
  const dashboardContent = document.getElementById('dashboard-content');
  if (!dashboardContent) return;
  
  // CORREÇÃO: Confia na ordem natural do array, usando .pop() para pegar o último e mais recente.
  const ultimaVerificacaoGeral = [...(appState.processoSelecionado.verificacoes || [])]
    .filter(v => !['Lançamento Contábil de Lote', 'Edição de Conta Individual', 'Exclusão de Conta Individual', 'Verificação Desfeita'].includes(v.statusProcesso))
    .pop() || {};
  
  const ultimaVerificacaoAbsoluta = [...(appState.processoSelecionado.verificacoes || [])].pop() || {};
  const statusProcessoDashboard = ultimaVerificacaoGeral.statusProcesso || 'Não iniciado';
  const isFinalizedStatusDashboard = ['Arquivado', 'Desistência da Parte', 'Cumprimento Extinto'].includes(statusProcessoDashboard);
  
  let prestacaoContasHtml = '';
  if (appState.processoSelecionado.ultimaPrestacaoContasData) {
   const [ano, mes, dia] = appState.processoSelecionado.ultimaPrestacaoContasData.split('-');
   const dataFormatada = `${dia}/${mes}/${ano}`;
   prestacaoContasHtml = `<p><strong><i class="fas fa-file-invoice-dollar mr-1"></i>Último Lançamento de Contas:</strong><br>${dataFormatada}</p>`;
  }
  
  const saldoAtual = Utils.calculateRunningBalance(appState.processoSelecionado.contas);
  let saldoHtml = '';
  if (saldoAtual !== 0 || (appState.processoSelecionado.contas && appState.processoSelecionado.contas.length > 0) ) {
    let saldoClasse = saldoAtual < 0 ? 'text-red-600' : 'text-green-600';
    let saldoTexto = saldoAtual < 0 ? 'Valor a ressarcir' : 'Saldo a prestar contas';
    saldoHtml = `
   <div class="border-t pt-3 mt-3">
     <h4 class="font-bold text-md mb-1"><i class="fas fa-balance-scale-right mr-1"></i>Resumo Financeiro</h4>
     <p class="font-semibold text-lg ${saldoClasse}">
                ${Utils.formatAsBRL(Math.round(Math.abs(saldoAtual) * 100))}
     </p>
     <p class="text-sm text-gray-600">${saldoTexto}</p>
   </div>
    `;
  }
  
  let medicamentosHtml = '';
  if (appState.processoSelecionado.medicamentos && appState.processoSelecionado.medicamentos.length > 0) {
    medicamentosHtml += '<div class="border-t pt-2 mt-2"><h4 class="font-bold mb-1"><i class="fas fa-pills mr-1"></i>Medicamentos Solicitados</h4><div class="space-y-2">';
    let prescricaoGlobalAlertHtml = '';
    let hasActiveMedicines = appState.processoSelecionado.medicamentos.some(med => !med.desnecessario);
    if (isFinalizedStatusDashboard) {
   prescricaoGlobalAlertHtml = `<p class="font-bold text-sm text-gray-500"><i class="fas fa-calendar-alt mr-1"></i>Última Prescrição: N/A (Processo ${statusProcessoDashboard})</p>`;
    } else if (!hasActiveMedicines && appState.processoSelecionado.medicamentos.length > 0) {
   prescricaoGlobalAlertHtml = `<p class="font-bold text-sm text-blue-600"><i class="fas fa-calendar-alt mr-1"></i>Última Prescrição: N/A (Todos os tratamentos desnecessários)</p>`;
    } else if (appState.processoSelecionado.ultimaprescricao && appState.processoSelecionado.ultimaprescricao.includes('-')) {
   const diasPrescricao = Utils.getDaysSinceDate(appState.processoSelecionado.ultimaprescricao);
   let corPrescricao = 'text-green-600';
   let alertMessage = '';
   if (diasPrescricao !== null && diasPrescricao >= 60 && diasPrescricao < 90) {
     corPrescricao = 'text-orange-600';
     alertMessage = `<p class="text-orange-600 font-semibold mt-2 text-xs"><i class="fas fa-exclamation-triangle mr-1"></i> Necessário contato para atualizar prescrição (faltam ${90 - diasPrescricao} dias).</p>`;
   } else if (diasPrescricao !== null && diasPrescricao >= 90) {
     corPrescricao = 'text-red-600';
     alertMessage = `<p class="text-red-600 font-semibold mt-2 text-xs"><i class="fas fa-times-circle mr-1"></i> Prescrição VENCIDA!</p>`;
   }
const [ano, mes, dia] = appState.processoSelecionado.ultimaprescricao.split('-');
   prescricaoGlobalAlertHtml = `<p class="font-bold text-sm"><i class="fas fa-calendar-alt mr-1"></i>Última Prescrição: <span class="${corPrescricao}">${dia}/${mes}/${ano}</span></p>` + alertMessage;
    } else {
   prescricaoGlobalAlertHtml = `<p class="font-bold text-sm text-gray-500"><i class="fas fa-calendar-alt mr-1"></i>Última Prescrição: Não Registada</p>`;
    }
    medicamentosHtml += prescricaoGlobalAlertHtml;
    appState.processoSelecionado.medicamentos.forEach(med => {
   medicamentosHtml += `
   <div class="text-xs p-2 bg-gray-50 rounded-md">
     <strong><i class="fas fa-capsules mr-1"></i>${med.nome}</strong>
     ${med.desnecessario 
    ? '<p class="text-blue-500 font-bold mt-1"><i class="fas fa-ban mr-1"></i>Tratamento desnecessário</p>' 
    : `<div><i class="fas fa-prescription-bottle mr-1"></i>Posologia: ${med.posologia}</div>`
     }
   </div>`;
    });
    medicamentosHtml += '</div></div>';
  }

  // REFINAMENTOS DE ESTILO APLICADOS AQUI
  let terapiasHtml = '';
  if (appState.processoSelecionado.terapias && appState.processoSelecionado.terapias.length > 0) {
    terapiasHtml += '<div class="border-t pt-2 mt-2"><h4 class="font-semibold text-md mb-1"><i class="fas fa-hand-holding-medical mr-1"></i>Terapias Solicitadas</h4><div class="space-y-2">';
    appState.processoSelecionado.terapias.forEach(terapia => {
      // Nome da terapia em azul escuro
   terapiasHtml += `<div class="text-xs p-2 bg-gray-50 rounded-md"><strong><i class="fas fa-notes-medical mr-1"></i><span class="text-cyan-600">${terapia.nome}</span> (Total: ${terapia.quantidade}x)</strong>`;
   
   if (terapia.desnecessario) {
     terapiasHtml += `<p class="text-blue-500 font-bold mt-1"><i class="fas fa-ban mr-1"></i>Tratamento desnecessário</p>`;
   } else {
     let terapiaStatusMessage = '';
              let relatorioStr = 'N/A';
              if(terapia.ultimoRelatorio){
                  const [ano, mes, dia] = terapia.ultimoRelatorio.split('-');
                  relatorioStr = `${dia}/${mes}/${ano}`;
              }
     if (isFinalizedStatusDashboard) {
    terapiaStatusMessage = `<p class="text-gray-500 font-bold mt-1">N/A (Processo ${statusProcessoDashboard})</p>`;
     } else {
    const diasRelatorio = Utils.getDaysSinceDate(terapia.ultimoRelatorio);
    if (diasRelatorio !== null) {
      if (diasRelatorio >= 150 && diasRelatorio < 180) {
     const remainingDays = 180 - diasRelatorio;
     terapiaStatusMessage = `<p class="text-orange-600 font-semibold mt-1"><i class="fas fa-exclamation-triangle mr-1"></i> Necessário contacto para atualizar relatório (próximo em ${remainingDays} dias).</p>`;
      } else if (diasRelatorio >= 180) {
     terapiaStatusMessage = `<p class="text-red-600 font-semibold mt-1"><i class="fas fa-times-circle mr-1"></i> Relatório VENCIDO!</p>`;
      }
    }
     }
     const qtdAtualPrescrita = Number(terapia.qtdAtual) || Number(terapia.quantidade) || 0;
     const qtdSus = Number(terapia.qtdSus) || 0;
     const qtdPlano = Number(terapia.qtdPlano) || 0;
     const faltaCompletar = qtdAtualPrescrita - qtdSus - qtdPlano;
     const clinicaProfissionalHtml = terapia.clinicaProfissional ? `<div><i class="fas fa-clinic-medical mr-1"></i>Clínica/Profissional: <strong>${terapia.clinicaProfissional}</strong></div>` : '';
     
     terapiasHtml += `
    <div><i class="fas fa-clipboard-list mr-1"></i>Qtd Atual Prescrita: <strong class="text-orange-700">${qtdAtualPrescrita}</strong></div>
                ${clinicaProfissionalHtml}
                <div><i class="fas fa-file-medical mr-1"></i>Último relatório: <span class="font-bold text-sm text-teal-600">${isFinalizedStatusDashboard ? 'N/A' : relatorioStr}</span></div>
                <div><i class="fas fa-minus-circle mr-1"></i>Falta para completar prescrição: <strong class="text-fuchsia-600 font-bold">${faltaCompletar}</strong></div>
    ${terapiaStatusMessage}
     `;
   }
   terapiasHtml += `</div>`;
    });
    terapiasHtml += '</div></div>';
  }
  
  let cirurgiasHtml = '';
  if (appState.processoSelecionado.cirurgias && appState.processoSelecionado.cirurgias.length > 0) {
    cirurgiasHtml += '<div class="border-t pt-2 mt-2"><h4 class="font-semibold text-md mb-2"><i class="fas fa-cut mr-2"></i>Verificação de Cirurgias</h4><div class="space-y-2">';
    appState.processoSelecionado.cirurgias.forEach(cirurgia => {
   const [ano, mes, dia] = cirurgia.dataCirurgia ? cirurgia.dataCirurgia.split('-') : [null, null, null];
            const dataCirurgiaStr = dia ? `${dia}/${mes}/${ano}` : 'N/A';
   cirurgiasHtml += `
   <div class="text-xs p-2 bg-gray-50 rounded-md">
     <strong><i class="fas fa-hospital-symbol mr-1"></i>${cirurgia.nome}</strong>
     <div><i class="fas fa-calendar-day mr-1"></i>Data: ${dataCirurgiaStr}</div>
     <div><i class="fas fa-info-circle mr-1"></i>Status: ${cirurgia.status}</div>
   </div>`;
    });
    cirurgiasHtml += '</div></div>';
  }
  let outrosItensHtml = '';
  if (appState.processoSelecionado.outrosItens && appState.processoSelecionado.outrosItens.length > 0) {
    outrosItensHtml += '<div class="border-t pt-2 mt-2"><h4 class="font-semibold text-md mb-1"><i class="fas fa-microscope mr-2"></i>Outros Itens/Serviços</h4><div class="space-y-2">';
          appState.processoSelecionado.outrosItens.forEach(item => {
            outrosItensHtml += `<div class="text-xs p-2 bg-gray-50 rounded-md">
     <strong><i class="fas fa-cubes mr-1"></i>${item.nome}</strong>
              <div><i class="fas fa-file-alt mr-1"></i>Descrição: ${item.descricao}</div>
   </div>`;
    });
    outrosItensHtml += '</div></div>';
  }
  const situacaoIcon = appState.processoSelecionado.calculatedStatus?.icon || '';
  const situacaoText = appState.processoSelecionado.calculatedStatus?.text || 'N/A';
  const situacaoColor = appState.processoSelecionado.calculatedStatus?.color || 'text-gray-500';
  
  const displayStatus = statusProcessoDashboard;
  const statusIconDashboard = isFinalizedStatusDashboard ? '<i class="fas fa-archive text-gray-500 mr-2"></i>' : '';
  dashboardContent.innerHTML = `
    <div id="dashboard-info" class="space-y-3">
   <p><strong><i class="fas fa-hashtag mr-1"></i>Nº Processo:</strong><br>${appState.processoSelecionado.numero}</p>
   <p><strong><i class="fas fa-user-injured mr-1"></i>Paciente:</strong><br>${appState.processoSelecionado.paciente}</p>
   ${appState.processoSelecionado.genitor ? `<p><strong><i class="fas fa-user-friends mr-1"></i>Genitor(a):</strong><br>${appState.processoSelecionado.genitor}</p>` : ''}
   <p><strong><i class="fas fa-user-tie mr-1"></i>Juiz(a):</strong><br>${appState.processoSelecionado.juiz}</p>
   <p><strong><i class="fas fa-file-contract mr-1"></i>Tipo:</strong><br>${appState.processoSelecionado.tipo}</p>
   ${prestacaoContasHtml}
   ${saldoHtml}
   ${medicamentosHtml}
   ${terapiasHtml}
   ${cirurgiasHtml}
   ${outrosItensHtml}
   <p><strong><i class="fas fa-info-circle mr-1"></i>Status Atual:</strong><br>${statusIconDashboard}${displayStatus}</p>
   <p><strong><i class="fas fa-clipboard-check mr-1"></i>Situação da Verificação:</strong><br><span class="${situacaoColor} font-semibold">${situacaoIcon} ${situacaoText}</span></p>
   <p><strong><i class="fas fa-user-shield mr-1"></i>Última verificação por:</strong><br>${ultimaVerificacaoAbsoluta.responsavel || 'N/A'}</p>
   <p class="text-xs text-gray-400"><i class="fas fa-fingerprint mr-1"></i>ID: ${appState.processoSelecionado.id}</p>
    </div>
    <div class="flex gap-2 pt-4 mt-4 border-t">
   <button id="edit-processo-btn" class="flex-1 bg-blue-500 text-white text-xs px-3 py-2 rounded-md hover:bg-blue-600 hidden"><i class="fas fa-edit mr-2"></i>Alterar Cadastro</button>
   <button id="delete-processo-btn" class="flex-1 bg-red-500 text-white text-xs px-3 py-2 rounded-md hover:bg-red-600 hidden"><i class="fas fa-trash-alt mr-2"></i>Excluir Processo</button>
   <button id="undo-last-verification-btn" data-id="${appState.processoSelecionado.id}" class="flex-1 bg-orange-500 text-white text-xs px-3 py-2 rounded-md hover:bg-orange-600 hidden" title="Desfaz a última verificação. Não é possível desfazer o registo inicial."><i class="fas fa-undo-alt mr-2"></i>Desfazer Última Verificação</button>
    </div>
  `;
  document.getElementById('edit-processo-btn').addEventListener('click', Handlers.openEditModal );
  document.getElementById('delete-processo-btn').addEventListener('click', Handlers.handleDeleteProcess);
  document.getElementById('undo-last-verification-btn').addEventListener('click', Handlers.handleUndoLastVerification);
  
  const undoButton = document.getElementById('undo-last-verification-btn');
        const generalVerifications = (appState.processoSelecionado.verificacoes || []).filter(v => 
            !['Lançamento Contábil de Lote', 'Edição de Conta Individual', 'Exclusão de Conta Individual', 'Verificação Desfeita'].includes(v.statusProcesso)
        );
  if (generalVerifications.length <= 1) {
    undoButton.disabled = true;
    undoButton.classList.add('opacity-50', 'cursor-not-allowed');
  } else {
    undoButton.disabled = false;
    undoButton.classList.remove('opacity-50', 'cursor-not-allowed');
  }
  
  // CHAMA A FUNÇÃO DE RENDERIZAÇÃO DE UI APROPRIADA NO FINAL
  UIService.renderUIForUser();
 };
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---
  /**
   * Renderiza o histórico de verificações do processo selecionado.
   */

// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: renderHistory) ---
    const renderHistory = () => {
        console.log('renderHistory: Iniciando renderização do histórico.');
        const tabHistorico = document.getElementById('tab-historico');
        if (!tabHistorico) return;
        
        tabHistorico.innerHTML = '<div id="historico-content" class="space-y-3"></div>';
        const historicoContent = document.getElementById('historico-content');
        
        if (!appState.processoSelecionado || !historicoContent) return;
        historicoContent.innerHTML = '';
        
        if (!appState.processoSelecionado.verificacoes || appState.processoSelecionado.verificacoes.length === 0) {
            historicoContent.innerHTML = '<p class="text-gray-500 text-center">Nenhuma verificação registada.</p>';
            return;
        }
        
        // CORREÇÃO DEFINITIVA: Simplesmente inverte o array, que já está em ordem cronológica.
        const reversedVerifications = [...appState.processoSelecionado.verificacoes].reverse();

        reversedVerifications.forEach(verif => {
            // Ignora verificações que são apenas de ações contábeis para não poluir o histórico principal
            if (['Lançamento Contábil de Lote', 'Edição de Conta Individual', 'Exclusão de Conta Individual', 'Edição de Conta Antiga', 'Exclusão de Conta Antiga', 'Lote de Contas Desfeito', 'Verificação Desfeita'].includes(verif.statusProcesso)) {
                return;
            }

            const card = document.createElement('div');
            card.className = 'p-3 border rounded-md bg-gray-50 text-xs';
            
            let detalhesHtml = '';
            // Detalhes das TERAPIAS
            if (verif.terapias && verif.terapias.length > 0) {
                detalhesHtml += `
                <div class="mt-2 pt-2 border-t border-dashed border-gray-300">
                    <p class="font-bold text-gray-800">
                        <i class="fas fa-hand-holding-medical mr-1 text-green-600"></i> Detalhes das Terapias nesta Verificação:
                    </p>
                    <ul class="list-disc list-inside pl-2">`;
                verif.terapias.forEach(t => {
                    let relatorioStr = 'N/A';
                    // CORREÇÃO DE DATA APLICADA AQUI TAMBÉM
                    if (t.ultimoRelatorio && t.ultimoRelatorio.includes('-')) {
                       relatorioStr = new Date(t.ultimoRelatorio + 'T12:00:00').toLocaleDateString('pt-BR');
                    }
                    const statusTerapia = t.desnecessario ? `<span class="text-blue-600 font-semibold">Tratamento considerado desnecessário.</span>` : `Profissional/Clínica: ${t.clinicaProfissional || 'N/A'}. Último Relatório: ${relatorioStr}.`;
                    detalhesHtml += `<li><strong>${t.nome}:</strong> ${statusTerapia}</li>`;
                });
                detalhesHtml += `</ul></div>`;
            }

            // Detalhes dos MEDICAMENTOS
            if (verif.medicamentos && verif.medicamentos.length > 0) {
                 detalhesHtml += `
                <div class="mt-2 pt-2 border-t border-dashed border-gray-300">
                    <p class="font-bold text-gray-800">
                        <i class="fas fa-pills mr-1 text-purple-600"></i> Detalhes dos Medicamentos nesta Verificação:
                    </p>
                    <ul class="list-disc list-inside pl-2">`;
                verif.medicamentos.forEach(m => {
                    const statusMedicamento = m.desnecessario ? `<span class="text-blue-600 font-semibold">Tratamento considerado desnecessário.</span>` : `Posologia: ${m.posologia || 'N/A'}.`;
                    detalhesHtml += `<li><strong>${m.nome}:</strong> ${statusMedicamento}</li>`;
                });
                detalhesHtml += `</ul></div>`;
            }
            
            // Lógica para Prazos
            let prazosHtml = '';
            if (verif.prazoDiligencia) {
                // CORREÇÃO DE DATA APLICADA AQUI TAMBÉM
                const prazoDiligenciaFormatado = new Date(verif.prazoDiligencia + 'T12:00:00').toLocaleDateString('pt-BR');
                prazosHtml += `<p><strong class="text-gray-700"><i class="fas fa-calendar-check mr-1 text-emerald-600"></i> Prazo de Diligência Agendado:</strong> <span class="text-emerald-600 font-semibold">${prazoDiligenciaFormatado}</span></p>`;
            }
            
            let resumoAlteracoesHtml = '';
            if (verif.alteracoes && verif.alteracoes.trim() !== '' && verif.alteracoes.trim() !== 'Nenhuma alteração específica nos itens.') {
                resumoAlteracoesHtml = `<p class="mt-2 pt-2 border-t border-dashed"><strong class="text-gray-700">Resumo de Alterações nesta Verificação:</strong> ${verif.alteracoes}</p>`;
            }

            // Exibição do status, tratando "Alteração de Cadastro" como especial
            let statusDisplay = verif.statusProcesso;

           card.innerHTML = `
            <p class="font-bold text-sm mb-1">
                <i class="fas fa-calendar-alt mr-1 text-indigo-600"></i> ${new Date(verif.data + 'T12:00:00').toLocaleDateString('pt-BR')} - 
                <span class="font-semibold">${statusDisplay}</span>
            </p>
            <p><strong class="text-gray-700"><i class="fas fa-user-shield mr-1 text-gray-600"></i> Responsável:</strong> ${verif.responsavel || 'N/A'}</p>
            <p><strong class="text-gray-700"><i class="fas fa-tasks mr-1 text-orange-600"></i> Status da Diligência:</strong> ${verif.diligencia || 'N/A'}</p>
            <p><strong class="text-gray-700"><i class="fas fa-comment-dots mr-1 text-blue-600"></i> Diligências Realizadas:</strong> ${verif.descricao || 'N/A'}</p>
            <p><strong class="text-gray-700"><i class="fas fa-exclamation mr-1 text-red-600"></i> Pendências:</strong> <span class="text-blue-500">${verif.pendencias || 'Nenhuma'}</span></p>
            ${prazosHtml}
            <p class="mt-1"><strong class="text-gray-700"><i class="fas fa-calendar-check mr-1 text-cyan-600"></i> Verificação Geral Agendada:</strong> <span class="text-cyan-600 font-semibold">${verif.proximoPrazoPadrao ? new Date(verif.proximoPrazoPadrao + 'T12:00:00').toLocaleDateString('pt-BR') : 'N/A'}</span></p>
            ${detalhesHtml}
            ${resumoAlteracoesHtml}
            `;
            historicoContent.appendChild(card);
        });
    };
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---

  /**
   * Renderiza o formulário de nova verificação.
   */

  // --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: renderVerificationForm) ---
const renderVerificationForm = () => {
        console.log('renderVerificationForm: Iniciando renderização do formulário de verificação.');
        const container = document.getElementById('tab-verificacao');
        if (!container) return;

        // Cria as opções para os menus de forma dinâmica
        const statusProcessoOptions = (appState.config.statusDeProcesso || []).map(item => `<option value="${item}">${item}</option>`).join('');
        const diligenciasOptions = (appState.config.diligencias || []).map(item => `<option value="${item}">${item}</option>`).join('');

        container.innerHTML = `
            <form id="form-verificacao" class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-800"><i class="fas fa-plus-circle mr-2"></i>Nova Verificação Geral</h3>
                <div>
                    <label class="block text-sm font-medium"><i class="fas fa-user-shield mr-1"></i>Responsável pela diligência/Verificação</label>
                    <input type="text" id="verificacao-responsavel" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border" required readonly placeholder="Carregando nome do responsável..." autocomplete="name">
                </div>
                <div>
                    <label class="block text-sm font-medium"><i class="fas fa-info-circle mr-1"></i>Status Atual do Processo<span class="text-red-500 ml-1">*</span></label>
                    <select id="verificacao-status-processo" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white border" required>
                        <option value="" disabled selected>Selecione um status...</option>
                        ${statusProcessoOptions}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium"><i class="fas fa-tasks mr-1"></i>Diligências<span class="text-red-500 ml-1">*</span></label>
                    <select id="verificacao-diligencia" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white border" required>
                        <option value="" disabled selected>Selecione uma diligência...</option>
                        ${diligenciasOptions}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium"><i class="fas fa-comment-dots mr-1"></i>O que foi feito? (Ex: contacto com a parte, pedido de docs)<span class="text-red-500 ml-1">*</span></label>
                    <textarea id="verificacao-descricao" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border" required></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium"><i class="fas fa-exclamation mr-1"></i>Diligências Pendentes</label>
                    <textarea id="verificacao-pendencias" rows="3" class="mt-1 block w-full border-gray-300 rounded-md p-2 border"></textarea>
                </div>
                <div>
                    <label for="verificacao-prazo-diligencia" class="block text-sm font-medium"><i class="fas fa-calendar-day mr-1"></i>Prazo da Diligência (Opcional)</label>
                    <input type="date" id="verificacao-prazo-diligencia" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border" autocomplete="off">
                </div>
                <div>
                    <label for="verificacao-valor-prestacao-contas" class="block text-sm font-medium"><i class="fas fa-dollar-sign mr-1"></i>Valor da Última Prestação de Contas (Opcional)</label>
                    <input type="text" inputmode="numeric" id="verificacao-valor-prestacao-contas" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border" placeholder="R$ 0,00" autocomplete="off">
                </div>
                <div>
                    <label for="verificacao-valor-bloqueio" class="block text-sm font-medium"><i class="fas fa-lock mr-1"></i>Valor do Último Pedido de Bloqueio (Opcional)</label>
                    <input type="text" inputmode="numeric" id="verificacao-valor-bloqueio" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border" placeholder="R$ 0,00" autocomplete="off">
                </div>
                <div id="verificacao-especifica-medicamentos" class="pt-4 border-t hidden"></div>
                <div id="verificacao-especifica-terapias" class="pt-4 border-t hidden"></div>
                <div id="verificacao-especifica-cirurgias" class="pt-4 border-t hidden"></div>
                <div id="verificacao-especifica-outros" class="pt-4 border-t hidden"></div>
                <div class="text-right">
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"><i class="fas fa-save mr-2"></i>Salvar Verificação</button>
                </div>
            </form>`;
        const responsavelInput = document.getElementById('verificacao-responsavel');
        if (responsavelInput) {
            responsavelInput.value = appState.currentUser.nome;
        }
        
        const statusSelect = document.getElementById('verificacao-status-processo');
        const diligenciaSelect = document.getElementById('verificacao-diligencia');
        const descricaoInput = document.getElementById('verificacao-descricao');
        const pendenciasInput = document.getElementById('verificacao-pendencias');
        const prazoDiligenciaInput = document.getElementById('verificacao-prazo-diligencia');
        const valorPrestacaoContasInput = document.getElementById('verificacao-valor-prestacao-contas');
        const valorBloqueioInput = document.getElementById('verificacao-valor-bloqueio');

        setupCurrencyInputListeners(valorPrestacaoContasInput);
        setupCurrencyInputListeners(valorBloqueioInput);

        statusSelect.value = appState.currentVerificationFormData.statusProcesso || '';
        diligenciaSelect.value = appState.currentVerificationFormData.diligencia || '';
        descricaoInput.value = appState.currentVerificationFormData.descricao || '';
        pendenciasInput.value = appState.currentVerificationFormData.pendencias || '';
        prazoDiligenciaInput.value = appState.currentVerificationFormData.prazoDiligencia || '';
        valorPrestacaoContasInput.value = appState.currentVerificationFormData.valorPrestacaoContas || '';
        valorBloqueioInput.value = appState.currentVerificationFormData.valorBloqueio || '';
        
        statusSelect.addEventListener('change', (e) => {
            appState.currentVerificationFormData.statusProcesso = e.target.value;
            const selectedStatus = e.target.value;
            const isFinalizedStatus = ['Arquivado', 'Desistência da Parte', 'Cumprimento Extinto'].includes(selectedStatus);
            if (appState.processoSelecionado) {
                renderVerificationSpecificFields(appState.processoSelecionado, isFinalizedStatus);
            }
            toggleMainVerificationFieldsRequired(isFinalizedStatus);
        });
        diligenciaSelect.addEventListener('change', (e) => { appState.currentVerificationFormData.diligencia = e.target.value; });
        descricaoInput.addEventListener('input', (e) => { appState.currentVerificationFormData.descricao = e.target.value; });
        pendenciasInput.addEventListener('input', (e) => { appState.currentVerificationFormData.pendencias = e.target.value; });
        prazoDiligenciaInput.addEventListener('input', (e) => { appState.currentVerificationFormData.prazoDiligencia = e.target.value; });
        valorPrestacaoContasInput.addEventListener('input', (e) => { appState.currentVerificationFormData.valorPrestacaoContas = e.target.value; });
        valorBloqueioInput.addEventListener('input', (e) => { appState.currentVerificationFormData.valorBloqueio = e.target.value; });
        
        document.getElementById('form-verificacao').addEventListener('submit', Handlers.handleFormVerificacaoSubmit);
        
        const selectedStatusInitial = statusSelect.value;
        const isFinalizedStatusInitial = ['Arquivado', 'Desistência da Parte', 'Cumprimento Extinto'].includes(selectedStatusInitial);
        renderVerificationSpecificFields(appState.processoSelecionado, isFinalizedStatusInitial);
        toggleMainVerificationFieldsRequired(isFinalizedStatusInitial);
        
        // CORREÇÃO APLICADA AQUI
        UIService.renderUIForUser();
    };
    
  const renderContasForm = () => {
   const container = document.getElementById('tab-contas');
   if (!container) return;

   // Se o usuário NÃO for cadastrado (ou seja, é um visitante),
   // renderiza uma versão simplificada e encerra a função.
   if (!appState.currentUser.isRegistered) {
       container.innerHTML = `
        <div class="border-t pt-4 mt-4">
         <h3 class="text-lg font-semibold text-gray-800"><i class="fas fa-history mr-2"></i>Histórico de Lançamentos Salvos</h3>
         <p class="text-xs text-gray-500 mb-2">Estes são os lançamentos já salvos para este processo.</p>
         <div id="historico-contas-salvas" class="space-y-2 mt-4 max-h-[calc(100vh-20rem)] overflow-y-auto p-2 border rounded-md bg-gray-50"></div>
         <div class="flex justify-end gap-2 mt-4">
          <button type="button" id="export-contas-pdf-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700"><i class="fas fa-file-pdf mr-2"></i>Exportar Histórico PDF</button>
         </div>
        </div>
       `;
       document.getElementById('export-contas-pdf-btn')?.addEventListener('click', Handlers.handleExportContasPDF);
       renderHistoricoContasSalvas();
       return; // Encerra a execução aqui para o visitante
   }
   
   // O código abaixo SÓ será executado para usuários cadastrados (Editores e Admins)
   const storedDrafts = localStorage.getItem(`rascunhoContas_${appState.processoSelecionado.id}`);
   appState.contasEmRascunho = storedDrafts ? JSON.parse(storedDrafts) : [];
   let rascunhoListHtml = '';
   if (appState.contasEmRascunho.length === 0) {
    rascunhoListHtml = '<p class="text-gray-500 text-center">Nenhum registo em rascunho.</p>';
   } else {
    rascunhoListHtml = `
     <div class="space-y-2 mt-4 max-h-48 overflow-y-auto p-2 border rounded-md bg-gray-50">
      ${appState.contasEmRascunho.map(item => `
       <div class="flex justify-between items-center bg-white p-2 rounded-md shadow-sm text-sm border">
        <div>
         <p class="font-semibold">${item.detalhes.historico}</p>
         <p class="text-xs text-gray-600">
          Data: ${new Date(item.detalhes.dataMovimentacao + 'T00:00:00').toLocaleDateString('pt-BR')} |
          ${item.detalhes.valorAlvara > 0 ? `<span class="text-green-600">Crédito: R$ ${item.detalhes.valorAlvara.toFixed(2).replace('.', ',')}</span>` : ''}
          ${item.detalhes.valorConta > 0 ? `<span class="text-red-600">Débito: R$ ${item.detalhes.valorConta.toFixed(2).replace('.', ',')}</span>` : ''}
         </p>
        </div>
        <button type="button" class="text-red-500 hover:text-red-700 p-1 remove-rascunho-btn" data-id="${item.id}">
         <i class="fas fa-trash-alt"></i>
        </button>
       </div>
      `).join('')}
     </div>
     <div class="flex justify-end gap-2 mt-4">
      <button type="button" id="clear-all-contas-rascunho-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300"><i class="fas fa-eraser mr-2"></i>Limpar Rascunhos</button>
      <button type="button" id="save-all-contas-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700"><i class="fas fa-save mr-2"></i>Salvar Lançamentos</button>
     </div>
    `;
   }
   
   container.innerHTML = `
    <form id="form-contas" class="space-y-4">
     <h3 class="text-lg font-semibold text-gray-800"><i class="fas fa-plus-circle mr-2"></i>Adicionar Novo Lançamento</h3>
     <p class="text-xs text-gray-500">Preencha os campos abaixo para adicionar uma entrada (crédito) ou despesa (débito). Os lançamentos ficarão em rascunho até você salvá-los.</p>
     <div>
      <label for="contas-tipo" class="block text-sm font-medium"><i class="fas fa-tags mr-1"></i>Tipo de Registro<span class="text-red-500 ml-1">*</span></label>
      <select id="contas-tipo" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white border" required>
       <option value="" disabled selected>Selecione o tipo...</option>
       <option value="Alvará">Alvará (Crédito)</option>
       <option value="Tratamento">Tratamento/Sessões (Débito)</option>
       <option value="Despesa Geral">Despesa Geral (Débito)</option>
      </select>
     </div>
     <div>
      <label for="contas-data" class="block text-sm font-medium"><i class="fas fa-calendar-alt mr-1"></i>Data da Movimentação (NF/Alvará)<span class="text-red-500 ml-1">*</span></label>
      <input type="date" id="contas-data" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border" required>
     </div>
     <div id="contas-tratamento-fields" class="space-y-4 hidden pt-2 border-t">
      <h5 class="text-md font-semibold text-gray-700">Detalhes do Tratamento/Despesa</h5>
      <div>
       <label for="contas-terapia-select" class="block text-sm font-medium"><i class="fas fa-notes-medical mr-1"></i>Selecione a Terapia/Medicamento/Despesa<span class="text-red-500 ml-1">*</span></label>
       <select id="contas-terapia-select" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white border">
        <option value="" disabled selected>Selecione...</option>
        <option value="OUTRO">Outra (digitar manualmente)</option>
       </select>
       <input type="text" id="contas-terapia-nome-manual" placeholder="Digite o nome da terapia/despesa" class="mt-2 block w-full p-2 border-gray-300 rounded-md shadow-sm border hidden">
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div>
        <label for="contas-terapia-qtd" class="block text-sm font-medium"><i class="fas fa-sort-numeric-up-alt mr-1"></i>Quantidade (Sessões/Unidades)</label>
        <input type="number" id="contas-terapia-qtd" min="0" placeholder="Ex: 10 sessões" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border">
       </div>
       <div class="grid grid-cols-2 gap-2">
        <div>
         <label for="contas-terapia-mes" class="block text-sm font-medium">Mês Referência</label>
         <input type="number" id="contas-terapia-mes" min="1" max="12" placeholder="MM" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border">
        </div>
        <div>
         <label for="contas-terapia-ano" class="block text-sm font-medium">Ano Referência</label>
         <input type="number" id="contas-terapia-ano" min="2000" max="2100" placeholder="AAAA" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border">
        </div>
       </div>
      </div>
      <div>
       <label for="contas-observacoes" class="block text-sm font-medium"><i class="fas fa-comment-alt mr-1"></i>Observações do Lançamento (Opcional)</label>
       <textarea id="contas-observacoes" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></textarea>
      </div>
     </div>
     <div id="contas-outros-fields" class="space-y-4 hidden pt-2 border-t">
      <h5 class="text-md font-semibold text-gray-700">Detalhes da Despesa Geral</h5>
      <div>
       <label for="contas-outros-nome-manual" class="block text-sm font-medium"><i class="fas fa-file-invoice mr-1"></i>Nome da Despesa Geral<span class="text-red-500 ml-1">*</span></label>
       <input type="text" id="contas-outros-nome-manual" placeholder="Ex: Cópia de documentos, Despesa com transporte" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border">
      </div>
     </div>
     <div>
      <label for="contas-mov-processo-choice" class="block text-sm font-medium"><i class="fas fa-file-alt mr-1"></i>Mov. Processo<span class="text-red-500 ml-1">*</span></label>
      <select id="contas-mov-processo-choice" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white border">
       <option value="Anexo">Anexo</option>
       <option value="Digitar">Digitar número do movimento</option>
      </select>
      <input type="text" id="contas-mov-processo-input" placeholder="Apenas números, ex: 99 ou 99.1" class="mt-2 block w-full p-2 border-gray-300 rounded-md shadow-sm border hidden" autocomplete="off">
     </div>
     <div>
      <label for="contas-nf-alvara" class="block text-sm font-medium"><i class="fas fa-hashtag mr-1"></i>Nº NF/Alvará<span class="text-red-500 ml-1">*</span></label>
      <input type="text" id="contas-nf-alvara" placeholder="Apenas números, ex: 3018642025" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border" required>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
       <label for="contas-valor-alvara" class="block text-sm font-medium text-green-700"><i class="fas fa-arrow-down mr-1"></i>Valor do Alvará (Crédito)</label>
       <input type="text" inputmode="numeric" id="contas-valor-alvara" class="mt-1 block w-full p-2 border-green-300 rounded-md shadow-sm border" placeholder="R$ 0,00">
      </div>
      <div>
       <label for="contas-valor-conta" class="block text-sm font-medium text-red-700"><i class="fas fa-arrow-up mr-1"></i>Valor da Conta (Débito)</label>
       <input type="text" inputmode="numeric" id="contas-valor-conta" class="mt-1 block w-full p-2 border-red-300 rounded-md shadow-sm border" placeholder="R$ 0,00">
      </div>
     </div>
     <div class="text-right">
      <button type="submit" id="add-conta-rascunho-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"><i class="fas fa-plus mr-2"></i>Adicionar Lançamento</button>
     </div>
    </form>
    <div class="border-t pt-4 mt-4">
     <h3 class="text-lg font-semibold text-gray-800"><i class="fas fa-list-alt mr-2"></i>Registros em Rascunho</h3>
     ${rascunhoListHtml}
    </div>
    <div class="border-t pt-4 mt-4">
     <h3 class="text-lg font-semibold text-gray-800"><i class="fas fa-history mr-2"></i>Histórico de Lançamentos Salvos</h3>
     <p class="text-xs text-gray-500 mb-2">Estes são os lançamentos já salvos para este processo.</p>
     <div id="historico-contas-salvas" class="space-y-2 mt-4 max-h-60 overflow-y-auto p-2 border rounded-md bg-gray-50"></div>
     <div class="flex justify-end gap-2 mt-4">
      <button type="button" id="export-contas-pdf-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700"><i class="fas fa-file-pdf mr-2"></i>Exportar Histórico PDF</button>
     </div>
    </div>
   `;

   setupCurrencyInputListeners(document.getElementById('contas-valor-alvara'));
   setupCurrencyInputListeners(document.getElementById('contas-valor-conta'));
   
   document.getElementById('form-contas')?.addEventListener('submit', Handlers.handleAddContaRascunho);
   
   const form = document.getElementById('form-contas');
   const tipoSelect = form.querySelector('#contas-tipo');
   const tratamentoFields = form.querySelector('#contas-tratamento-fields');
   const outrosFields = form.querySelector('#contas-outros-fields');
   const valorAlvaraInput = form.querySelector('#contas-valor-alvara');
   const valorContaInput = form.querySelector('#contas-valor-conta');
   const movChoice = form.querySelector('#contas-mov-processo-choice');
   const movInput = form.querySelector('#contas-mov-processo-input');
   const terapiaSelect = form.querySelector('#contas-terapia-select');
   const terapiaNomeManual = form.querySelector('#contas-terapia-nome-manual');

   movInput.addEventListener('input', (e) => { e.target.value = e.target.value.replace(/[^\d.]/g, ''); });

   const updateFields = () => {
     const tipo = tipoSelect.value;
     tratamentoFields.classList.add('hidden');
     outrosFields.classList.add('hidden');
     
     if (tipo === 'Alvará') {
       valorAlvaraInput.disabled = false;
       valorContaInput.disabled = true;
        valorContaInput.value = '';
       movChoice.classList.add('hidden');
       movInput.classList.remove('hidden');
       movInput.setAttribute('required', 'true');
     } else {
       valorAlvaraInput.disabled = true;
        valorAlvaraInput.value = '';
       valorContaInput.disabled = false;
       movChoice.classList.remove('hidden');
        movInput.classList.add('hidden');
       movInput.removeAttribute('required');
     }

     if (tipo === 'Tratamento') {
       tratamentoFields.classList.remove('hidden');
     } else if (tipo === 'Despesa Geral') {
       outrosFields.classList.remove('hidden');
     }
     
     if (movChoice.value === 'Digitar' && tipo !== 'Alvará') {
        movInput.classList.remove('hidden');
        movInput.setAttribute('required', 'true');
     } else if (tipo !== 'Alvará') {
        movInput.classList.add('hidden');
        movInput.removeAttribute('required');
      }
   };

   tipoSelect.addEventListener('change', updateFields);
   movChoice.addEventListener('change', updateFields);
   updateFields(); 

   if (terapiaSelect && appState.processoSelecionado) {
    const terapias = (appState.processoSelecionado.terapias || []).map(t => t.nome);
    const medicamentos = (appState.processoSelecionado.medicamentos || []).map(m => m.nome);
    const allItems = [...new Set([...terapias, ...medicamentos])];
    allItems.sort().forEach(item => {
     const option = document.createElement('option');
     option.value = item;
     option.textContent = item;
     terapiaSelect.appendChild(option);
    });
   }
   terapiaSelect.addEventListener('change', (e) => {
    if (e.target.value === 'OUTRO') {
     terapiaNomeManual?.classList.remove('hidden');
     terapiaNomeManual?.setAttribute('required', 'true');
    } else {
     terapiaNomeManual?.classList.add('hidden');
     terapiaNomeManual?.removeAttribute('required');
    }
   });
   
   document.getElementById('save-all-contas-btn')?.addEventListener('click', Handlers.handleSaveAllContas);
   document.getElementById('clear-all-contas-rascunho-btn')?.addEventListener('click', Handlers.handleClearAllContasRascunho);
   document.getElementById('export-contas-pdf-btn')?.addEventListener('click', Handlers.handleExportContasPDF);
   container.querySelectorAll('.remove-rascunho-btn').forEach(button => { button.addEventListener('click', Handlers.handleRemoveContaRascunho); });
   
   renderHistoricoContasSalvas();
  };

 /**
   * Renderiza o histórico de lançamentos de contas já salvos no processo em formato de tabela.
   * VERSÃO FINAL: Usa verifIndex como identificador único e mostra dados brutos.
   */
// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: renderHistoricoContasSalvas) ---
// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: renderHistoricoContasSalvas) ---
 const renderHistoricoContasSalvas = () => {
  const historicoContasSalvasDiv = document.getElementById('historico-contas-salvas');
  if (!historicoContasSalvasDiv) return;
  historicoContasSalvasDiv.innerHTML = '';
  const todosOsLancamentos = appState.processoSelecionado.contas || [];
  todosOsLancamentos.sort((a, b) => new Date(a.dataMovimentacao) - new Date(b.dataMovimentacao));
  if (todosOsLancamentos.length === 0) {
   historicoContasSalvasDiv.innerHTML = '<p class="text-gray-500 text-center">Nenhum lançamento contábil salvo.</p>';
   return;
  }

  const podeEditar = appState.currentUser.isRegistered;
  const podeExcluir = appState.currentUser.isAdmin;

  let saldoParcial = 0;
  const tableRows = todosOsLancamentos.map(reg => {
   const credito = parseFloat(reg.valorAlvara) || 0;
   const debito = parseFloat(reg.valorConta) || 0;
   saldoParcial += (credito - debito);
   const dataMovFormatada = new Date(reg.dataMovimentacao + 'T00:00:00').toLocaleDateString('pt-BR');
   const dataAttributes = `data-id="${reg.id}"`;
   const saldoCorClass = saldoParcial > 0 ? 'text-green-700' : (saldoParcial < 0 ? 'text-red-700' : 'text-gray-800');
   
   return `
    <tr class="hover:bg-gray-50 text-xs">
     <td class="py-2 px-3 border-b">${dataMovFormatada}</td>
     <td class="py-2 px-3 border-b">${reg.movProcesso || '-'}</td>
     <td class="py-2 px-3 border-b">${reg.numNfAlvara || '-'}</td>
     <td class="py-2 px-3 border-b">${reg.historico || 'N/A'}</td>
     <td class="py-2 px-3 border-b text-right text-green-700 font-medium">${credito.toFixed(2).replace('.', ',')}</td>
     <td class="py-2 px-3 border-b text-right text-red-700 font-medium">${debito.toFixed(2).replace('.', ',')}</td>
     <td class="py-2 px-3 border-b text-right font-medium ${saldoCorClass}">${saldoParcial.toFixed(2).replace('.', ',')}</td>
     <td class="py-2 px-3 border-b text-center">
      <button type="button" class="bg-blue-500 text-white px-2 py-1 rounded-md text-xs hover:bg-blue-600 edit-conta-btn" ${dataAttributes} title="Editar Lançamento" ${!podeEditar ? 'disabled' : ''}>
       <i class="fas fa-edit"></i>
      </button>
      <button type="button" class="bg-red-500 text-white px-2 py-1 rounded-md text-xs hover:bg-red-600 delete-conta-btn ml-1 ${!podeExcluir ? 'hidden' : ''}" ${dataAttributes} title="Excluir Lançamento">
       <i class="fas fa-trash-alt"></i>
      </button>
     </td>
    </tr>
   `;
  }).join('');

  historicoContasSalvasDiv.innerHTML = `
   <div class="overflow-x-auto"><table class="min-w-full bg-white border border-gray-200 rounded-md shadow-sm">
    <thead>
     <tr class="bg-gray-100 text-gray-700 text-sm">
      <th class="py-2 px-3 border-b text-left">Data Mov.</th>
      <th class="py-2 px-3 border-b text-left">Mov. Processo</th>
      <th class="py-2 px-3 border-b text-left">Nº NF/Alvará</th>
      <th class="py-2 px-3 border-b text-left">Histórico/Detalhes</th>
      <th class="py-2 px-3 border-b text-right">Crédito (R$)</th>
      <th class="py-2 px-3 border-b text-right">Débito (R$)</th>
      <th class="py-2 px-3 border-b text-right">Saldo (R$)</th>
      <th class="py-2 px-3 border-b text-center">Ações</th>
     </tr>
    </thead>
    <tbody>${tableRows}</tbody>
   </table></div>
  `;

  // CORREÇÃO CRÍTICA: Adicionamos os listeners aqui, diretamente nos botões recém-criados.
  historicoContasSalvasDiv.querySelectorAll('.edit-conta-btn:not([disabled])')
   .forEach(button => button.addEventListener('click', Handlers.handleEditIndividualConta));
  historicoContasSalvasDiv.querySelectorAll('.delete-conta-btn:not([disabled])')
   .forEach(button => button.addEventListener('click', Handlers.handleDeleteIndividualConta));
 };
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---

  /**
   * Alterna o atributo 'required' e o estado visual dos campos principais do formulário de verificação.
   */
  function toggleMainVerificationFieldsRequired(isFinalizedStatus) {
   const formVerificacao = document.getElementById('form-verificacao');
   if (!formVerificacao) return;
   const fieldsToToggle = [
    'verificacao-diligencia', 'verificacao-descricao', 'verificacao-pendencias',
    'verificacao-prazo-diligencia', 'verificacao-valor-prestacao-contas', 'verificacao-valor-bloqueio'
   ];
   fieldsToToggle.forEach(fieldId => {
    const element = document.getElementById(fieldId);
    if (element) {
     if (isFinalizedStatus) {
      element.removeAttribute('required');
      element.value = '';
      element.disabled = true;
      element.classList.add('opacity-50', 'cursor-not-allowed');
     } else {
      element.disabled = false;
      element.classList.remove('opacity-50', 'cursor-not-allowed');
      if (fieldId === 'verificacao-diligencia' || fieldId === 'verificacao-descricao') {
       element.setAttribute('required', 'true');
      } else {
       element.removeAttribute('required');
      }
      const key = fieldId.replace('verificacao-', '');
      if (appState.currentVerificationFormData[key] !== undefined) {
       element.value = appState.currentVerificationFormData[key];
      }
     }
    }
   });
  }
  /**
   * Renderiza seções de lista dinâmicas (terapias, medicamentos, cirurgias, outros).
   */
  const renderDynamicList = (listId, dataArray, renderFn, itemClass) => {
   const listElement = document.getElementById(listId);
   if (!listElement) return;
   listElement.innerHTML = '';
   dataArray.forEach((item, index) => {
    const div = document.createElement('div');
    div.className = `${itemClass} p-2 bg-gray-100 rounded-md`;
    div.innerHTML = renderFn(item, index);
    listElement.appendChild(div);
   });
  };
  /**
   * Lida com cliques em abas (Fazer Verificação, Histórico).
   */
  const handleTabClick = (e) => {
   if (!e.target || !(e.target instanceof HTMLElement)) return;
   const clickedTabBtn = e.target.closest('.tab-btn');
   if (!clickedTabBtn || !clickedTabBtn.dataset.tab) return;
   document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
   clickedTabBtn.classList.add('active');
   document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
   const tabId = `tab-${clickedTabBtn.dataset.tab}`;
   const targetTabContent = document.getElementById(tabId);
   if (targetTabContent) {
    targetTabContent.classList.add('active');
   }
   if (clickedTabBtn.dataset.tab === 'contas') {
    renderContasForm();
   } else if (clickedTabBtn.dataset.tab === 'historico') {
    renderHistory();
   } else if (clickedTabBtn.dataset.tab === 'verificacao') {
    renderVerificationForm();
    if (appState.processoSelecionado) {
     const statusAtualNoFormulario = appState.currentVerificationFormData.statusProcesso;
     const isFinalizedStatus = ['Arquivado', 'Desistência da Parte', 'Cumprimento Extinto'].includes(statusAtualNoFormulario);
     renderVerificationSpecificFields(appState.processoSelecionado, isFinalizedStatus);
     toggleMainVerificationFieldsRequired(isFinalizedStatus);
    }
   }
  };
  /**
   * Lida com a entrada de texto no campo de pesquisa.
   */
  const handleSearchInput = () => {
   const searchTerm = document.getElementById('search-select-input').value.trim();
   if (searchTerm === '') {
    appState.processoSelecionado = null;
    document.getElementById('main-content').classList.add('hidden');
    document.getElementById('initial-state').classList.remove('hidden');
    document.getElementById('welcome-message').classList.remove('hidden');
   }
   renderOptionsPanel(searchTerm);
   document.getElementById('options-panel').classList.remove('hidden');
  };
  /**
   * Lida com o foco no campo de pesquisa.
   */
  const handleSearchFocus = () => {
   renderOptionsPanel('');
   document.getElementById('options-panel').classList.remove('hidden');
  };

/**
* Seleciona um processo e atualiza a interface.
*/
const selectProcesso = async (proc) => {
    console.log('selectProcesso: Selecionado processo leve:', proc);
    // Se o processo já tiver os detalhes (ex: vindo de um save), não busca de novo
    if (proc && proc.verificacoes !== undefined) {
        _updateUIWithNewData(proc);
        return;
    }

    // MOSTRA O MODAL DE CARREGAMENTO GLOBAL
    Utils.showGlobalLoading();
    try {
        // A chamada ao backend agora pode ter o 'showGlobalLoader' como false,
        // pois já estamos controlando manualmente.
        const processoCompleto = await Utils.callBackend('getProcessDetails', [proc.id], false);
        _updateUIWithNewData(processoCompleto);
    } catch (error) {
        console.error("Erro ao buscar detalhes do processo:", error);
        // O callBackend já mostra um erro genérico, mas podemos ser mais específicos.
        Utils.showMessageBox(`Não foi possível carregar os detalhes do processo. ${error.message || ''}`, 'error');
    } finally {
        // ESCONDE O MODAL DE CARREGAMENTO GLOBAL, não importa se deu certo ou erro.
        Utils.hideGlobalLoading();
    }
};


function renderUIForUser() {
    const { isRegistered, isAdmin, isDomainUser } = appState.currentUser;
    console.log(`Renderizando UI para: isRegistered=${isRegistered}, isAdmin=${isAdmin}, isDomainUser=${isDomainUser}`);

    const show = (selector) => document.querySelectorAll(selector).forEach(el => el.classList.remove('hidden'));
    const hide = (selector) => document.querySelectorAll(selector).forEach(el => el.classList.add('hidden'));
    const enable = (selector) => document.querySelectorAll(selector).forEach(el => el.disabled = false);
    const disable = (selector) => document.querySelectorAll(selector).forEach(el => el.disabled = true);

    // --- Lógica para o Visitante da Instituição (isDomainUser=true, isRegistered=false) ---
    if (isDomainUser && !isRegistered) {
        hide('#atrasados-panel, #para-atrasar-panel');
        hide('#open-novo-processo-modal-btn, #open-admin-config-modal-btn');
        hide('#edit-processo-btn, #delete-processo-btn, #undo-last-verification-btn');
        hide('#form-verificacao, #form-contas');
        hide('.tab-btn[data-tab="verificacao"]'); // Esconde a aba de verificação

        show('.tab-btn[data-tab="contas"], .tab-btn[data-tab="historico"]');
        enable('#export-contas-pdf-btn');
        disable('#historico-contas-salvas .edit-conta-btn, #historico-contas-salvas .delete-conta-btn');
        return; // Termina a execução aqui para este tipo de usuário
    }

    // --- Lógica para Usuário Cadastrado (isRegistered=true) ---
    if (isRegistered) {
        show('#atrasados-panel, #para-atrasar-panel');
        show('#open-novo-processo-modal-btn');
        show('.tab-btn[data-tab="verificacao"], .tab-btn[data-tab="contas"], .tab-btn[data-tab="historico"]');
        show('#form-verificacao, #form-contas');
        enable('#export-contas-pdf-btn');
        
        // Permissões de Edição/Exclusão de Contas
        enable('#historico-contas-salvas .edit-conta-btn'); // Pode editar
        disable('#historico-contas-salvas .delete-conta-btn'); // Não pode excluir

        // Funções de Admin
        if (isAdmin) {
            show('#open-admin-config-modal-btn');
            show('#edit-processo-btn, #delete-processo-btn, #undo-last-verification-btn');
            enable('#historico-contas-salvas .delete-conta-btn'); // Admin pode excluir
        } else {
            hide('#open-admin-config-modal-btn');
            hide('#edit-processo-btn, #delete-processo-btn, #undo-last-verification-btn');
        }
        return;
    }

    // --- Lógica para Visitante Comum (isDomainUser=false, isRegistered=false) ---
    // (Se chegou até aqui, é um visitante de fora)
    // Esconde tudo relacionado a dados
    hide('#atrasados-panel, #para-atrasar-panel, #open-novo-processo-modal-btn, #open-admin-config-modal-btn, #open-report-advanced-search-modal-btn');
    hide('#main-content');
    show('#initial-state');
}

  /**
   * Retorna o HTML para o formulário de novo/editar processo.
   */

// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: getFormHtml) ---
const getFormHtml = () => {
        // Cria dinamicamente as opções para cada menu a partir do appState.config
        const tiposDeProcessoOptions = (appState.config.tiposDeProcesso || []).map(item => `<option value="${item}">${item}</option>`).join('');
        const statusInicialOptions = (appState.config.statusInicialDeProcesso || []).map(item => `<option value="${item}">${item}</option>`).join('');
        const tiposDeTerapiaOptions = (appState.config.tiposDeTerapia || []).map(item => `<option value="${item}">${item}</option>`).join('');
        const statusDeCirurgiaOptions = (appState.config.statusDeCirurgia || []).map(item => `<option value="${item}">${item}</option>`).join('');

        return `
        <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium"><i class="fas fa-hashtag mr-1"></i>Número do Processo<span class="text-red-500 ml-1">*</span></label>
                    <input type="text" id="novo-numero" maxlength="25" minlength="15" placeholder="0000000-00.0000.0.00.0000" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border" required autocomplete="off">
                </div>
                <div>
                    <label class="block text-sm font-medium"><i class="fas fa-user-tie mr-1"></i>Nome do Juiz(a)<span class="text-red-500 ml-1">*</span></label>
                    <input type="text" id="novo-juiz" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border" required autocomplete="off">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium"><i class="fas fa-user-injured mr-1"></i>Nome do Paciente<span class="text-red-500 ml-1">*</span></label>
                    <input type="text" id="novo-paciente" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border" required autocomplete="off">
                </div>
                <div>
                    <label class="block text-sm font-medium"><i class="fas fa-user-friends mr-1"></i>Nome do Genitor(a) <span class="text-xs text-gray-500">(Opcional)</span></label>
                    <input type="text" id="novo-genitor" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border" autocomplete="off">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium"><i class="fas fa-file-contract mr-1"></i>Tipo de Processo<span class="text-red-500 ml-1">*</span></label>
                <select id="novo-tipo" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white border" required>
                    <option value="" disabled selected>Selecione um tipo...</option>
                    ${tiposDeProcessoOptions}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium"><i class="fas fa-info-circle mr-1"></i>Status Inicial do Processo<span class="text-red-500 ml-1">*</span></label>
                <select id="novo-status-processo-inicial" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white border" required>
                    <option value="" disabled selected>Selecione um status...</option>
                    ${statusInicialOptions}
                </select>
            </div>
            <div id="pedidos-especificos-wrapper" class="hidden">
                <label class="block text-sm font-medium"><i class="fas fa-hand-holding-medical mr-1"></i>Adicionar Pedidos Específicos de Saúde</label>
                <select id="novo-pedido-especifico" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white border">
                    <option value="" selected>Selecione para adicionar um item...</option>
                    <option value="terapias-adicionar">Adicionar Terapia</option>
                    <option value="medicamentos-adicionar">Adicionar Medicamento</option>
                    <option value="cirurgias-adicionar">Adicionar Cirurgia</option>
                    <option value="outros-adicionar">Adicionar Outro Item/Serviço</option>
                </select>
            </div>

            <!-- SEÇÕES DE FORMULÁRIO (AGORA ESCONDIDAS POR PADRÃO) -->
            <div id="terapias-section" class="border-t pt-4 hidden">
                <h4 class="font-semibold text-md mb-2"><i class="fas fa-hand-holding-medical mr-2"></i>Adicionar Terapia</h4>
                <div class="flex items-center gap-2 mb-2">
                    <select id="terapia-select-cadastro" class="flex-grow p-2 border-gray-300 rounded-md shadow-sm bg-white border">
                        <option value="" selected disabled>Selecione uma terapia...</option>
                        ${tiposDeTerapiaOptions}
                    </select>
                    <button type="button" id="add-terapia-btn-cadastro" class="bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 text-sm flex-shrink-0"><i class="fas fa-plus mr-2"></i>Adicionar</button>
                </div>
            </div>
            <div id="medicamentos-section" class="border-t pt-4 hidden">
                <h4 class="font-semibold text-md mb-1"><i class="fas fa-pills mr-2"></i>Adicionar Medicamento</h4>
                <div id="add-medicamento-form" class="space-y-2">
                    <p class="text-xs text-gray-500">Inclua o nome da denominação comum e o nome comercial.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <input type="text" id="medicamento-nome-input-cadastro" placeholder="Nome do Medicamento" class="p-2 border-gray-300 rounded-md shadow-sm border" autocomplete="off">
                        <input type="text" id="medicamento-posologia-input-cadastro" placeholder="Posologia" class="p-2 border-gray-300 rounded-md shadow-sm border" autocomplete="off">
                    </div>
                    <!-- CAMPO DE DATA DA PRESCRIÇÃO MOVIDO PARA DENTRO DO FORMULÁRIO -->
                    <div id="ultimaprescricao-group">
                        <label for="novo-ultimaprescricao" class="block text-sm font-medium"><i class="fas fa-calendar-alt mr-1"></i>Data da Última Prescrição</label>
                        <input type="date" id="novo-ultimaprescricao" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border" autocomplete="off">
                    </div>
                    <button type="button" id="add-medicamento-btn-cadastro" class="w-full bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 text-sm"><i class="fas fa-plus mr-2"></i>Adicionar Medicamento</button>
                </div>
            </div>
            <div id="cirurgias-section" class="border-t pt-4 hidden">
                <h4 class="font-semibold text-md mb-1"><i class="fas fa-cut mr-2"></i>Adicionar Cirurgia</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-2">
                    <input type="text" id="cirurgia-nome-input-cadastro" placeholder="Nome da Cirurgia" class="p-2 border-gray-300 rounded-md shadow-sm border" autocomplete="off">
                    <input type="date" id="cirurgia-data-input-cadastro" class="p-2 border-gray-300 rounded-md shadow-sm border" autocomplete="off">
                    <select id="cirurgia-status-select-cadastro" class="p-2 border-gray-300 rounded-md shadow-sm bg-white border col-span-full">
                        <option value="" disabled selected>Status da Cirurgia...</option>
                        ${statusDeCirurgiaOptions}
                    </select>
                </div>
                <button type="button" id="add-cirurgia-btn-cadastro" class="w-full bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 text-sm"><i class="fas fa-plus mr-2"></i>Adicionar Cirurgia</button>
            </div>
            <div id="outros-section" class="border-t pt-4 hidden">
                <h4 class="font-semibold text-md mb-1"><i class="fas fa-microscope mr-2"></i>Adicionar Outro Item/Serviço</h4>
                <div class="grid grid-cols-1 gap-2 mb-2">
                    <input type="text" id="outro-nome-input-cadastro" placeholder="Nome do Item/Serviço" class="p-2 border-gray-300 rounded-md shadow-sm border" autocomplete="off">
                    <textarea id="outro-descricao-input-cadastro" rows="2" placeholder="Descrição detalhada (opcional)" class="p-2 border-gray-300 rounded-md shadow-sm border"></textarea>
                </div>
                <button type="button" id="add-outro-btn-cadastro" class="w-full bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300 text-sm"><i class="fas fa-plus mr-2"></i>Adicionar Item</button>
            </div>
            
            <div id="cadastro-itens-adicionados-list" class="space-y-4 pt-4 border-t mt-4">
                 <div id="terapias-list-section" class="hidden">
                    <h4 class="font-semibold text-md mb-2"><i class="fas fa-hand-holding-medical mr-2"></i>Terapias Solicitadas</h4>
                    <div id="terapias-list-cadastro" class="space-y-2"></div>
                 </div>
                 <div id="medicamentos-list-section" class="hidden">
                    <h4 class="font-semibold text-md mb-2"><i class="fas fa-pills mr-2"></i>Medicamentos Solicitados</h4>
                    <div id="medicamentos-list-cadastro" class="space-y-2"></div>
                 </div>
                 <div id="cirurgias-list-section" class="hidden">
                    <h4 class="font-semibold text-md mb-2"><i class="fas fa-cut mr-2"></i>Cirurgias Solicitadas</h4>
                    <div id="cirurgias-list-cadastro" class="space-y-2"></div>
                 </div>
                 <div id="outros-list-section" class="hidden">
                    <h4 class="font-semibold text-md mb-2"><i class="fas fa-microscope mr-2"></i>Outros Itens/Serviços</h4>
                    <div id="outros-list-cadastro" class="space-y-2"></div>
                 </div>
            </div>

            <div class="text-right border-t pt-4 mt-4">
                <button type="button" id="cancel-novo-processo-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 mr-2"><i class="fas fa-times mr-2"></i>Cancelar</button>
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"><i class="fas fa-save mr-2"></i>Salvar</button>
            </div>
        </div>`;
    };
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---

  /**
   * Configura os ouvintes para os campos do formulário de novo/editar processo.
   */
  const setupFormListeners = () => {
   document.getElementById('novo-numero').addEventListener('input', (e) => {
    let v = e.target.value.replace(/\D/g, '');
    v = v.substring(0, 20);
    if (v.length > 16) v = v.replace(/^(\d{7})(\d{2})(\d{4})(\d{1})(\d{2})(\d{4}).*/, '$1-$2.$3.$4.$5.$6');
    else if (v.length > 14) v = v.replace(/^(\d{7})(\d{2})(\d{4})(\d{1})(\d{2}).*/, '$1-$2.$3.$4.$5');
    else if (v.length > 13) v = v.replace(/^(\d{7})(\d{2})(\d{4})(\d{1}).*/, '$1-$2.$3.$4');
    else if (v.length > 9) v = v.replace(/^(\d{7})(\d{2})(\d{4}).*/, '$1-$2.$3');
    else if (v.length > 7) v = v.replace(/^(\d{7})(\d{2}).*/, '$1-$2');
    e.target.value = v;
   });
   document.getElementById('novo-tipo').addEventListener('change', handleTipoChange);
   document.getElementById('novo-pedido-especifico').addEventListener('change', handlePedidoEspecificoChange);
   document.getElementById('form-novo-processo').addEventListener('submit', Handlers.handleFormNovoProcessoSubmit);
   document.getElementById('add-terapia-btn-cadastro').addEventListener('click', Handlers.handleAddTerapia);
   document.getElementById('terapias-list-cadastro').addEventListener('input', Handlers.handleUpdateTerapiaQty);
   document.getElementById('terapias-list-cadastro').addEventListener('click', Handlers.handleRemoveItem);
   document.getElementById('terapias-list-cadastro').addEventListener('input', (e) => {
    const target = e.target;
    if (target.dataset.list === 'terapiasAdicionadas' && target.dataset.field === 'clinicaProfissional') {
     const index = parseInt(target.dataset.index, 10);
     if (appState.terapiasAdicionadas[index]) {
      appState.terapiasAdicionadas[index].clinicaProfissional = target.value;
     }
    }
   });
   document.getElementById('add-medicamento-btn-cadastro').addEventListener('click', Handlers.handleAddMedicamento);
   document.getElementById('medicamentos-list-cadastro').addEventListener('click', Handlers.handleRemoveItem);
   document.getElementById('add-cirurgia-btn-cadastro').addEventListener('click', Handlers.handleAddCirurgia);
   document.getElementById('cirurgias-list-cadastro').addEventListener('click', Handlers.handleRemoveItem);
   document.getElementById('add-outro-btn-cadastro').addEventListener('click', Handlers.handleAddOutro);
   document.getElementById('outros-list-cadastro').addEventListener('click', Handlers.handleRemoveItem);
   const cancelNovoProcessoBtn = document.getElementById('cancel-novo-processo-btn');
   if (cancelNovoProcessoBtn) {
    cancelNovoProcessoBtn.addEventListener('click', () => {
     Modals.closeModal('novo-processo-modal');
    });
   }
   
   handleTipoChange({ target: document.getElementById('novo-tipo') });
  };
  /**
   * Atualiza a visibilidade e o atributo 'required' do campo de última prescrição.
   */
  const updateUltimaPrescricaoGroupVisibility = () => {
   const ultimaprescricaoGroup = document.getElementById('ultimaprescricao-group');
   const ultimaprescricaoInput = document.getElementById('novo-ultimaprescricao');
   if (!ultimaprescricaoGroup || !ultimaprescricaoInput) return;
   
   const hasActiveMedicinesInForm = appState.medicamentosAdicionadas.some(med => !med.desnecessario);
   
   const hasOriginalActiveMedicines = appState.isEditing && appState.processoSelecionado &&
    appState.processoSelecionado.medicamentos &&
    appState.processoSelecionado.medicamentos.some(med => !med.desnecessario);
   if (hasActiveMedicinesInForm || hasOriginalActiveMedicines) {
    ultimaprescricaoGroup.classList.remove('hidden');
    ultimaprescricaoInput.setAttribute('required', 'true');
   } else {
    ultimaprescricaoGroup.classList.add('hidden');
    ultimaprescricaoInput.removeAttribute('required');
    ultimaprescricaoInput.value = '';
   }
  };
  /**
   * Lida com a alteração no tipo de processo para mostrar/ocultar a seção de pedidos específicos.
   */
  const handleTipoChange = (e) => {
   const pedidosWrapper = document.getElementById('pedidos-especificos-wrapper');
   const pedidosSelect = document.getElementById('novo-pedido-especifico');
   if (e.target.value === 'Saúde') {
    pedidosWrapper.classList.remove('hidden');
   } else {
    pedidosWrapper.classList.add('hidden');
    if (pedidosSelect) {
     pedidosSelect.value = '';
     handlePedidoEspecificoChange({
      target: pedidosSelect
     });
    }
   }
   updateUltimaPrescricaoGroupVisibility();
  };
  /**
   * Lida com a alteração no campo de "Pedidos Específicos" para exibir o formulário de adição correto.
   */
  const handlePedidoEspecificoChange = (e) => {
   const selectedPedido = e.target.value;

   // Esconde TODAS as seções de formulário primeiro para limpar a tela
   document.getElementById('terapias-section').classList.add('hidden');
   document.getElementById('medicamentos-section').classList.add('hidden');
   document.getElementById('cirurgias-section').classList.add('hidden');
   document.getElementById('outros-section').classList.add('hidden');
   
   // Mostra a seção correta com base na seleção do usuário
   switch (selectedPedido) {
    case 'terapias-adicionar':
     document.getElementById('terapias-section').classList.remove('hidden');
     break;
    case 'medicamentos-adicionar':
     document.getElementById('medicamentos-section').classList.remove('hidden');
     break;
    case 'cirurgias-adicionar':
     document.getElementById('cirurgias-section').classList.remove('hidden');
     break;
    case 'outros-adicionar':
     document.getElementById('outros-section').classList.remove('hidden');
     break;
   }
   
   // Reseta o valor do dropdown para que possa ser selecionado novamente
   if (e.target) e.target.value = '';
  };

  /**
   * Renderiza os campos específicos de verificação para o processo selecionado.
   */

// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: renderVerificationSpecificFields) ---
  const renderVerificationSpecificFields = (processo, isFinalizedStatus = false) => {
   const medicamentosSection = document.getElementById('verificacao-especifica-medicamentos');
   const terapiasSection = document.getElementById('verificacao-especifica-terapias');
   const cirurgiasSection = document.getElementById('verificacao-especifica-cirurgias');
   const outrosSection = document.getElementById('verificacao-especifica-outros');
   [medicamentosSection, terapiasSection, cirurgiasSection, outrosSection].forEach(section => {
    if (section) section.classList.add('hidden');
   });
   const toggleIndividualMedicamentoFields = (isDisabled, medItemOriginal, index) => {
    const posologiaInput = document.getElementById(`posologia-update-${index}`);
    const medCheckbox = document.getElementById(`medicamento-desnecessario-${index}`);
    if (posologiaInput) {
     posologiaInput.disabled = isDisabled || isFinalizedStatus;
     posologiaInput.classList.toggle('opacity-50', isDisabled || isFinalizedStatus);
     posologiaInput.classList.toggle('cursor-not-allowed', isDisabled || isFinalizedStatus);
     if (isDisabled || isFinalizedStatus) {
      posologiaInput.value = '';
     } else {
      const currentMedInFormState = appState.currentVerificationFormData.medicamentos[index];
      if (currentMedInFormState && currentMedInFormState.posologia !== undefined && currentMedInFormState.posologia !== null) {
       posologiaInput.value = currentMedInFormState.posologia;
      } else {
       posologiaInput.value = medItemOriginal.posologia || '';
      }
     }
    }
    if (medCheckbox) {
     medCheckbox.disabled = isFinalizedStatus;
     medCheckbox.classList.toggle('opacity-50', isFinalizedStatus);
     medCheckbox.classList.toggle('cursor-not-allowed', isFinalizedStatus);
    }
   };
   const toggleGlobalMedicamentoDate = () => {
    const verificacaoPrescricaoData = document.getElementById('verificacao-prescricao-data');
    if (!verificacaoPrescricaoData) return;
    
    const anyActiveMedicineInForm = appState.currentVerificationFormData.medicamentos.some(
     med => !med.desnecessario
    ) && !isFinalizedStatus;
    verificacaoPrescricaoData.disabled = !anyActiveMedicineInForm;
    verificacaoPrescricaoData.classList.toggle('opacity-50', !anyActiveMedicineInForm);
    verificacaoPrescricaoData.classList.toggle('cursor-not-allowed', !anyActiveMedicineInForm);
    if (!anyActiveMedicineInForm) {
     verificacaoPrescricaoData.removeAttribute('required');
     verificacaoPrescricaoData.value = '';
    } else {
     verificacaoPrescricaoData.setAttribute('required', 'true');
     if (appState.currentVerificationFormData.prescricaoData) {
      verificacaoPrescricaoData.value = appState.currentVerificationFormData.prescricaoData;
     } else if (processo.ultimaprescricao) {
      verificacaoPrescricaoData.value = processo.ultimaprescricao;
     }
    }
   };
   const toggleIndividualTerapiaFields = (isDisabled, terapiaItemOriginal, index, qtdAtualInput, qtdSusInput, qtdPlanoInput, ultimoRelatorioInput, fornecidaOutrosSpan, terapiaCheckbox, clinicaProfissionalInput) => {
    const shouldBeDisabledInScope = isDisabled || isFinalizedStatus;
    if (!appState.currentVerificationFormData.terapias[index]) {
     appState.currentVerificationFormData.terapias[index] = { ...terapiaItemOriginal };
    }
    const allInputs = [qtdAtualInput, qtdSusInput, qtdPlanoInput, ultimoRelatorioInput, clinicaProfissionalInput];
    allInputs.forEach(input => {
     if (!input) return;
     if (shouldBeDisabledInScope) {
      input.dataset.previousValue = input.value;
      input.value = ''; // Limpa o campo
      input.disabled = true;
      input.removeAttribute('required');
      input.classList.add('opacity-50', 'cursor-not-allowed');
      
      const fieldKey = input.dataset.field;
      if (fieldKey && appState.currentVerificationFormData.terapias[index]) {
       appState.currentVerificationFormData.terapias[index][fieldKey] = null;
      }
     } else {
      input.disabled = false;
      const valorSalvo = input.dataset.previousValue;
      const valorDoRascunho = appState.currentVerificationFormData.terapias[index]?.[input.dataset.field];
      
      input.value = valorSalvo !== undefined ? valorSalvo : (valorDoRascunho ?? '');
      
      input.classList.remove('opacity-50', 'cursor-not-allowed');
      if (input.id.includes('relatorio') || input.id.includes('qtd-atual')) {
        input.setAttribute('required', 'true');
      }
      const fieldKey = input.dataset.field;
       if (fieldKey && appState.currentVerificationFormData.terapias[index]) {
       appState.currentVerificationFormData.terapias[index][fieldKey] = input.value || null;
      }
     }
    });
    if (fornecidaOutrosSpan) {
     if (shouldBeDisabledInScope) {
      fornecidaOutrosSpan.textContent = '0';
     } else {
      const qtdAtual = parseInt(qtdAtualInput.value, 10) || 0;
      const qtdSus = parseInt(qtdSusInput.value, 10) || 0;
      const qtdPlano = parseInt(qtdPlanoInput.value, 10) || 0;
      fornecidaOutrosSpan.textContent = qtdAtual - qtdSus - qtdPlano;
     }
    }
    if (terapiaCheckbox) {
     terapiaCheckbox.disabled = isFinalizedStatus;
     terapiaCheckbox.classList.toggle('opacity-50', isFinalizedStatus);
     terapiaCheckbox.classList.toggle('cursor-not-allowed', isFinalizedStatus);
     
     if (appState.currentVerificationFormData.terapias[index]) {
      appState.currentVerificationFormData.terapias[index].desnecessario = terapiaCheckbox.checked;
     }
    }
      
    if (clinicaProfissionalInput) {
     clinicaProfissionalInput.disabled = shouldBeDisabledInScope;
     clinicaProfissionalInput.classList.toggle('opacity-50', shouldBeDisabledInScope);
     clinicaProfissionalInput.classList.toggle('cursor-not-allowed', shouldBeDisabledInScope);
     
     if (shouldBeDisabledInScope) {
      clinicaProfissionalInput.removeAttribute('required');
      clinicaProfissionalInput.value = '';
      if (appState.currentVerificationFormData.terapias[index]) {
       appState.currentVerificationFormData.terapias[index].clinicaProfissional = null;
      }
     } else {
      const valorDoRascunho = appState.currentVerificationFormData.terapias[index]?.clinicaProfissional;
      clinicaProfissionalInput.value = valorDoRascunho ?? '';
      if (appState.currentVerificationFormData.terapias[index]) {
       appState.currentVerificationFormData.terapias[index].clinicaProfissional = clinicaProfissionalInput.value || null;
      }
     }
    }
   };
   if (appState.currentVerificationFormData.medicamentos && appState.currentVerificationFormData.medicamentos.length > 0) {
    medicamentosSection.innerHTML = `
     <h4 class="font-semibold text-md mb-2"><i class="fas fa-pills mr-2"></i>Verificação de Medicamentos</h4>
     <div>
      <label for="verificacao-prescricao-data" class="block text-sm font-medium"><i class="fas fa-calendar-alt mr-1"></i>Data da última prescrição (global para medicamentos)</label>
      <input type="date" id="verificacao-prescricao-data" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border" value="${appState.currentVerificationFormData.prescricaoData || ''}" autocomplete="off">
     </div>
     <div id="medicamentos-update-list" class="space-y-2 mt-2">
        ${(appState.currentVerificationFormData.medicamentos || []).map((med, index) => {
       const currentMedInFormState = appState.currentVerificationFormData.medicamentos[index];
       const isDesnecessario = currentMedInFormState?.desnecessario ?? false;
       const currentPosologia = currentMedInFormState?.posologia ?? '';
       
       return `
        <div class="p-2 bg-gray-50 rounded-md text-xs">
         <p class="font-semibold"><i class="fas fa-capsules mr-1"></i>${med.nome}</p>
         <p><i class="fas fa-prescription-bottle mr-1"></i>Posologia Atual Cadastrada: ${med.posologia}</p>
         <div class="mb-2">
          <label class="inline-flex items-center">
           <input type="checkbox" id="medicamento-desnecessario-${index}" class="form-checkbox h-4 w-4 text-blue-600" data-item-type="medicamento" data-index="${index}" ${isDesnecessario ? 'checked' : ''} ${isFinalizedStatus ? 'disabled' : ''}>
           <span class="ml-2 text-sm text-gray-700">Tratamento desnecessário</span>
          </label>
         </div>
         <label for="posologia-update-${index}" class="block text-xs font-medium mt-1"><i class="fas fa-pen-square mr-1"></i>Nova Posologia (se houver alteração)</label>
         <input type="text" id="posologia-update-${index}" value="${isFinalizedStatus || isDesnecessario ? '' : (currentPosologia ?? '')}" placeholder="Nova posologia" class="w-full p-1 border rounded-md text-xs" data-item-type="medicamento" data-field="posologia" data-index="${index}" ${isFinalizedStatus || isDesnecessario ? 'disabled' : ''} autocomplete="off">
        </div>
       `;
      }).join('')}
     </div>
    `;
    medicamentosSection.classList.remove('hidden');
    const verificacaoPrescricaoData = document.getElementById('verificacao-prescricao-data');
    if (verificacaoPrescricaoData) {
     verificacaoPrescricaoData.addEventListener('input', (e) => {
      appState.currentVerificationFormData.prescricaoData = e.target.value;
     });
    }
    const medicamentoDesnecessarioCheckboxes = medicamentosSection.querySelectorAll('[data-item-type="medicamento"][id^="medicamento-desnecessario-"]');
    medicamentoDesnecessarioCheckboxes.forEach(checkbox => {
     const index = parseInt(checkbox.dataset.index, 10);
     const medItemOriginal = processo.medicamentos[index];
     
     checkbox.addEventListener('change', (e) => {
      const medIndex = parseInt(e.target.dataset.index, 10);
      if (!appState.currentVerificationFormData.medicamentos) {
       appState.currentVerificationFormData.medicamentos = JSON.parse(JSON.stringify(processo.medicamentos || []));
      }
      if (appState.currentVerificationFormData.medicamentos[medIndex]) {
       appState.currentVerificationFormData.medicamentos[medIndex].desnecessario = e.target.checked;
      }
      toggleIndividualMedicamentoFields(e.target.checked, medItemOriginal, medIndex);
      toggleGlobalMedicamentoDate();
     });
  
     const novaPosologiaEl = document.getElementById(`posologia-update-${index}`);
     if (novaPosologiaEl) {
      novaPosologiaEl.addEventListener('input', (e) => {
       const medIndex = parseInt(e.target.dataset.index, 10);
       if (!appState.currentVerificationFormData.medicamentos) {
        appState.currentVerificationFormData.medicamentos = JSON.parse(JSON.stringify(processo.medicamentos || []));
       }
       if (appState.currentVerificationFormData.medicamentos[medIndex]) {
        appState.currentVerificationFormData.medicamentos[medIndex].posologia = e.target.value;
       }
      });
     }
     toggleIndividualMedicamentoFields(checkbox.checked, medItemOriginal, index);
    });
    toggleGlobalMedicamentoDate();
   }
   if (appState.currentVerificationFormData.terapias && appState.currentVerificationFormData.terapias.length > 0) {
    terapiasSection.innerHTML = `
     <h4 class="font-semibold text-md mb-2"><i class="fas fa-hand-holding-medical mr-2"></i>Verificação de Terapias</h4>
     <div id="terapias-update-list" class="space-y-2 mt-2">
     ${(appState.currentVerificationFormData.terapias || []).map((terapia, index) => {
      const currentTerInFormState = appState.currentVerificationFormData.terapias[index];
      const isDesnecessaria = currentTerInFormState?.desnecessario ?? false;
      const currentQtdAtual = currentTerInFormState?.qtdAtual ?? '';
      const currentQtdSus = currentTerInFormState?.qtdSus ?? '';
      const currentQtdPlano = currentTerInFormState?.qtdPlano ?? '';
      const currentUltimoRelatorio = currentTerInFormState?.ultimoRelatorio ?? '';
      const currentClinicaProfissional = currentTerInFormState?.clinicaProfissional ?? '';
      const initialFaltaCompletar = (Number(currentQtdAtual) || 0) - (Number(currentQtdSus) || 0) - (Number(currentQtdPlano) || 0);
      return `
       <div class="p-2 bg-gray-50 rounded-md text-xs">
        <p class="font-semibold"><i class="fas fa-notes-medical mr-1"></i>${terapia.nome} (Total: ${terapia.quantidade}x)</p>
        <div class="mb-2">
         <label class="inline-flex items-center">
          <input type="checkbox" id="terapia-desnecessaria-${index}" class="form-checkbox h-4 w-4 text-blue-600" data-item-type="terapia" data-index="${index}" ${isDesnecessaria ? 'checked' : ''} ${isFinalizedStatus ? 'disabled' : ''}>
          <span class="ml-2 text-sm text-gray-700">Tratamento desnecessário</span>
         </label>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-1 items-end">
         <div>
          <label for="terapia-qtd-atual-${index}" class="block text-xs font-medium"><i class="fas fa-clipboard-list mr-1"></i>Qtd Atual Prescrita</label>
          <input type="number" id="terapia-qtd-atual-${index}" value="${isFinalizedStatus || isDesnecessaria ? '' : (currentQtdAtual || '')}" min="0" class="w-full p-1 border rounded-md" data-index="${index}" data-item-type="terapia" data-field="qtdAtual" ${isFinalizedStatus || isDesnecessaria ? 'disabled' : ''} autocomplete="off">
         </div>
         <div>
          <label for="terapia-qtd-sus-${index}" class="block text-xs font-medium"><i class="fas fa-hospital mr-1"></i>Qtd Fornecida SUS</label>
          <input type="number" id="terapia-qtd-sus-${index}" value="${isFinalizedStatus || isDesnecessaria ? '' : (currentQtdSus || '')}" min="0" class="w-full p-1 border rounded-md" data-index="${index}" data-item-type="terapia" data-field="qtdSus" ${isFinalizedStatus || isDesnecessaria ? 'disabled' : ''} autocomplete="off">
         </div>
         <div>
          <label for="terapia-qtd-plano-${index}" class="block text-xs font-medium"><i class="fas fa-hand-holding-usd mr-1"></i>Qtd Fornecida Plano</label>
          <input type="number" id="terapia-qtd-plano-${index}" value="${isFinalizedStatus || isDesnecessaria ? '' : (currentQtdPlano || '')}" min="0" class="w-full p-1 border rounded-md" data-index="${index}" data-item-type="terapia" data-field="qtdPlano" ${isFinalizedStatus || isDesnecessaria ? 'disabled' : ''} autocomplete="off">
         </div>
         <div>
          <label class="block text-xs font-medium"><i class="fas fa-minus-circle mr-1"></i>Terapia Faltante</label>
          <span id="fornecida-outros-${index}" class="block w-full text-gray-700 font-semibold text-base py-1" tabindex="-1" aria-readonly="true">
           ${isFinalizedStatus || isDesnecessaria ? '0' : initialFaltaCompletar}
          </span>
         </div>
        </div>
        <div class="mt-2">
         <label for="terapia-relatorio-${index}" class="block text-xs font-medium"><i class="fas fa-file-medical mr-1"></i>Data Último Relatório</label>
         <input type="date" id="terapia-relatorio-${index}" value="${isFinalizedStatus || isDesnecessaria ? '' : (currentUltimoRelatorio || '')}" class="w-full p-1 border rounded-md" data-item-type="terapia" data-field="ultimoRelatorio" ${isFinalizedStatus || isDesnecessaria ? 'disabled' : ''} autocomplete="off">
        </div>
        <div class="mt-2">
         <label for="terapia-clinica-profissional-${index}" class="block text-xs font-medium"><i class="fas fa-clinic-medical mr-1"></i>Clínica/Profissional</label>
         <input type="text" id="terapia-clinica-profissional-${index}" value="${isFinalizedStatus || isDesnecessaria ? '' : (currentClinicaProfissional || '')}" placeholder="Nome da clínica ou profissional" class="w-full p-1 border rounded-md" data-item-type="terapia" data-field="clinicaProfissional" data-index="${index}" ${isFinalizedStatus || isDesnecessaria ? 'disabled' : ''} autocomplete="off">
        </div>
       </div>
      `;
     }).join('')}
     </div>
    `;
    terapiasSection.classList.remove('hidden');
    const terapiaDesnecessariaCheckboxes = terapiasSection.querySelectorAll('[data-item-type="terapia"][id^="terapia-desnecessaria-"]');
    terapiaDesnecessariaCheckboxes.forEach(checkbox => {
     const index = parseInt(checkbox.dataset.index, 10);
     const terapiaItemOriginal = processo.terapias[index];
     const qtdAtualInput = document.getElementById(`terapia-qtd-atual-${index}`);
     const qtdSusInput = document.getElementById(`terapia-qtd-sus-${index}`);
     const qtdPlanoInput = document.getElementById(`terapia-qtd-plano-${index}`);
     const ultimoRelatorioInput = document.getElementById(`terapia-relatorio-${index}`);
     const fornecidaOutrosSpan = document.getElementById(`fornecida-outros-${index}`);
     const clinicaProfissionalInput = document.getElementById(`terapia-clinica-profissional-${index}`);
     
     checkbox.addEventListener('change', (e) => {
      const terIndex = parseInt(e.target.dataset.index, 10);
      if (!appState.currentVerificationFormData.terapias) {
       appState.currentVerificationFormData.terapias = JSON.parse(JSON.stringify(processo.terapias || []));
      }
      if (appState.currentVerificationFormData.terapias[terIndex]) {
       appState.currentVerificationFormData.terapias[terIndex].desnecessario = e.target.checked;
      }
      toggleIndividualTerapiaFields(e.target.checked, terapiaItemOriginal, terIndex, qtdAtualInput, qtdSusInput, qtdPlanoInput, ultimoRelatorioInput, fornecidaOutrosSpan, checkbox, clinicaProfissionalInput);
     });
     [qtdAtualInput, qtdSusInput, qtdPlanoInput, ultimoRelatorioInput, clinicaProfissionalInput].forEach(input => {
      if (input) {
       input.addEventListener('input', (e) => {
        const terIndex = parseInt(e.target.dataset.index, 10);
        const fieldName = e.target.dataset.field;
        if (fieldName && appState.currentVerificationFormData.terapias && appState.currentVerificationFormData.terapias[terIndex]) {
         appState.currentVerificationFormData.terapias[terIndex][fieldName] = e.target.value;
        }
       });
      }
     });
     toggleIndividualTerapiaFields(checkbox.checked, terapiaItemOriginal, index, qtdAtualInput, qtdSusInput, qtdPlanoInput, ultimoRelatorioInput, fornecidaOutrosSpan, checkbox, clinicaProfissionalInput);
    });
    terapiasSection.addEventListener('input', (e) => {
     const target = e.target;
     if (target.tagName === 'INPUT' && (target.type === 'number' || target.type === 'text') && target.dataset.itemType === 'terapia') {
      const index = target.dataset.index;
      const qtdAtualEl = document.getElementById(`terapia-qtd-atual-${index}`);
      const qtdSusEl = document.getElementById(`terapia-qtd-sus-${index}`);
      const qtdPlanoEl = document.getElementById(`terapia-qtd-plano-${index}`);
      const fornecidaOutrosEl = document.getElementById(`fornecida-outros-${index}`);
      if (qtdAtualEl && qtdSusEl && qtdPlanoEl && fornecidaOutrosEl) {
       const qtdAtual = parseInt(qtdAtualEl.value, 10) || 0;
       const qtdSus = parseInt(qtdSusEl.value, 10) || 0;
       const qtdPlano = parseInt(qtdPlanoEl.value, 10) || 0;
       fornecidaOutrosEl.textContent = qtdAtual - qtdSus - qtdPlano;
      }
     }
    });
   }
   
   if (appState.currentVerificationFormData.cirurgias && appState.currentVerificationFormData.cirurgias.length > 0) {
    cirurgiasSection.innerHTML = `
     <h4 class="font-semibold text-md mb-2"><i class="fas fa-cut mr-2"></i>Verificação de Cirurgias</h4>
     <div id="cirurgias-update-list" class="space-y-2 mt-2">
      ${(appState.currentVerificationFormData.cirurgias || []).map((cirurgia, index) => {
       const currentCirurgiaInFormState = appState.currentVerificationFormData.cirurgias[index];
       const currentDataCirurgia = currentCirurgiaInFormState ? currentCirurgiaInFormState.dataCirurgia : cirurgia.dataCirurgia;
       const currentStatus = currentCirurgiaInFormState ? currentCirurgiaInFormState.status : cirurgia.status;
       return `
        <div class="p-2 bg-gray-50 rounded-md text-xs">
         <p class="font-semibold"><i class="fas fa-hospital-symbol mr-1"></i>${cirurgia.nome}</p>
         <div class="grid grid-cols-2 gap-2 mt-1 items-end">
          <div>
           <label for="cirurgia-update-data-${index}" class="block text-xs font-medium"><i class="fas fa-calendar-day mr-1"></i>Data da Cirurgia</label>
           <input type="date" id="cirurgia-update-data-${index}" value="${isFinalizedStatus ? '' : (currentDataCirurgia ?? '')}" class="w-full p-1 border rounded-md" data-index="${index}" ${isFinalizedStatus ? 'disabled' : ''} required autocomplete="off">
          </div>
          <div>
           <label for="cirurgia-update-status-${index}" class="block text-xs font-medium"><i class="fas fa-info-circle mr-1"></i>Estado</label>
           <select id="cirurgia-update-status-${index}" class="w-full p-1 border rounded-md" data-index="${index}" ${isFinalizedStatus ? 'disabled' : ''} required>
            <option value="" disabled selected>Estado da Cirurgia...</option>
            <option ${currentStatus === 'Agendada' ? 'selected' : ''}>Agendada</option>
            <option ${currentStatus === 'Realizada' ? 'selected' : ''}>Realizada</option>
            <option ${currentStatus === 'Cancelada' ? 'selected' : ''}>Cancelada</option>
           </select>
          </div>
         </div>
        </div>
       `;
      }).join('')}
     </div>
    `;
    cirurgiasSection.classList.remove('hidden');
    cirurgiasSection.querySelectorAll('input, select').forEach(element => {
     const index = parseInt(element.dataset.index, 10);
     const shouldBeDisabled = isFinalizedStatus;
     if (shouldBeDisabled) {
      element.disabled = true;
      element.classList.add('opacity-50', 'cursor-not-allowed');
      element.removeAttribute('required');
      element.value = '';
     } else {
      element.disabled = false;
      element.classList.remove('opacity-50', 'cursor-not-allowed');
      element.setAttribute('required', 'true');
      const currentCirurgiaInFormState = appState.currentVerificationFormData.cirurgias[index];
      if (currentCirurgiaInFormState) {
       if (element.type === 'date') {
        element.value = currentCirurgiaInFormState.dataCirurgia || '';
       } else if (element.tagName === 'SELECT') {
        element.value = currentCirurgiaInFormState.status || '';
       }
      } else {
       const cirurgiaOriginal = processo.cirurgias[index];
       if (element.type === 'date') {
        element.value = cirurgiaOriginal.dataCirurgia || '';
       } else if (element.tagName === 'SELECT') {
        element.value = cirurgiaOriginal.status || '';
       }
      }
     }
     element.addEventListener('input', (e) => {
      if (!appState.currentVerificationFormData.cirurgias) {
       appState.currentVerificationFormData.cirurgias = JSON.parse(JSON.stringify(processo.cirurgias || []));
      }
      if (appState.currentVerificationFormData.cirurgias[index]) {
       if (e.target.type === 'date') {
        appState.currentVerificationFormData.cirurgias[index].dataCirurgia = e.target.value;
       } else if (e.target.tagName === 'SELECT') {
        appState.currentVerificationFormData.cirurgias[index].status = e.target.value;
       }
      }
     });
     if (element.tagName === 'SELECT') {
      element.addEventListener('change', (e) => {
       const index = parseInt(e.target.dataset.index, 10);
       if (!appState.currentVerificationFormData.cirurgias) {
        appState.currentVerificationFormData.cirurgias = JSON.parse(JSON.stringify(processo.cirurgias || []));
       }
       if (appState.currentVerificationFormData.cirurgias[index]) {
        appState.currentVerificationFormData.cirurgias[index].status = e.target.value;
       }
      });
     }
    });
   }
   
   if (appState.currentVerificationFormData.outrosItens && appState.currentVerificationFormData.outrosItens.length > 0) {
    outrosSection.innerHTML = `
     <h4 class="font-semibold text-md mb-2"><i class="fas fa-microscope mr-2"></i>Verificação de Outros Itens</h4>
     <div id="outros-update-list" class="space-y-2 mt-2">
      ${(appState.currentVerificationFormData.outrosItens || []).map((item, index) => {
       const currentOutroItemInFormState = appState.currentVerificationFormData.outrosItens[index];
       const currentDescricao = currentOutroItemInFormState ? currentOutroItemInFormState.descricao : item.descricao;
       return `
        <div class="p-2 bg-gray-50 rounded-md text-xs">
         <p class="font-semibold"><i class="fas fa-cubes mr-1"></i>${item.nome}</p>
         <div>
          <label for="outro-update-descricao-${index}" class="block text-xs font-medium"><i class="fas fa-file-alt mr-1"></i>Descrição</label>
          <textarea id="outro-update-descricao-${index}" rows="2" class="w-full p-1 border rounded-md" data-index="${index}" ${isFinalizedStatus ? 'disabled' : ''}>${isFinalizedStatus ? '' : (currentDescricao || '')}</textarea>
         </div>
        </div>
       `;
      }).join('')}
     </div>
    `;
    outrosSection.classList.remove('hidden');
    outrosSection.querySelectorAll('textarea').forEach(element => {
     const index = parseInt(element.dataset.index, 10);
     const shouldBeDisabled = isFinalizedStatus;
     if (shouldBeDisabled) {
      element.disabled = true;
      element.classList.add('opacity-50', 'cursor-not-allowed');
      element.removeAttribute('required');
      element.value = '';
     } else {
      element.disabled = false;
      element.classList.remove('opacity-50', 'cursor-not-allowed');
      
      const currentOutroItemInFormState = appState.currentVerificationFormData.outrosItens[index];
      if (currentOutroItemInFormState) {
       element.value = currentOutroItemInFormState.descricao || '';
      } else {
       const outroOriginal = processo.outrosItens[index];
       element.value = outroOriginal.descricao || '';
      }
     }
     element.addEventListener('input', (e) => {
      if (!appState.currentVerificationFormData.outrosItens) {
       appState.currentVerificationFormData.outrosItens = JSON.parse(JSON.stringify(processo.outrosItens || []));
      }
      if (appState.currentVerificationFormData.outrosItens[index]) {
       appState.currentVerificationFormData.outrosItens[index].descricao = e.target.value;
      }
     });
    });
   }

   // CORREÇÃO APLICADA AQUI
   UIService.renderUIForUser();
  };

/**
* Renderiza um item de terapia para o formulário de registo/edição.
*/
  const renderTerapiaItem = (terapia, index) => `
   <span><i class="fas fa-notes-medical mr-1"></i>${terapia.nome}</span>
   <div class="flex items-center gap-2">
    <label class="text-sm"><i class="fas fa-sort-numeric-up-alt mr-1"></i>Qtd:</label>
    <input type="number" value="${terapia.quantidade}" min="1" class="w-16 p-1 border rounded-md" data-list="terapiasAdicionadas" data-index="${index}" autocomplete="off">
    <label class="text-sm ml-2">Clínica/Profissional:</label>
    <input type="text" value="${terapia.clinicaProfissional || ''}" placeholder="Nome da clínica/prof." class="w-32 p-1 border rounded-md text-sm" data-list="terapiasAdicionadas" data-index="${index}" data-field="clinicaProfissional" autocomplete="off">
    <button type="button" class="text-red-500 hover:text-red-700 remove-btn" data-list="terapiasAdicionadas" data-index="${index}"><i class="fas fa-trash-alt"></i></button>
   </div>`;

/**
* Renderiza um item de medicamento para o formulário de registo/edição.
*/
  const renderMedicamentoItem = (med, index) => `
   <div class="flex-grow"><p class="font-semibold"><i class="fas fa-capsules mr-1"></i>${med.nome}</p><p class="text-xs text-gray-600"><i class="fas fa-prescription-bottle mr-1"></i>Posologia: ${med.posologia}</p></div>
   <button type="button" class="text-red-500 hover:text-red-700 remove-btn mt-2 sm:mt-0" data-list="medicamentosAdicionadas" data-index="${index}"><i class="fas fa-trash-alt"></i></button>`;

/**
* Renderiza um item de cirurgia para o formulário de registo/edição.
*/
  const renderCirurgiaItem = (cirurgia, index) => `
   <div class="flex-grow"><p class="font-semibold"><i class="fas fa-hospital-symbol mr-1"></i>${cirurgia.nome}</p><p class="text-xs text-gray-600"><i class="fas fa-calendar-day mr-1"></i>Data: ${cirurgia.dataCirurgia || 'N/A'} - <i class="fas fa-info-circle mr-1"></i>Estado: ${cirurgia.status || 'N/A'}</p></div>
   <button type="button" class="text-red-500 hover:text-red-700 remove-btn mt-2 sm:mt-0" data-list="cirurgiasAdicionadas" data-index="${index}"><i class="fas fa-trash-alt"></i></button>`;

/**
* Renderiza um item genérico para o formulário de registo/edição.
*/
  const renderOutroItem = (item, index) => `
   <div class="flex-grow"><p class="font-semibold"><i class="fas fa-cubes mr-1"></i>${item.nome}</p><p class="text-xs text-gray-600"><i class="fas fa-file-alt mr-1"></i>Descrição: ${item.descricao || 'N/A'}</p></div>
   <button type="button" class="text-red-500 hover:text-red-700 remove-btn mt-2 sm:mt-0" data-list="outrosItensAdicionadas" data-index="${index}"><i class="fas fa-trash-alt"></i></button>`;

/**
* Renderiza o modal de gestão de utilizadores.
*/
  async function renderManageUsersModal() {
   const usersListDiv = document.getElementById('users-list');
   const noUsersMessage = document.getElementById('no-users-message');
   usersListDiv.innerHTML = '<div class="text-center text-gray-500"><div class="spinner mx-auto"></div><p>Carregando utilizadores...</p></div>';
   noUsersMessage.classList.add('hidden');
   try {
    const users = await Utils.callBackend('getAllUsers', [], false);
    usersListDiv.innerHTML = '';
    if (users.length === 0) {
     noUsersMessage.classList.remove('hidden');
    } else {
     noUsersMessage.classList.add('hidden');
     users.forEach(user => {
      const userItem = document.createElement('div');
      userItem.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-white border shadow-sm rounded-lg mb-2';

      const isAdminCheckbox = `<input type="checkbox" class="form-checkbox h-5 w-5 text-indigo-600 rounded" data-user-id="${user.id}" ${user.isAdmin ? 'checked' : ''} ${user.email === appState.currentUser.email ? 'disabled' : ''}>`;
      userItem.innerHTML = `
       <div class="mb-2 sm:mb-0">
        <p class="font-semibold"><i class="fas fa-user-circle mr-1"></i>${user.nome}</p>
        <p class="text-gray-600 text-xs"><i class="fas fa-at mr-1"></i>${user.email}</p>
        <p class="text-gray-500 text-xs"><i class="fas fa-fingerprint mr-1"></i>ID: ${user.id}</p>
       </div>
       <div class="flex items-center space-x-2">
        <label class="inline-flex items-center cursor-pointer">
         ${isAdminCheckbox}
         <span class="ml-2 text-gray-700 text-xs">Administrador</span>
        </label>
        <button class="bg-red-500 text-white px-3 py-1 rounded-md text-xs hover:bg-red-600 delete-user-btn" data-user-id="${user.id}" ${user.email === appState.currentUser.email ? 'disabled' : ''}><i class="fas fa-trash-alt mr-1"></i>Excluir</button>
       </div>
      `;
      usersListDiv.appendChild(userItem);
     });
     usersListDiv.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
      checkbox.addEventListener('change', async (e) => {
       const userId = e.target.dataset.userId;
       const newStatus = e.target.checked;
       if (userId === appState.currentUser.id) {
        Utils.showMessageBox('Você não pode remover o seu próprio estado de administrador.', 'warning');
        e.target.checked = true;
        return;
       }
       try {
        const user = users.find(u => u.id === userId);
        await Utils.callBackend('toggleUserAdminStatus', [userId, newStatus], true);
        Utils.showMessageBox(`Estado de admin de ${user.nome} alterado para ${newStatus ? 'Administrador' : 'Utilizador Padrão'}.`, 'success');
        renderManageUsersModal();
        DataService.trackUserActivity(null, null, `Alterou estado de admin de ${user.nome}`);
        renderActiveUsersPanel();
       } catch (error) {
        e.target.checked = !newStatus;
        console.error("Erro ao alternar estado de admin:", error);
       }
      });
     });
     usersListDiv.querySelectorAll('.delete-user-btn').forEach(button => {
      button.addEventListener('click', async (e) => {
       const userId = e.target.dataset.userId;
       if (userId === appState.currentUser.id) {
        Utils.showMessageBox('Você não pode excluir o seu próprio utilizador logado.', 'warning');
        return;
       }
       const userToDelete = users.find(u => u.id === userId);
       const confirmDelete = await Utils.showMessageBox(`Tem certeza que deseja excluir o utilizador "${userToDelete.nome}" (${userToDelete.id})? Esta ação não pode ser desfeita.`, 'confirm', 'Confirmar Exclusão de Utilizador');
       if (confirmDelete) {
        try {
         await Utils.callBackend('deleteUser', [userId], true);
         Utils.showMessageBox(`Utilizador ${userToDelete.nome} excluído.`, 'success');
         renderManageUsersModal();
         DataService.trackUserActivity(null, null, `Excluiu o utilizador ${userToDelete.nome}`);
         renderActiveUsersPanel();
        } catch (error) {
         console.error("Erro ao excluir utilizador:", error);
        }
       }
      });
     });
    }
   } catch (error) {
    usersListDiv.innerHTML = `<p class="text-red-500 text-center">Erro ao carregar utilizadores: ${error.message}</p>`;
    console.error("Erro ao carregar utilizadores no modal de gestão:", error);
   }
  }

/**
* Renderiza a página atual dos resultados da busca avançada.
*/
  function renderAdvancedSearchResultsPage() {
   const outputDiv = document.getElementById('advanced-search-results-output');
   const paginationDiv = document.getElementById('advanced-search-pagination');
   const pageInfoSpan = document.getElementById('adv-page-info');
   const prevBtn = document.getElementById('adv-prev-page');
   const nextBtn = document.getElementById('adv-next-page');
   outputDiv.innerHTML = '';
   const totalPages = Math.ceil(appState.advancedSearch.results.length / appState.advancedSearch.itemsPerPage);
   const startIndex = (appState.advancedSearch.currentPage - 1) * appState.advancedSearch.itemsPerPage;
   const endIndex = startIndex + appState.advancedSearch.itemsPerPage;
   const currentResults = appState.advancedSearch.results.slice(startIndex, endIndex);
   if (currentResults.length === 0) {
    outputDiv.innerHTML = '<p class="text-gray-500 text-center">Nenhum processo encontrado com os filtros aplicados.</p>';
    paginationDiv.classList.add('hidden');
    return;
   }
   let tableHtml = `<div class="overflow-x-auto"><table class="min-w-full bg-white border border-gray-200 rounded-md"><thead><tr>`;
   const displayColumns = Object.keys(appState.advancedSearch.visibleColumns).filter(col => appState.advancedSearch.visibleColumns[col]);
   const columnLabels = { 'id': 'ID', 'numero': 'Número', 'paciente': 'Paciente', 'genitor': 'Genitor', 'juiz': 'Juiz', 'tipo': 'Tipo', 'ultimaprescricao': 'Última Prescrição', 'statusProcesso': 'Estado Atual', 'verificacoes': 'Verificações', 'terapias': 'Terapias', 'medicamentos': 'Medicamentos', 'cirurgias': 'Cirurgias', 'outrosItens': 'Outros Itens' };
   tableHtml += `<tr>`;
   displayColumns.forEach(colKey => {
    tableHtml += `<th class="py-2 px-4 border-b text-left">${columnLabels[colKey] || colKey}</th>`;
   });
   tableHtml += `</tr></thead><tbody>`;
   currentResults.forEach(proc => {
    tableHtml += `<tr class="hover:bg-gray-50 cursor-pointer" data-id="${proc.id}">`;
    displayColumns.forEach(colKey => {
     let cellContent = '';
     if (colKey === 'statusProcesso') {
      const ultimaVerificacao = [...(proc.verificacoes || [])].pop() || {};
      cellContent = ultimaVerificacao.statusProcesso || 'N/A';
     } else if (colKey === 'ultimaprescricao') {
      cellContent = proc.ultimaprescricao ? new Date(proc.ultimaprescricao + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';
     } else if (['terapias', 'medicamentos', 'cirurgias', 'outrosItens'].includes(colKey)) {
      if (Array.isArray(proc[colKey]) && proc[colKey].length > 0) {
       cellContent = proc[colKey].map(item => item.nome).join(', ');
      } else {
       cellContent = 'N/A';
      }
     } else {
      cellContent = proc[colKey] || 'N/A';
     }
     tableHtml += `<td class="py-2 px-4 border-b">${cellContent}</td>`;
    });
    tableHtml += `</tr>`;
   });
   tableHtml += `</tbody></table></div>`;
   outputDiv.innerHTML = tableHtml;
   outputDiv.querySelectorAll('tbody tr').forEach(row => {
    row.addEventListener('click', (e) => {
     const procId = e.currentTarget.dataset.id;
     const selectedProc = appState.advancedSearch.results.find(p => p.id === procId);
     if (selectedProc) {
      selectProcesso(selectedProc);
      Modals.closeModal('report-advanced-search-modal');
     }
    });
   });
   pageInfoSpan.textContent = `Página ${appState.advancedSearch.currentPage} de ${totalPages || 1}`;
   prevBtn.disabled = appState.advancedSearch.currentPage === 1;
   nextBtn.disabled = appState.advancedSearch.currentPage === totalPages || totalPages === 0;
   paginationDiv.classList.remove('hidden');
  }

/**
* Renderiza as opções de processo no painel de pesquisa.
*/
async function renderOptionsPanel(searchTerm = '', filters = {}) {
   const panel = document.getElementById('options-panel');
   if (!panel) return;

   if (!appState.currentUser.isDomainUser) { // Correto: verifica se é do domínio
    panel.innerHTML = '<p class="p-2 text-gray-500">Acesso negado.</p>';
    return;
   }

   let processesToDisplay = appState.db.processos || [];

   // LÓGICA DE FILTRO CORRIGIDA
   if (searchTerm && searchTerm.trim().length >= 3) {
    const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();
    processesToDisplay = processesToDisplay.filter(p =>
     String(p.numero || '').toLowerCase().includes(lowerCaseSearchTerm) ||
     String(p.paciente || '').toLowerCase().includes(lowerCaseSearchTerm) ||
     String(p.genitor || '').toLowerCase().includes(lowerCaseSearchTerm)
    );
   }
   // Se o termo de busca for menor que 3 caracteres, a lista completa será usada.

   panel.innerHTML = '';
   if (processesToDisplay.length === 0) {
    panel.innerHTML = '<p class="p-2 text-gray-500">Nenhum processo encontrado.</p>';
    return;
   }

   processesToDisplay.forEach(proc => {
    const div = document.createElement('div');
    div.className = 'p-2 hover:bg-gray-100 cursor-pointer text-sm border-b last:border-b-0';
    
    // A lógica de exibição do status para a lista
    const statusText = proc.calculatedStatus?.text || 'Não iniciado';
    let displayStatus = statusText;
    if (statusText.includes('Vence em')) {
        displayStatus = 'Para Vencer';
    } else if (statusText === 'Não iniciado / Prazo Indefinido') {
        displayStatus = 'Não iniciado';
    }
    
    const isFinalizedStatus = ['Arquivado', 'Desistência da Parte', 'Cumprimento Extinto'].includes(statusText);
    const icon = isFinalizedStatus ? '<i class="fas fa-archive text-gray-500 mr-2"></i>' : '';
    
    div.innerHTML = `${icon}<strong>${proc.paciente}</strong> (${proc.numero}) - Status: ${displayStatus}`;
    div.dataset.id = proc.id;
    div.addEventListener('click', () => {
     // Aqui usamos 'proc' diretamente, pois 'processesToDisplay' é um subconjunto
     // de 'appState.db.processos', que já tem os dados leves.
     UIService.selectProcesso(proc);
     const reportModal = document.getElementById('report-advanced-search-modal');
     if (reportModal && !reportModal.classList.contains('hidden')) {
      Modals.closeModal('report-advanced-search-modal');
     }
     panel.classList.add('hidden'); // Esconde o painel após a seleção
    });
    panel.appendChild(div);
   });
  }

// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: _updateUIWithNewData) ---
// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: _updateUIWithNewData) ---
function _updateUIWithNewData(processoCompleto) {
    console.log('Atualizando UI com dados completos:', processoCompleto);
    
    appState.processoSelecionado = processoCompleto;

    // Atualiza a entrada para este processo na lista leve
    const procIndex = appState.db.processos.findIndex(p => p.id === processoCompleto.id);
    if (procIndex !== -1) {
        // Atualiza a lista leve com o objeto que já tem o status calculado
        appState.db.processos[procIndex] = {
            id: processoCompleto.id,
            numero: processoCompleto.numero,
            paciente: processoCompleto.paciente,
            genitor: processoCompleto.genitor,
            juiz: processoCompleto.juiz,
            tipo: processoCompleto.tipo,
            calculatedStatus: processoCompleto.calculatedStatus
        };
    } else {
        // Se o processo for novo, adiciona à lista
        appState.db.processos.push({
            id: processoCompleto.id,
            numero: processoCompleto.numero,
            paciente: processoCompleto.paciente,
            genitor: processoCompleto.genitor,
            juiz: processoCompleto.juiz,
            tipo: processoCompleto.tipo,
            calculatedStatus: processoCompleto.calculatedStatus
        });
    }

    // *** A CORREÇÃO MÁGICA ESTÁ AQUI ***
    // 1. RECONSTRÓI os arrays dos painéis usando a lista de processos atualizada.
    const { painelAtrasados, painelParaAtrasar } = Handlers._buildDashboardPanelsFromState(appState.db.processos);
    
    // 2. ATUALIZA o estado global com os novos painéis.
    appState.db.painelAtrasados = painelAtrasados;
    appState.db.painelParaAtrasar = painelParaAtrasar;
    
    // 3. RENDERIZA os painéis com os dados recém-calculados.
    UIService.renderStatusPanels();

    // Renderiza o resto da UI principal
    document.getElementById('search-select-input').value = `${processoCompleto.paciente} (${processoCompleto.numero})`;
    UIService.renderMainContent();
    UIService.renderUIForUser();

    // Funções que podem rodar em segundo plano
    DataService.trackUserActivity(processoCompleto.id, processoCompleto.numero, processoCompleto.paciente);
    UIService.renderActiveUsersPanel();
}
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---

return {
    renderActiveUsersPanel,
    renderStatusPanels,
    renderMainContent,
    renderDashboard,
    renderHistory,
    renderVerificationForm,
    renderContasForm,
    renderHistoricoContasSalvas,
    toggleMainVerificationFieldsRequired,
    renderDynamicList,
    renderVerificationSpecificFields,
    renderTerapiaItem,
    renderMedicamentoItem,
    renderCirurgiaItem,
    renderOutroItem,
    selectProcesso,
    //updateUIBasedOnUserStatus,
    getFormHtml,
    setupFormListeners,
    updateUltimaPrescricaoGroupVisibility,
    handleTipoChange,
    handlePedidoEspecificoChange,
    renderManageUsersModal,
    renderAdvancedSearchResultsPage,
    handleSearchInput, // <-- ADICIONADO AQUI
    handleSearchFocus, // <-- ADICIONADO AQUI
    renderOptionsPanel,
    renderUIForUser // <-- ADICIONE ESTA LINHA

};
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---


})();
 // CÓDIGO CORRIGIDO PARA SUBSTITUIÇÃO (MÓDULO Handlers COMPLETO)
 /**
  * @module Handlers
  * Funções para lidar com eventos e lógica de negócios.
  */
 const Handlers = (() => {

// --- INÍCIO DA ADIÇÃO DE NOVA FUNÇÃO (Handlers._buildDashboardPanelsFromState) ---
function _buildDashboardPanelsFromState(processes) {
    const painelAtrasados = [];
    const paraAtrasar = [];

    if (!processes) return { painelAtrasados, painelParaAtrasar: paraAtrasar };

    processes.forEach(processo => {
        if (!processo.calculatedStatus || !processo.calculatedStatus.text) {
            return;
        }

        if (processo.calculatedStatus.text === 'Atrasado') {
            painelAtrasados.push({
                id: processo.id,
                paciente: processo.paciente,
                numero: processo.numero,
                prazoTipo: processo.calculatedStatus.prazoTipo || 'N/A',
                prazoData: processo.calculatedStatus.prazoData || 'N/A',
                prazoCor: processo.calculatedStatus.prazoCor
            });
        } else if (processo.calculatedStatus.text.includes('Vence em') || processo.calculatedStatus.text === 'Vence hoje') {
            paraAtrasar.push({
                id: processo.id,
                paciente: processo.paciente,
                numero: processo.numero,
                prazoTipo: processo.calculatedStatus.prazoTipo || 'N/A',
                prazoData: processo.calculatedStatus.prazoData || 'N/A',
                prazoCor: processo.calculatedStatus.prazoCor
            });
        }
    });
    
    return { painelAtrasados, painelParaAtrasar: paraAtrasar };
}
// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: handleDeleteProcess com Invalidação de Cache) ---
  async function handleDeleteProcess() {
   if (!appState.processoSelecionado) return;
   if (!appState.currentUser.isAdmin) {
    Utils.showMessageBox('Apenas administradores podem excluir processos.', 'warning');
    return;
   }
   const confirmDelete = await Utils.showMessageBox(`Tem certeza que deseja excluir o processo "${appState.processoSelecionado.paciente}" (${appState.processoSelecionado.numero})? Esta ação não pode ser desfeita.`, 'confirm', 'Confirmar Exclusão');
   if (!confirmDelete) return;

   try {
    DataService.trackUserActivity(appState.processoSelecionado.id, appState.processoSelecionado.numero, `${appState.processoSelecionado.paciente} (excluindo)`);
    const result = await Utils.callBackend('deleteProcessoInSheet', [appState.processoSelecionado.id], true);
    
    // **INVALÍDA O CACHE LOCAL AQUI**
    localStorage.removeItem('processos_app_cache');
    
    appState.processoSelecionado = null;
    document.getElementById('main-content').classList.add('hidden');
    document.getElementById('initial-state').classList.remove('hidden');
    document.getElementById('welcome-message').classList.remove('hidden');
    document.getElementById('search-select-input').value = '';
    
    Utils.showMessageBox('Processo excluído com sucesso.', 'success');
    
    // Após a exclusão, fetchAllData forçará uma recarga completa do zero.
    await DataService.fetchAllData();
    UIService.renderActiveUsersPanel();

   } catch (error) {
    console.error("Erro ao deletar processo:", error);
    Utils.showMessageBox(`Erro ao excluir processo: ${error.message}`, 'error');
   }
  }
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---
   
   /**
* ROTEADOR: Lida com a exclusão de um lançamento, chamando o backend correto.
*/
// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: handleDeleteIndividualConta) ---
 async function handleDeleteIndividualConta(e) {
  if (!appState.currentUser.isAdmin) {
   Utils.showMessageBox('Apenas administradores podem excluir lançamentos.', 'warning');
   return;
  }
  const button = e.currentTarget;
  const contaId = button.dataset.id; // Pega o ID da conta diretamente
  if (!contaId) {
   Utils.showMessageBox('Erro: Não foi possível identificar o lançamento para exclusão (ID ausente).', 'error');
   return;
  }
  
  const confirmDelete = await Utils.showMessageBox('Tem certeza que deseja excluir este lançamento?', 'confirm');
  if (!confirmDelete) return;
  try {
   // CORREÇÃO APLICADA AQUI: Passando o ID do processo e o ID da conta.
   const result = await Utils.callBackend('deleteIndividualConta', [appState.processoSelecionado.id, contaId], true);
   
   Utils.showToast('Lançamento excluído com sucesso!', 'success');
   
   // A lógica abaixo já está correta e vai funcionar após a correção acima.
   const procIndex = appState.db.processos.findIndex(p => p.id === result.id);
   if (procIndex !== -1) appState.db.processos[procIndex] = result;
   appState.processoSelecionado = result;
   UIService.renderMainContent();
   document.querySelector('.tab-btn[data-tab="contas"]').click();
  } catch (error) {
   console.error("Erro ao excluir conta:", error);
   Utils.showMessageBox(`Não foi possível excluir o lançamento: ${error.message}`, 'error');
  }
 }
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---
   /**
   * Lida com a ação de desfazer um lote inteiro de prestações de contas.
   */
  async function handleUndoContasLote(e) {
   if (!appState.currentUser.isAdmin) {
    Utils.showMessageBox('Apenas administradores podem desfazer lançamentos.', 'warning');
    return;
   }
   const button = e.currentTarget;
   const verificationDate = button.dataset.verifData;
   if (!verificationDate) {
    Utils.showMessageBox('Erro: Não foi possível identificar o lote a ser desfeito.', 'error');
    return;
   }
   const confirmUndo = await Utils.showMessageBox(
    'Tem certeza que deseja desfazer este lote de lançamentos? Todos os registros financeiros deste lote serão removidos permanentemente. Esta ação não pode ser revertida.',
    'confirm',
    'Confirmar Desfazer Lote'
   );
   if (!confirmUndo) return;
   try {
    const result = await Utils.callBackend('undoContasLote', [appState.processoSelecionado.id, verificationDate], true);
    Utils.showToast('Lote de lançamentos desfeito com sucesso!', 'success');
    const procIndex = appState.db.processos.findIndex(p => p.id === result.id);
    if (procIndex !== -1) appState.db.processos[procIndex] = result;
    appState.processoSelecionado = result;
    // Recarrega o conteúdo principal e clica na aba de contas para atualizar a visualização
    UIService.renderMainContent();
    document.querySelector('.tab-btn[data-tab="contas"]').click();
   } catch (error) {
    console.error("Erro ao desfazer lote de contas:", error);
    Utils.showMessageBox(`Não foi possível desfazer o lote: ${error.message}`, 'error');
   }
  }

 async function handleEditIndividualConta(e) {
  // Permite que qualquer usuário CADASTRADO (Admin ou Editor) edite a conta.
  if (!appState.currentUser.isRegistered) {
   Utils.showMessageBox('Acesso negado. Apenas usuários cadastrados podem editar lançamentos.', 'warning');
   return;
  }
  
  const button = e.currentTarget;
  const contaId = button.dataset.id;
  
  if (!contaId) {
   Utils.showMessageBox('Erro: Não foi possível identificar o lançamento para edição (ID ausente no botão).', 'error');
   return;
  }

  const conta = appState.processoSelecionado.contas.find(c => c.id === contaId);

  if (!conta) {
   Utils.showMessageBox(`Erro: Registro contábil com ID ${contaId} não foi encontrado no estado atual do processo.`, 'error');
   return;
  }
  
  const form = document.getElementById('form-edit-conta');
  form.reset();    
  
  form.querySelector('#edit-conta-id').value = conta.id;
  form.querySelector('#edit-conta-format').value = conta.tipoLancamento;
 
  const terapiaSelect = form.querySelector('#edit-contas-terapia-select');
  const terapiaNomeManual = form.querySelector('#edit-contas-terapia-nome-manual');
  form.querySelector('#edit-contas-tipo').value = conta.tipoLancamento || '';
  form.querySelector('#edit-contas-data').value = conta.dataMovimentacao || '';
  form.querySelector('#edit-contas-nf-alvara').value = conta.numNfAlvara || '';
  form.querySelector('#edit-contas-valor-alvara').value = Utils.formatAsBRL((parseFloat(conta.valorAlvara) || 0) * 100);
  form.querySelector('#edit-contas-valor-conta').value = Utils.formatAsBRL((parseFloat(conta.valorConta) || 0) * 100);
  setupCurrencyInputListeners(form.querySelector('#edit-contas-valor-alvara'));
  setupCurrencyInputListeners(form.querySelector('#edit-contas-valor-conta'));
  setupDynamicAccountFields(form, appState);    

  if(conta.tipoLancamento === 'Tratamento'){
   form.querySelector('#edit-contas-terapia-qtd').value = conta.quantidade || '';
   form.querySelector('#edit-contas-terapia-mes').value = conta.mesReferencia || '';
   form.querySelector('#edit-contas-terapia-ano').value = conta.anoReferencia || '';
   form.querySelector('#edit-contas-observacoes').value = conta.observacoes || '';
   
   const allItems = Array.from(terapiaSelect.options).map(opt => opt.value);
   if (allItems.includes(conta.terapiaMedicamentoNome)) {
    terapiaSelect.value = conta.terapiaMedicamentoNome;
    terapiaNomeManual.classList.add('hidden');
   } else {
    terapiaSelect.value = 'OUTRO';
    terapiaNomeManual.value = conta.terapiaMedicamentoNome || '';
    terapiaNomeManual.classList.remove('hidden');
   }
  } else if(conta.tipoLancamento === 'Despesa Geral'){
   form.querySelector('#edit-contas-outros-nome-manual').value = conta.terapiaMedicamentoNome || '';
  }
  
  const movChoice = form.querySelector('#edit-contas-mov-processo-choice');
  if (conta.movProcesso === 'Anexo' || isNaN(parseFloat(String(conta.movProcesso).replace('.', '')))) {
   movChoice.value = 'Anexo';
  } else {
   movChoice.value = 'Digitar';
   form.querySelector('#edit-contas-mov-processo-input').value = conta.movProcesso;
  }
  
  setupDynamicAccountFields(form, appState);
  
  Modals.openModal('edit-conta-modal');
 }
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---

 async function handleUpdateIndividualConta(e) {
  e.preventDefault();
  const form = e.target;
  const contaId = form.querySelector('#edit-conta-id').value; // Pega o ID da conta do campo oculto
  if (!contaId) {
   Utils.showMessageBox('Erro: ID do lançamento contábil não encontrado para salvar.', 'error');
   return;
  }
  
  const tipo = form.querySelector('#edit-contas-tipo').value;
  const movChoice = form.querySelector('#edit-contas-mov-processo-choice').value;
  let movProcessoValue = form.querySelector('#edit-contas-mov-processo-input').value.trim();
  if (tipo !== 'Alvará' && movChoice === 'Anexo') {
   movProcessoValue = 'Anexo';
  }
  
  // Lógica para pegar o nome da terapia/despesa corretamente
  let terapiaMedicamentoNome = ''; // Renomeado para refletir o cabeçalho da planilha
  const terapiaSelect = form.querySelector('#edit-contas-terapia-select');
  if (terapiaSelect.value === 'OUTRO') {
   terapiaMedicamentoNome = form.querySelector('#edit-contas-terapia-nome-manual').value.trim();
  } else {
   terapiaMedicamentoNome = terapiaSelect.value;
  }
  const updatedContaData = {
   id: contaId, // Inclui o ID para o backend saber qual conta atualizar
   processoId: appState.processoSelecionado.id, // Adiciona o ProcessoID
   dataMovimentacao: form.querySelector('#edit-contas-data').value,
   tipoLancamento: tipo, // Usa tipoLancamento
   movProcesso: movProcessoValue,
   numNfAlvara: form.querySelector('#edit-contas-nf-alvara').value,
   valorAlvara: Utils.parseBRL(form.querySelector('#edit-contas-valor-alvara').value) || 0,
   valorConta: Utils.parseBRL(form.querySelector('#edit-contas-valor-conta').value) || 0,
   terapiaMedicamentoNome: terapiaMedicamentoNome, // Usa o novo nome da propriedade
   quantidade: form.querySelector('#edit-contas-terapia-qtd').value.trim() || '',
   mesReferencia: form.querySelector('#edit-contas-terapia-mes').value.trim() || '',
   anoReferencia: form.querySelector('#edit-contas-terapia-ano').value.trim() || '',
   observacoes: form.querySelector('#edit-contas-observacoes').value.trim() || '',
   // outrosNomeManual não é mais um campo separado no `updatedContaData`, mas seu valor vai para `terapiaMedicamentoNome`
   historico: '' // Será recriado no backend para consistência
  };
  // Recria o histórico para consistência (pode ser feito no backend também, mas mantido aqui por enquanto)
  if (updatedContaData.tipoLancamento === 'Alvará') {
   updatedContaData.historico = `Recebimento de Alvará (NF/Alvará: ${updatedContaData.numNfAlvara})`;
  } else if (updatedContaData.tipoLancamento === 'Tratamento') {
   let historico = updatedContaData.terapiaMedicamentoNome;
   if (updatedContaData.quantidade) historico += ` - ${updatedContaData.quantidade} un.`;
   if (updatedContaData.mesReferencia && updatedContaData.anoReferencia) historico += ` - Ref: ${updatedContaData.mesReferencia}/${updatedContaData.anoReferencia}`;
   if (updatedContaData.observacoes) historico += ` (${updatedContaData.observacoes})`;
   updatedContaData.historico = historico;
  } else if (updatedContaData.tipoLancamento === 'Despesa Geral') {
   updatedContaData.historico = `Despesa Geral: ${updatedContaData.terapiaMedicamentoNome} ${updatedContaData.numNfAlvara ? `(NF/Alvará: ${updatedContaData.numNfAlvara})` : ''}`;
  }
  try {
   // Chamada ao backend agora usa o ID da conta
   const result = await Utils.callBackend('updateIndividualConta', [appState.processoSelecionado.id, contaId, updatedContaData], true);
   
   Utils.showToast('Lançamento atualizado com sucesso!', 'success');
   
   const procIndex = appState.db.processos.findIndex(p => p.id === result.id);
   if (procIndex !== -1) appState.db.processos[procIndex] = result;
   appState.processoSelecionado = result;
   
   Modals.closeModal('edit-conta-modal');
   UIService.renderMainContent();
   document.querySelector('.tab-btn[data-tab="contas"]').click();
  } catch (error) {
   console.error("Erro ao atualizar conta:", error);
   Utils.showMessageBox(`Não foi possível salvar as alterações: ${error.message}`, 'error');
  }
 }
 // FIM DA SUBSTITUIÇÃO
  /**
     * Adiciona um registro do formulário para a lista de rascunho de contas.
     */
    function handleAddContaRascunho(e) {
     e.preventDefault();
     const form = document.getElementById('form-contas');
     if (!form) return;
     // 1. CAPTURA DOS VALORES (LÓGICA CORRIGIDA PARA O MOVIMENTO)
     const tipo = form.querySelector('#contas-tipo')?.value;
     let movProcesso = '';
     if (tipo === 'Alvará') {
      movProcesso = form.querySelector('#contas-mov-processo-input').value.trim();
     } else {
      const movChoiceValue = form.querySelector('#contas-mov-processo-choice').value;
      if (movChoiceValue === 'Digitar') {
       movProcesso = form.querySelector('#contas-mov-processo-input').value.trim();
      } else {
       movProcesso = 'Anexo';
      }
     }
     // 2. MONTAGEM DO OBJETO 'detalhes' (LÓGICA CORRIGIDA PARA A DATA)
     const detalhes = {
      dataMovimentacao: form.querySelector('#contas-data')?.value,
      movProcesso: movProcesso,
      numNfAlvara: form.querySelector('#contas-nf-alvara')?.value.trim(),
      valorAlvara: Utils.parseBRL(form.querySelector('#contas-valor-alvara')?.value) || 0,
      valorConta: Utils.parseBRL(form.querySelector('#contas-valor-conta')?.value) || 0,
      terapia: form.querySelector('#contas-terapia-select')?.value === 'OUTRO' ?
      form.querySelector('#contas-terapia-nome-manual')?.value.trim() : form.querySelector('#contas-terapia-select')?.value.trim(),
      quantidade: form.querySelector('#contas-terapia-qtd')?.value.trim(),
      mesReferencia: form.querySelector('#contas-terapia-mes')?.value.trim(),
      anoReferencia: form.querySelector('#contas-terapia-ano')?.value.trim(),
      observacoes: form.querySelector('#contas-observacoes')?.value.trim(),
      outrosNomeManual: form.querySelector('#contas-outros-nome-manual')?.value.trim(),
      historico: ''
     };
     // 3. VALIDAÇÃO (OS CAMPOS CONTINUAM OBRIGATÓRIOS E AGORA FUNCIONARÃO)
     if (!detalhes.dataMovimentacao || !tipo) {
      Utils.showMessageBox('Os campos "Data da Movimentação" e "Tipo de Registro" são obrigatórios.', 'warning');
      return;
     }
   if ((tipo === 'Alvará' || form.querySelector('#contas-mov-processo-choice').value === 'Digitar') && !/^[\d.]+$/.test(movProcesso) && movProcesso) {
    Utils.showMessageBox('O campo "Mov. Processo" deve conter apenas números e pontos.', 'warning');
    return;
}
     if (detalhes.valorAlvara > 0 && detalhes.valorConta > 0) {
      Utils.showMessageBox('Não é possível adicionar um crédito e um débito no mesmo registro.', 'warning');
      return;
     }
     // ... (resto da validação existente) ...
     // Lógica de criação do histórico
      if (tipo === 'Alvará') {
      if (detalhes.valorAlvara === 0) { Utils.showMessageBox('Para o tipo "Alvará", o campo "Valor do Alvará" deve ser preenchido.', 'warning'); return; }
      detalhes.historico = `Recebimento de Alvará ${detalhes.numNfAlvara ? `(NF/Alvará: ${detalhes.numNfAlvara})` : ''}`;
     } else if (tipo === 'Tratamento') {
      if (!detalhes.terapia) { Utils.showMessageBox('Para o tipo "Tratamento/Sessões", o campo "Nome da Terapia/Medicamento/Despesa" é obrigatório.', 'warning'); return; }
      if (detalhes.valorConta === 0) { Utils.showMessageBox('Para o tipo "Tratamento/Sessões", o campo "Valor da Conta" deve ser preenchido.', 'warning'); return; }
      detalhes.historico = `${detalhes.terapia}`;
      if (detalhes.quantidade) detalhes.historico += ` - ${detalhes.quantidade} un.`;
      if (detalhes.mesReferencia && detalhes.anoReferencia) detalhes.historico += ` - Ref: ${detalhes.mesReferencia}/${detalhes.anoReferencia}`;
      if (detalhes.observacoes) detalhes.historico += ` (${detalhes.observacoes})`;
     } else if (tipo === 'Despesa Geral') {
      if (!detalhes.outrosNomeManual) { Utils.showMessageBox('Para o tipo "Despesa Geral", o campo "Nome da Despesa Geral" é obrigatório.', 'warning'); return; }
      if (detalhes.valorConta === 0) { Utils.showMessageBox('Para o tipo "Despesa Geral", o campo "Valor da Conta" deve ser preenchido.', 'warning'); return; }
      detalhes.historico = `Despesa Geral: ${detalhes.outrosNomeManual} ${detalhes.numNfAlvara ? `(NF/Alvará: ${detalhes.numNfAlvara})` : ''}`;
     }
     if (!appState.contasEmRascunho) { appState.contasEmRascunho = []; }
     // 4. SALVAMENTO E ATUALIZAÇÃO DA TELA (ORDEM CORRIGIDA)
     appState.contasEmRascunho.push({ id: `rascunho-${Date.now()}`, tipo: tipo, detalhes: detalhes });
     localStorage.setItem(`rascunhoContas_${appState.processoSelecionado.id}`, JSON.stringify(appState.contasEmRascunho));
     
     Utils.showToast('Lançamento adicionado à lista de rascunho.', 'info');
     // A chamada para redesenhar o formulário agora é a ÚLTIMA ação.
     // Isso resolve o bug de validação, pois reinicia o formulário corretamente.
     UIService.renderContasForm();
    }
  /**
   * Remove um item da lista de rascunho de contas.
   */
  function handleRemoveContaRascunho(e) {
   const rascunhoId = e.target.closest('button')?.dataset.id;
   if (!rascunhoId) return;
   appState.contasEmRascunho = appState.contasEmRascunho.filter(r => r.id !== rascunhoId);
   localStorage.setItem(`rascunhoContas_${appState.processoSelecionado.id}`, JSON.stringify(appState.contasEmRascunho));
   UIService.renderContasForm();
   Utils.showToast('Lançamento removido do rascunho.', 'info');
  }
  /**
   * Limpa todos os itens da lista de rascunho de contas.
   */
  async function handleClearAllContasRascunho() {
   if (appState.contasEmRascunho.length === 0) {
    Utils.showMessageBox('Não há registros em rascunho para limpar.', 'warning');
    return;
   }
   const confirm = await Utils.showMessageBox('Tem certeza que deseja limpar todos os registros não salvos?', 'confirm', 'Limpar Rascunho');
   if (confirm) {
    appState.contasEmRascunho = [];
    localStorage.removeItem(`rascunhoContas_${appState.processoSelecionado.id}`);
    UIService.renderContasForm();
    Utils.showToast('Rascunhos limpos.', 'info');
   }
  }
 async function handleSaveAllContas() {
  if (appState.contasEmRascunho.length === 0) {
   Utils.showMessageBox('Não há registros na lista para salvar.', 'warning');
   return;
  }
  const confirm = await Utils.showMessageBox(`Você está prestes a salvar ${appState.contasEmRascunho.length} novos registros contábeis permanentemente. Continuar?`, 'confirm', 'Salvar Prestações de Contas');
  if (!confirm) return;
  try {
   const result = await Utils.callBackend('salvarLoteDeContas', [appState.processoSelecionado.id, appState.contasEmRascunho], true);
   Utils.showToast('Prestações de contas salvas com sucesso!', 'success');
   appState.contasEmRascunho = [];
   localStorage.removeItem(`rascunhoContas_${appState.processoSelecionado.id}`);
   const procIndex = appState.db.processos.findIndex(p => p.id === result.id);
   if (procIndex !== -1) appState.db.processos[procIndex] = result;
   
   UIService.selectProcesso(result); // Isso já atualiza o resumo do processo
   document.querySelector('.tab-btn[data-tab="contas"]').click(); // Para garantir que a aba de contas se re-renderize
   // >>>>> AGORA APENAS ATUALIZA OS PAINÉIS SUPERIORES ESPECIFICAMENTE <<<<<
   
  } catch (error) {
   console.error("Erro ao salvar lote de contas:", error);
   Utils.showMessageBox(`Erro ao salvar prestações de contas: ${error.message}`, 'error');
  }
 }
// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: handleExportContasPDF) ---
function handleExportContasPDF() {
    // 1. OBTÉM A LISTA COMPLETA E JÁ CORRETA DE LANÇAMENTOS DO ESTADO ATUAL
    const todosOsLancamentos = appState.processoSelecionado.contas || [];

    // 2. ORDENA PELA DATA (importante para o cálculo do saldo parcial)
    todosOsLancamentos.sort((a, b) => new Date(a.dataMovimentacao) - new Date(b.dataMovimentacao));

    if (todosOsLancamentos.length === 0) {
        Utils.showMessageBox('Não há prestações de contas salvas para exportar.', 'warning');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4'
    });

    const centerX = doc.internal.pageSize.width / 2;

    doc.setFontSize(18);
    doc.text('PRESTAÇÃO DE CONTAS', centerX, 22, { align: 'center' });

    doc.setFontSize(11);
    doc.text(`Paciente: ${appState.processoSelecionado.paciente}`, centerX, 30, { align: 'center' });
    doc.text(`Autos Nº PROCESSO: ${appState.processoSelecionado.numero}`, centerX, 36, { align: 'center' });

    const head = [['Data', 'Mov. Processo', 'Nº NF/Alvará', 'Histórico/Detalhes', 'Crédito (R$)', 'Débito (R$)', 'Saldo (R$)']];
    const body = [];
    let saldoParcial = 0;

    todosOsLancamentos.forEach(reg => {
        const credito = parseFloat(reg.valorAlvara) || 0;
        const debito = parseFloat(reg.valorConta) || 0;
        saldoParcial += (credito - debito);

        const dataMovFormatada = reg.dataMovimentacao ? new Date(reg.dataMovimentacao + 'T00:00:00').toLocaleDateString('pt-BR') : 'Data N/A';
        
        let saldoParcialColor = 'black';
        if (saldoParcial > 0) {
            saldoParcialColor = '#007a11';
        } else if (saldoParcial < 0) {
            saldoParcialColor = '#a70000';
        }

        body.push([
            dataMovFormatada,
            reg.movProcesso || '-',
            reg.numNfAlvara || '-',
            reg.historico || 'N/A',
            { content: credito.toFixed(2).replace('.', ','), styles: { textColor: '#007a11' } },
            { content: debito.toFixed(2).replace('.', ','), styles: { textColor: '#a70000' } },
            { content: saldoParcial.toFixed(2).replace('.', ','), styles: { textColor: saldoParcialColor } }
        ]);
    });

    doc.autoTable({
        head: head,
        body: body,
        startY: 45,
        theme: 'grid',
        headStyles: {
            fillColor: [41, 128, 185],
            textColor: 255,
            halign: 'center',
            fontSize: 11
        },
        styles: {
            fontSize: 10,
            cellPadding: 2,
            overflow: 'linebreak',
            halign: 'center',
            textColor: 'black'
        },
        columnStyles: {
            0: { cellWidth: 22 },
            1: { cellWidth: 25 },
            2: { cellWidth: 30 },
            3: { halign: 'left', cellWidth: 'auto' },
            4: { halign: 'right', cellWidth: 30, fontStyle: 'bold' },
            5: { halign: 'right', cellWidth: 30, fontStyle: 'bold' },
            6: { halign: 'right', cellWidth: 30, fontStyle: 'bold' },
        },
        didDrawPage: (data) => {
            doc.setFontSize(9);
            doc.text(`Pág. ${data.pageNumber} de ${data.pageCount}`, data.settings.margin.left, doc.internal.pageSize.height - 10);
            doc.text(`Processo: ${appState.processoSelecionado.numero} - Paciente: ${appState.processoSelecionado.paciente}`, doc.internal.pageSize.width - data.settings.margin.right, doc.internal.pageSize.height - 10, { align: 'right' });
        },
    });

    const totalCreditos = todosOsLancamentos.reduce((acc, curr) => acc + (parseFloat(curr.valorAlvara) || 0), 0);
    const totalDebitos = todosOsLancamentos.reduce((acc, curr) => acc + (parseFloat(curr.valorConta) || 0), 0);
    const saldoFinal = totalCreditos - totalDebitos;

    let saldoFinalColor = 'black';
    if (saldoFinal > 0) {
        saldoFinalColor = '#007a11';
    } else if (saldoFinal < 0) {
        saldoFinalColor = '#a70000';
    }

    const finalY = doc.autoTable.previous.finalY + 10;
    doc.setFontSize(11);
    doc.setFont(undefined, 'bold');
    doc.text('RESUMO FINAL:', 14, finalY);
    doc.autoTable({
        startY: finalY + 5,
        body: [
            [{ content: 'Total de Créditos (Alvarás):', styles: { fontStyle: 'bold' } }, { content: `R$ ${totalCreditos.toFixed(2).replace('.', ',')}`, styles: { halign: 'right', fontStyle: 'bold', textColor: '#007a11' } }],
            [{ content: 'Total de Débitos (Contas):', styles: { fontStyle: 'bold' } }, { content: `R$ ${totalDebitos.toFixed(2).replace('.', ',')}`, styles: { halign: 'right', fontStyle: 'bold', textColor: '#a70000' } }],
            [{ content: 'SALDO FINAL:', styles: { fontStyle: 'bold' } }, { content: `R$ ${saldoFinal.toFixed(2).replace('.', ',')}`, styles: { halign: 'right', fontStyle: 'bold', textColor: saldoFinalColor } }],
        ],
        theme: 'plain',
        styles: {
            fontSize: 10,
            fontStyle: 'normal'
        },
        columnStyles: { 0: { halign: 'left' }, 1: { halign: 'right' } },
        margin: { left: 14 }
    });
    
    doc.save(`prestacao_contas_${appState.processoSelecionado.paciente}.pdf`);
    Utils.showToast('PDF de Prestação de Contas gerado com sucesso!', 'success');
}
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---
  /**
   * Lida com a ação de desfazer a última verificação.
   */
// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: handleUndoLastVerification) ---
async function handleUndoLastVerification(e) {
    if (!appState.currentUser.isAdmin) {
        Utils.showMessageBox('Apenas administradores podem desfazer verificações.', 'warning');
        return;
    }

    const processId = e.target.dataset.id || appState.processoSelecionado.id;
    if (!processId) return;

    const userConfirmed = await Utils.showMessageBox(
        'Tem certeza que deseja desfazer a última verificação? Esta ação removerá permanentemente os dados associados a ela. Esta ação não pode ser revertida.',
        'confirm',
        'Confirmar Ação'
    );
    if (!userConfirmed) return;
    
try {
        const updatedProcess = await Utils.callBackend('undoLastVerification', [processId], true);
        Utils.showToast('Última verificação desfeita com sucesso!', 'success');
        
        // Em vez de chamar fetchAllData, apenas atualiza o processo atual e os painéis
        const procIndex = appState.db.processos.findIndex(p => p.id === updatedProcess.id);
        if (procIndex !== -1) appState.db.processos[procIndex] = updatedProcess;
        
        UIService.selectProcesso(updatedProcess); // Usa a função já inteligente para recarregar a UI

    } catch (error) {
        console.error("Erro ao desfazer última verificação:", error);
        // A mensagem de erro para o usuário já é tratada por callBackend, mas podemos adicionar uma específica
        Utils.showMessageBox(`Não foi possível desfazer a verificação. Motivo: ${error.message}`, 'error', 'Operação Falhou');
    }
}
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---
  /**
   * Lida com o envio do formulário de registo de utilizador.
   */
  async function handleRegisterUser(e) {
   e.preventDefault();
   const name = document.getElementById('register-name').value.trim();
   if (name && appState.currentUser.email) {
    try {
     const result = await Utils.callBackend('registerNewUser', [appState.currentUser.email, name], true);
     if (result.success) {
      appState.currentUser = { ...appState.currentUser, isRegistered: true, nome: name, id: result.id, isAdmin: result.isAdmin };
      Utils.showMessageBox(`Bem-vindo, ${name}! O seu registo foi concluído.`, 'success', 'Registo Concluído');
      document.getElementById('user-check-prompt').classList.add('hidden');
      await DataService.fetchAllData();
      DataService.trackUserActivity();
     } else {
      Utils.showMessageBox(result.message || 'Erro ao registar utilizador.', 'error');
     }
    } catch (error) {
     console.error("Erro ao registar utilizador:", error);
     Utils.showMessageBox(`Erro ao registar utilizador: ${error.message}`, 'error');
    }
   } else {
    Utils.showMessageBox("Por favor, preencha o seu nome.", 'warning');
   }
  }
  /**
   * Abre o modal para criar um novo processo.
   */
  const openCreateModal = () => {
   if (!appState.currentUser.isRegistered) {
    Utils.showMessageBox('Você precisa estar registado para criar novos processos.', 'warning');
    return;
   }
   appState.isEditing = false;
   document.getElementById('form-novo-processo').innerHTML = UIService.getFormHtml();
   document.getElementById('modal-title').textContent = 'Cadastrar Novo Processo';
   appState.terapiasAdicionadas = [];
   appState.medicamentosAdicionadas = [];
   appState.cirurgiasAdicionadas = [];
   appState.outrosItensAdicionadas = [];
   UIService.setupFormListeners();
   Modals.openModal('novo-processo-modal');
   DataService.trackUserActivity(null, null, 'Criando novo processo');
   UIService.renderActiveUsersPanel();
  };

  /**
   * Abre o modal para editar um processo existente.
   */

const openEditModal = async () => {
    if (!appState.processoSelecionado) return;
    if (!appState.currentUser.isAdmin) { Utils.showMessageBox('Apenas administradores podem alterar processos.', 'warning'); return; }
    
    // Garante que os dados completos estão carregados antes de abrir o modal
    if (appState.processoSelecionado.verificacoes === undefined) {
        try {
            await UIService.selectProcesso(appState.processoSelecionado);
        } catch(e) { return; } // Se a busca falhar, interrompe
    }
    
    appState.isEditing = true;
    document.getElementById('form-novo-processo').innerHTML = UIService.getFormHtml();
    document.getElementById('modal-title').textContent = 'Alterar Cadastro do Processo';
    
    const processo = appState.processoSelecionado;
    document.getElementById('novo-numero').value = processo.numero || '';
    document.getElementById('novo-paciente').value = processo.paciente || '';
    document.getElementById('novo-genitor').value = processo.genitor || '';
    document.getElementById('novo-juiz').value = processo.juiz || '';
    document.getElementById('novo-tipo').value = processo.tipo || '';
    
    const ultimaVerificacaoGeral = [...(processo.verificacoes || [])]
        .filter(v => !['Lançamento Contábil de Lote', 'Edição de Conta Individual', 'Exclusão de Conta Individual', 'Verificação Desfeita'].includes(v.statusProcesso))
        .sort((a,b) => new Date(b.data) - new Date(a.data))[0];
    
    document.getElementById('novo-status-processo-inicial').value = ultimaVerificacaoGeral ? ultimaVerificacaoGeral.statusProcesso : 'Não iniciado';
    document.getElementById('novo-ultimaprescricao').value = processo.ultimaprescricao || '';
    
    appState.terapiasAdicionadas = JSON.parse(JSON.stringify(processo.terapias || []));
    appState.medicamentosAdicionadas = JSON.parse(JSON.stringify(processo.medicamentos || []));
    appState.cirurgiasAdicionadas = JSON.parse(JSON.stringify(processo.cirurgias || []));
    appState.outrosItensAdicionadas = JSON.parse(JSON.stringify(processo.outrosItens || []));
    
    UIService.setupFormListeners();
    
    // CORREÇÃO: Renderiza as listas e mostra as seções correspondentes
    UIService.renderDynamicList('terapias-list-cadastro', appState.terapiasAdicionadas, UIService.renderTerapiaItem, `flex items-center justify-between`);
    UIService.renderDynamicList('medicamentos-list-cadastro', appState.medicamentosAdicionadas, UIService.renderMedicamentoItem, `flex flex-col sm:flex-row items-start sm:items-center justify-between`);
    UIService.renderDynamicList('cirurgias-list-cadastro', appState.cirurgiasAdicionadas, UIService.renderCirurgiaItem, `flex flex-col sm:flex-row items-start sm:items-center justify-between`);
    UIService.renderDynamicList('outros-list-cadastro', appState.outrosItensAdicionadas, UIService.renderOutroItem, `flex flex-col sm:flex-row items-start sm:items-center justify-between`);
    
    if (appState.terapiasAdicionadas.length > 0) document.getElementById('terapias-list-section').classList.remove('hidden');
    if (appState.medicamentosAdicionadas.length > 0) document.getElementById('medicamentos-list-section').classList.remove('hidden');
    if (appState.cirurgiasAdicionadas.length > 0) document.getElementById('cirurgias-list-section').classList.remove('hidden');
    if (appState.outrosItensAdicionadas.length > 0) document.getElementById('outros-list-section').classList.remove('hidden');
    
    UIService.updateUltimaPrescricaoGroupVisibility();
    Modals.openModal('novo-processo-modal');
    DataService.trackUserActivity(processo.id, processo.numero, `${processo.paciente} (editando)`);
    UIService.renderActiveUsersPanel();
};
    
    /**
    * Adiciona uma nova terapia ao array temporário.
    */
    const handleAddTerapia = () => {
    const select = document.getElementById('terapia-select-cadastro');
    if (select.value && !appState.terapiasAdicionadas.some(t => t.nome === select.value)) {
    appState.terapiasAdicionadas.push({
    nome: select.value, quantidade: 1, ultimoRelatorio: '', qtdAtual: 1, qtdSus: 0, qtdPlano: 0, desnecessario: false,
    clinicaProfissional: ''
    });
    document.getElementById('terapias-list-section').classList.remove('hidden');
    UIService.renderDynamicList('terapias-list-cadastro', appState.terapiasAdicionadas, UIService.renderTerapiaItem, `flex items-center justify-between`);
    select.value = '';
    // CORREÇÃO: Esconde a seção de formulário após adicionar
    document.getElementById('terapias-section').classList.add('hidden');
    } else if (select.value) {
    Utils.showMessageBox("Esta terapia já foi adicionada.", 'warning');
    }
    };


    /**
    * Lida com a remoção de um item de uma lista temporária (terapias, meds, etc).
    */
const handleRemoveItem = (e) => {
    const btn = e.target.closest('.remove-btn');
    if (!btn) return;
    
    const listName = btn.dataset.list;
    const index = parseInt(btn.dataset.index, 10);
    // CORREÇÃO: IDs das seções e listas atualizados para o novo layout
    const sectionId = listName.replace('Adicionadas', '-list-section').toLowerCase();
    const listId = listName.replace('Adicionadas', '-list-cadastro');
    
    if (appState[listName]) {
        appState[listName].splice(index, 1);
        let renderFn, itemClass;
        switch(listName) {
           case 'terapiasAdicionadas': 
            renderFn = UIService.renderTerapiaItem; 
            itemClass = `flex items-center justify-between`;
            break;
           case 'medicamentosAdicionadas': 
            renderFn = UIService.renderMedicamentoItem; 
            itemClass = `flex flex-col sm:flex-row items-start sm:items-center justify-between`; 
            break;
           case 'cirurgiasAdicionadas': 
            renderFn = UIService.renderCirurgiaItem; 
            itemClass = `flex flex-col sm:flex-row items-start sm:items-center justify-between`; 
            break;
           case 'outrosItensAdicionadas': 
            renderFn = UIService.renderOutroItem; 
            itemClass = `flex flex-col sm:flex-row items-start sm:items-center justify-between`; 
            break;
           default: return;
        }
    
        UIService.renderDynamicList(listId, appState[listName], renderFn, itemClass);
    
        // CORREÇÃO: Esconde a seção inteira se a lista ficar vazia
        if (appState[listName].length === 0) {
            document.getElementById(sectionId).classList.add('hidden');
        }
        if (listName === 'medicamentosAdicionadas') {
            UIService.updateUltimaPrescricaoGroupVisibility();
        }
    }
};

    /**
    * Lida com a adição de um novo medicamento ao array temporário.
    */
    const handleAddMedicamento = () => {
    const nomeInput = document.getElementById('medicamento-nome-input-cadastro');
    const posologiaInput = document.getElementById('medicamento-posologia-input-cadastro');
    if(nomeInput.value.trim() && posologiaInput.value.trim()) {
    appState.medicamentosAdicionadas.push({ nome: nomeInput.value.trim(), posologia: posologiaInput.value.trim(),
    desnecessario: false });
    document.getElementById('medicamentos-list-section').classList.remove('hidden');
    UIService.renderDynamicList('medicamentos-list-cadastro', appState.medicamentosAdicionadas,
    UIService.renderMedicamentoItem, `flex flex-col sm:flex-row items-start sm:items-center justify-between`);
    nomeInput.value = '';
    posologiaInput.value = '';
    // CORREÇÃO: Esconde a seção de formulário após adicionar
    document.getElementById('medicamentos-section').classList.add('hidden');
    } else {
    Utils.showMessageBox("Por favor, preencha o nome e a posologia do medicamento.", 'warning');
    }
    };
    
    /**
    * Lida com a adição de uma nova cirurgia ao array temporário.
    */
const handleAddCirurgia = () => {
    const nomeInput = document.getElementById('cirurgia-nome-input-cadastro');
    const dataInput = document.getElementById('cirurgia-data-input-cadastro');
    const statusSelect = document.getElementById('cirurgia-status-select-cadastro');
    if (nomeInput.value.trim() && dataInput.value.trim() && statusSelect.value) {
    appState.cirurgiasAdicionadas.push({ nome: nomeInput.value.trim(), dataCirurgia: dataInput.value.trim(), status:
    statusSelect.value });
    document.getElementById('cirurgias-list-section').classList.remove('hidden');
    UIService.renderDynamicList('cirurgias-list-cadastro', appState.cirurgiasAdicionadas, UIService.renderCirurgiaItem,
    `flex flex-col sm:flex-row items-start sm:items-center justify-between`);
    nomeInput.value = ''; dataInput.value = ''; statusSelect.value = '';
    // CORREÇÃO: Esconde a seção de formulário após adicionar
    document.getElementById('cirurgias-section').classList.add('hidden');
    } else {
    Utils.showMessageBox("Por favor, preencha o nome, a data e o estado da cirurgia.", 'warning');
    }
    };

    /**
    * Lida com a adição de um novo item genérico ao array temporário.
    */
const handleAddOutro = () => {
    const nomeInput = document.getElementById('outro-nome-input-cadastro');
    const descricaoInput = document.getElementById('outro-descricao-input-cadastro');
    if (nomeInput.value.trim()) {
    appState.outrosItensAdicionadas.push({ nome: nomeInput.value.trim(), descricao: descricaoInput.value.trim() });
    document.getElementById('outros-list-section').classList.remove('hidden');
    UIService.renderDynamicList('outros-list-cadastro', appState.outrosItensAdicionadas, UIService.renderOutroItem, `flex
    flex-col sm:flex-row items-start sm:items-center justify-between`);
    nomeInput.value = ''; descricaoInput.value = '';
    // CORREÇÃO: Esconde a seção de formulário após adicionar
    document.getElementById('outros-section').classList.add('hidden');
    } else {
    Utils.showMessageBox("Por favor, preencha o nome do item.", 'warning');
    }
    };

        /**
    * Lida com a atualização da quantidade de uma terapia no array temporário.
    */
    const handleUpdateTerapiaQty = (e) => {
    if (e.target.dataset.list === 'terapiasAdicionadas') {
    appState.terapiasAdicionadas[parseInt(e.target.dataset.index, 10)].quantidade = parseInt(e.target.value, 10) || 0;
    }
    };
    
    async function handleFormNovoProcessoSubmit(e) {
    e.preventDefault();
    const form = e.target;
    if (Utils.scrollToFirstInvalidField(form)) {
    Utils.showMessageBox('Por favor, preencha todos os campos obrigatórios.', 'warning');
    return;
    }
    
    const values = {
    numero: document.getElementById('novo-numero').value.trim(),
    paciente: document.getElementById('novo-paciente').value.trim(),
    genitor: document.getElementById('novo-genitor').value.trim(),
    juiz: document.getElementById('novo-juiz').value.trim(),
    tipo: document.getElementById('novo-tipo').value.trim(),
    terapias: appState.terapiasAdicionadas,
    medicamentos: appState.medicamentosAdicionadas,
    cirurgias: appState.cirurgiasAdicionadas,
    outrosItens: appState.outrosItensAdicionadas,
    ultimaprescricao: document.getElementById('novo-ultimaprescricao').value.trim()
    };
    
    if (appState.isEditing) {
    // A lógica de edição continua a mesma
    const updatedProcesso = { id: appState.processoSelecionado.id, verificacoes: appState.processoSelecionado.verificacoes,
    ...values };
    try {
    const result = await Utils.callBackend('updateProcessoInSheet', [updatedProcesso], true);
    const procIndex = appState.db.processos.findIndex(p => p.id === result.id);
    if (procIndex !== -1) appState.db.processos[procIndex] = result;
    Utils.showMessageBox('Processo alterado com sucesso!', 'success');
    UIService.selectProcesso(result);
    } catch (error) {
    console.error("Erro ao alterar processo:", error);
    }
    } else {
    // LÓGICA DE CRIAÇÃO SIMPLIFICADA
    // 1. Monta um objeto simples com os valores do formulário
    const novoProcesso = {
    ...values,
    // 2. Adiciona o status inicial para o backend poder usá-lo
    statusInicial: document.getElementById('novo-status-processo-inicial').value.trim()
    };
    // A criação da 'initialVerification' foi removida daqui
    
    try {
    // 3. Envia o objeto simples para o backend, que fará todo o trabalho
    const result = await Utils.callBackend('createProcessoInSheet', [novoProcesso], true);
    appState.db.processos.push(result);
    Utils.showMessageBox('Processo registado com sucesso!', 'success');
    UIService.selectProcesso(result);
    } catch (error) {
    console.error("Erro ao registar processo:", error);
    }
    }
    Modals.closeModal('novo-processo-modal');
    UIService.renderStatusPanels();
    UIService.renderActiveUsersPanel();
    }
   

// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função de Frontend: handleFormVerificacaoSubmit) ---
async function handleFormVerificacaoSubmit(e) {
  e.preventDefault();
  const form = e.target;
  if (!appState.processoSelecionado || !appState.currentUser.isRegistered) return;
  
  if (Utils.scrollToFirstInvalidField(form)) {
   Utils.showMessageBox('Por favor, preencha todos os campos obrigatórios.', 'warning');
   return;
  }

  // 1. MONTA O PAYLOAD COM TUDO O QUE FOI PREENCHIDO NO FORMULÁRIO
  const payload = {
   statusProcesso: document.getElementById('verificacao-status-processo').value,
   diligencia: document.getElementById('verificacao-diligencia').value,
   descricao: document.getElementById('verificacao-descricao').value,
   pendencias: document.getElementById('verificacao-pendencias').value,
   prazoDiligencia: document.getElementById('verificacao-prazo-diligencia').value || null,
   prescricaoData: document.getElementById('verificacao-prescricao-data')?.value || null,
   terapias: [],
   medicamentos: [],
   cirurgias: [],
   outrosItens: []
  };

  // Coleta os dados atualizados de TERAPIAS
  (appState.processoSelecionado.terapias || []).forEach((terapiaOriginal, index) => {
   const itemAtualizado = { ...terapiaOriginal };
   itemAtualizado.desnecessario = document.getElementById(`terapia-desnecessaria-${index}`)?.checked || false;
   itemAtualizado.qtdAtual = document.getElementById(`terapia-qtd-atual-${index}`)?.value || 0;
   itemAtualizado.qtdSus = document.getElementById(`terapia-qtd-sus-${index}`)?.value || 0;
   itemAtualizado.qtdPlano = document.getElementById(`terapia-qtd-plano-${index}`)?.value || 0;
   itemAtualizado.ultimoRelatorio = document.getElementById(`terapia-relatorio-${index}`)?.value || null;
   itemAtualizado.clinicaProfissional = document.getElementById(`terapia-clinica-profissional-${index}`)?.value || '';
   payload.terapias.push(itemAtualizado);
  });

  // Coleta os dados atualizados de MEDICAMENTOS
  (appState.processoSelecionado.medicamentos || []).forEach((medicamentoOriginal, index) => {
   const itemAtualizado = { ...medicamentoOriginal };
   itemAtualizado.desnecessario = document.getElementById(`medicamento-desnecessario-${index}`)?.checked || false;
   itemAtualizado.posologia = document.getElementById(`posologia-update-${index}`)?.value || medicamentoOriginal.posologia;
   payload.medicamentos.push(itemAtualizado);
  });

  // Coleta os dados atualizados de CIRURGIAS
  (appState.processoSelecionado.cirurgias || []).forEach((cirurgiaOriginal, index) => {
   const itemAtualizado = { ...cirurgiaOriginal };
   itemAtualizado.dataCirurgia = document.getElementById(`cirurgia-update-data-${index}`)?.value || null;
   itemAtualizado.status = document.getElementById(`cirurgia-update-status-${index}`)?.value || cirurgiaOriginal.status;
   payload.cirurgias.push(itemAtualizado);
  });

  // Coleta os dados atualizados de OUTROS ITENS
  (appState.processoSelecionado.outrosItens || []).forEach((outroItemOriginal, index) => {
   const itemAtualizado = { ...outroItemOriginal };
   itemAtualizado.descricao = document.getElementById(`outro-update-descricao-${index}`)?.value || '';
   payload.outrosItens.push(itemAtualizado);
  });

  // Gera um resumo do que mudou desde o último estado salvo
  payload.alteracoes = Handlers.getChangesSummary(
   appState.processoSelecionado, // O estado antigo
   payload.terapias,             // O novo estado lido do formulário
   payload.medicamentos,
   payload.cirurgias,
   payload.outrosItens,
   payload.prescricaoData
  );
  
  Modals.closeModal('verificacao-modal');
  
  try {
   // 2. CHAMA A FUNÇÃO DO BACKEND E PASSA O PAYLOAD
   const result = await Utils.callBackend('salvarNovaVerificacao', [appState.processoSelecionado.id, payload], true);
   
   // 3. ATUALIZA A TELA COM A RESPOSTA
   UIService.selectProcesso(result);
   Utils.showToast('Verificação guardada com sucesso!', 'success');
  } catch (error) { 
   console.error("Erro ao guardar verificação:", error);
   Utils.showMessageBox(`Erro ao salvar verificação: ${error.message}`, 'error');
  }
}
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---
    /**
    * Lida com o login do administrador.
    */
// --- INÍCIO DA SELEÇÃO PARA SUBSTITUIÇÃO (Função: handleAdminLogin) ---
    async function handleAdminLogin(e) {
    e.preventDefault();
    const username = document.getElementById('admin-username').value;
    const password = document.getElementById('admin-password').value;
    const loginError = document.getElementById('admin-login-error');
    const loginBtn = document.getElementById('admin-login-submit-btn');
    loginBtn.disabled = true;
    
    try {
    const authResult = await Utils.callBackend('authenticateAdmin', [username, password], false);
    if (authResult.authenticated) {
    Modals.closeModal('admin-login-modal');
    appState.currentUser = { ...appState.currentUser, ...authResult };
    
    // CORREÇÃO APLICADA AQUI
    UIService.renderUIForUser();

    UIService.renderManageUsersModal();
    Modals.openModal('manage-users-modal');
    DataService.trackUserActivity(null, null, 'Login Administrador');
    UIService.renderActiveUsersPanel();
    } else {
    loginError.classList.remove('hidden');
    }
    } catch (error) {
    console.error("Erro no login administrador:", error);
    } finally {
    loginBtn.disabled = false;
    }
    }
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO ---
    
    /**
    * Lida com o registo de um novo utilizador pelo admin.
    */
  async function handleAddUserByAdmin(e) {
  e.preventDefault();
  const email = document.getElementById('new-user-email').value.trim();
  const name = document.getElementById('new-user-name').value.trim();
  if (email && name) {
  try {
  // O primeiro parâmetro deveria ser o email do admin que está a fazer a ação, não o do novo usuário.
  await Utils.callBackend('registerNewUser', [email, name], true);
  Utils.showMessageBox('Utilizador adicionado com sucesso!', 'success');
  document.getElementById('new-user-email').value = '';
  document.getElementById('new-user-name').value = '';
  UIService.renderManageUsersModal();
  DataService.trackUserActivity(null, null, `Adicionou ${name} como utilizador`);
  UIService.renderActiveUsersPanel();
  }
  catch (error) {
  console.error("Erro ao adicionar utilizador:", error);
  Utils.showMessageBox(`Erro ao adicionar utilizador: ${error.message}`, 'error');
  }
  } else {
  Utils.showMessageBox("Por favor, preencha o e-mail e o nome do novo utilizador.", 'warning');
  }
  }
  
  /**
  * Abre o modal de Relatórios e Busca Avançada.
  */
function openReportAdvancedSearchModal() {
    // Popula os menus dropdown com as opções do estado da aplicação
    const statusSelect = document.getElementById('adv-filter-status');
    const tipoSelect = document.getElementById('adv-filter-type');

    if (statusSelect && (statusSelect.options.length <= 1)) { // Preenche apenas se estiver vazio
        const statusOptions = (appState.config.statusDeProcesso || []).map(item => `<option value="${item}">${item}</option>`).join('');
        statusSelect.innerHTML += statusOptions;
    }

    if (tipoSelect && (tipoSelect.options.length <= 2)) { // Preenche apenas se estiver vazio
        const tipoOptions = (appState.config.tiposDeProcesso || []).map(item => `<option value="${item}">${item}</option>`).join('');
        tipoSelect.innerHTML += tipoOptions;
    }

    Modals.openModal('report-advanced-search-modal');
}
// --- FIM DA SELEÇÃO PARA SUBSTITUIÇÃO --- 
  /**
  * Gera e exibe o resumo do relatório.
  */
  async function generateReportSummary() {
   const outputDiv = document.getElementById('report-summary-output');
   // ERRO CORRIGIDO: Usando crases (``) para permitir a string multi-linha.
   outputDiv.innerHTML = `
    <div class="flex justify-center items-center">
     <div class="spinner !w-6 !h-6 !border-3 !border-l-purple-600 mr-2"></div>Gerando relatório...
    </div>`;
   outputDiv.classList.remove('hidden');
   try {
    const summary = await Utils.callBackend('generateProcessReportSummary', [], true);
    let html = `<h5 class="font-bold text-base mb-2">Resumo Geral de Processos</h5>         <p><strong>Total:</strong> ${summary.totalProcesses}</p><br/>`;                                html += '<h5 class="font-bold text-base mb-1">Por Estado:</h5>';            for (const status in summary.byStatus) { html += `<p>- ${status}: ${summary.byStatus[status]}</p>`; }
    html += '<br/>  <h5 class="font-bold text-base mb-1">Por Tipo:</h5>';         for (const type in summary.byType) { html += `<p>- ${type}: ${summary.byType[type]}</p>`; }
    outputDiv.innerHTML = html;
   } catch (error) {
    outputDiv.innerHTML = `<p class="text-red-500">Erro ao gerar relatório: ${error.message}</p>`;
   }
  }
  
  /**
  * Lida com a busca avançada.
  */
  async function handleAdvancedSearch(e) {
  e.preventDefault();
  appState.advancedSearch.currentPage = 1;
  appState.advancedSearch.sortBy = document.getElementById('adv-sort-by').value;
  appState.advancedSearch.sortOrder = document.getElementById('adv-sort-order').value;
  await performAdvancedSearch();
  }
  
 // CÓDIGO CORRIGIDO PARA SUBSTITUIÇÃO (3 de 3)
  /**
  * Executa a busca avançada com os filtros e paginação atuais.
  */
  async function performAdvancedSearch() {
   const searchTerm = document.getElementById('adv-search-term').value.trim();
   const filters = {
    statusProcesso: document.getElementById('adv-filter-status').value,
    tipo: document.getElementById('adv-filter-type').value,
    juiz: document.getElementById('adv-filter-judge').value.trim(),
   };
   const outputDiv = document.getElementById('advanced-search-results-output');
   outputDiv.innerHTML = `
    <div class="text-center p-4">
     <div class="spinner mx-auto"></div>
     <p class="mt-2 text-gray-500">Buscando...</p>
    </div>`;
   outputDiv.classList.remove('hidden');
   document.getElementById('advanced-search-pagination').classList.add('hidden');
   
   try {
    // A busca avançada agora opera sobre os dados já carregados em appState.db.processos
    // Não precisa de uma nova chamada ao backend para isso, pois os dados já estão no frontend.
    let results = appState.db.processos || [];
    // Aplicar filtros
    if (filters.statusProcesso) {
     results = results.filter(p => {
      const ultimaVerificacao = p.verificacoes?.length > 0 ? [...p.verificacoes].pop() : null;
      return ultimaVerificacao && ultimaVerificacao.statusProcesso === filters.statusProcesso;
     });
    }
    if (filters.tipo) {
     results = results.filter(p => p.tipo === filters.tipo);
    }
    if (filters.juiz) {
     const lowerCaseJudge = filters.juiz.toLowerCase();
     results = results.filter(p => String(p.juiz || '').toLowerCase().includes(lowerCaseJudge));
    }
    if (searchTerm) {
     const lowerCaseSearchTerm = searchTerm.toLowerCase();
     results = results.filter(p =>
      String(p.numero || '').toLowerCase().includes(lowerCaseSearchTerm) ||
      String(p.paciente || '').toLowerCase().includes(lowerCaseSearchTerm) ||
      String(p.genitor || '').toLowerCase().includes(lowerCaseSearchTerm)
     );
    }
    // Ordenar resultados
    if (appState.advancedSearch.sortBy !== 'none') {
     results.sort((a, b) => {
      let valA, valB;
      if (appState.advancedSearch.sortBy === 'statusProcesso') {
       const ultimaVerifA = a.verificacoes?.length > 0 ? [...a.verificacoes].pop() : null;
       const ultimaVerifB = b.verificacoes?.length > 0 ? [...b.verificacoes].pop() : null;
       valA = ultimaVerifA ? ultimaVerifA.statusProcesso || '' : '';
       valB = ultimaVerifB ? ultimaVerifB.statusProcesso || '' : '';
      } else {
       valA = a[appState.advancedSearch.sortBy] || '';
       valB = b[appState.advancedSearch.sortBy] || '';
      }
      return valA.localeCompare(valB, undefined, { numeric: true }) * (appState.advancedSearch.sortOrder === 'asc' ? 1 : -1);
     });
    }
    
    appState.advancedSearch.results = results;
    UIService.renderAdvancedSearchResultsPage();
   } catch (error) {
    outputDiv.innerHTML = `<p class="text-red-500 p-4">Erro na busca: ${error.message}</p>`;
   }
  }
  /**
  * Altera a página da busca avançada.
  */
  function changeAdvancedSearchPage(direction) {
  const totalPages = Math.ceil(appState.advancedSearch.results.length / appState.advancedSearch.itemsPerPage);
  appState.advancedSearch.currentPage = Math.max(1, Math.min(totalPages, appState.advancedSearch.currentPage +
  direction));
  UIService.renderAdvancedSearchResultsPage();
  }
  
  /**
  * Exporta os resultados da busca avançada para PDF.
  */
  function exportAdvancedSearchResultsToPdf() {
  if (!appState.advancedSearch.results?.length) {
  Utils.showMessageBox('Não há resultados para exportar.', 'warning');
  return;
  }
  Utils.showToast('Gerando PDF...', 'info');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const columnsToExport = Object.keys(appState.advancedSearch.visibleColumns).filter(k =>
  appState.advancedSearch.visibleColumns[k]);
  const head = [columnsToExport.map(key => ({'numero': 'Nº Processo', 'paciente': 'Paciente', 'juiz': 'Juiz', 'tipo':
  'Tipo', 'statusProcesso': 'Status'}[key] || key))];
  const body = appState.advancedSearch.results.map(proc => columnsToExport.map(key => {
  if (key === 'statusProcesso') return proc.verificacoes?.length ? [...proc.verificacoes].pop().statusProcesso : 'N/A';
  return proc[key] || 'N/A';
  }));
  doc.autoTable({ head, body, startY: 25, didDrawPage: (data) => doc.text("Relatório de Processos", 14, 20) });
  doc.save('relatorio_avancado.pdf');
  }
  /**
  * Gera um resumo das alterações feitas nos itens do processo para registrar no histórico.
  */
  const getChangesSummary = (oldData, newTherapies, newMeds, newSurgeries, newOthers, newPrescription) => {
  let changes = [];
  
  // Compara Terapias
  (newTherapies || []).forEach((newTerapia, index) => {
  const oldTerapia = (oldData.terapias || [])[index];
  if (!oldTerapia) {
  changes.push(`Terapia "${newTerapia.nome}" adicionada.`);
  } else {
  // Compara cada campo relevante da terapia
  if (oldTerapia.clinicaProfissional !== newTerapia.clinicaProfissional) {
  changes.push(`Profissional da terapia "${newTerapia.nome}" alterado de "${oldTerapia.clinicaProfissional || 'Nenhum'}"
  para "${newTerapia.clinicaProfissional || 'Nenhum'}".`);
  }
  if (oldTerapia.ultimoRelatorio !== newTerapia.ultimoRelatorio) {
  changes.push(`Data do relatório da terapia "${newTerapia.nome}" atualizada.`);
  }
  if ((oldTerapia.qtdAtual || oldTerapia.quantidade) !== newTerapia.qtdAtual) {
  changes.push(`Qtd. prescrita da terapia "${newTerapia.nome}" atualizada.`);
  }
  if (oldTerapia.desnecessario !== newTerapia.desnecessario) {
  changes.push(`Status "desnecessário" da terapia "${newTerapia.nome}" alterado para ${newTerapia.desnecessario}.`);
 }
 }
 });
 // Compara Medicamentos
 (newMeds || []).forEach((newMed, index) => {
 const oldMed = (oldData.medicamentos || [])[index];
 if (!oldMed) {
 changes.push(`Medicamento "${newMed.nome}" adicionado.`);
 } else {
 if (oldMed.posologia !== newMed.posologia) {
 changes.push(`Posologia do medicamento "${newMed.nome}" atualizada.`);
 }
 if (oldMed.desnecessario !== newMed.desnecessario) {
 changes.push(`Status "desnecessário" do medicamento "${newMed.nome}" alterado para ${newMed.desnecessario}.`);
 }
 }
 });
 // Compara Cirurgias
 if (JSON.stringify(oldData.cirurgias || []) !== JSON.stringify(newSurgeries)) {
 changes.push('Cirurgias atualizadas.');
 }
 // Compara Outros Itens
 if (JSON.stringify(oldData.outrosItens || []) !== JSON.stringify(newOthers)) {
 changes.push('Outros itens atualizados.');
 }
 // Compara Data da Prescrição
 if ((oldData.ultimaprescricao || '') !== (newPrescription || '')) {
 changes.push('Data da prescrição atualizada.');
 }return changes.length > 0 ? changes.join(' ') : 'Nenhuma alteração específica nos itens.';
 };

return {
    handleDeleteProcess,
    handleUndoLastVerification,
    handleRegisterUser,
    openCreateModal,
    openEditModal,
    handleAddTerapia,
    handleUpdateTerapiaQty,
    handleRemoveItem,
    handleAddMedicamento,
    handleAddCirurgia,
    handleAddOutro,
    handleFormNovoProcessoSubmit,
    handleFormVerificacaoSubmit,
    handleAdminLogin,
    openAdminLoginModal,
    handleAddUserByAdmin,
    openReportAdvancedSearchModal,
    generateReportSummary,
    handleAdvancedSearch,
    performAdvancedSearch,
    changeAdvancedSearchPage,
    exportAdvancedSearchResultsToPdf,
    getChangesSummary,
    // Handlers de Contas
    handleAddContaRascunho,
    handleRemoveContaRascunho,
    handleClearAllContasRascunho,
    handleSaveAllContas,
    handleExportContasPDF,
    handleEditIndividualConta,
    handleUpdateIndividualConta,
    handleDeleteIndividualConta,
    handleUndoContasLote,
  _buildDashboardPanelsFromState
};
 })();
 
 function openAdminLoginModal() {
    if (appState.currentUser.isAdmin) {
        UIService.renderManageUsersModal();
        Modals.openModal('manage-users-modal');
    } else {
        const formContainer = document.getElementById('admin-login-form');
        if (formContainer) {
            formContainer.innerHTML = `
                <div>
                    <label for="admin-username" class="block text-sm font-medium text-gray-700">Utilizador</label>
                    <input type="text" id="admin-username" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm" required autocomplete="username">
                </div>
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="admin-password" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm" required autocomplete="current-password">
                </div>
                <div id="admin-login-error" class="text-red-500 text-sm hidden">Utilizador ou senha inválidos.</div>
                <div class="text-right">
                    <button type="submit" id="admin-login-submit-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Entrar</button>
                </div>
            `;
            document.getElementById('admin-login-form').addEventListener('submit', Handlers.handleAdminLogin);
        }
        Modals.openModal('admin-login-modal');
    }
}


const init = async () => {
    console.log('init: Iniciando o aplicativo.');
    
    // Busca as configurações do backend
    try {
        const config = await Utils.callBackend('getAppConfiguration', [], false);
        appState.config = config;
        console.log('Configurações da aplicação carregadas:', appState.config);
    } catch (error) {
        console.error("Falha ao carregar configurações da aplicação:", error);
        Utils.showMessageBox('Não foi possível carregar as configurações do aplicativo. Algumas listas podem não aparecer.', 'error');
        // Define um objeto de config vazio para não quebrar o resto do app
        appState.config = {};
    }
    
    // Renderiza a estrutura de TODOS os modais de uma só vez para evitar erros.
    document.getElementById('modals-container').innerHTML = `
        <div id="novo-processo-modal" class="modal-backdrop hidden fade-in">
            <div class="modal-content"><div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modal-title" class="text-xl font-semibold text-gray-800"></h3>
                    <button class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl leading-none" data-modal-id="novo-processo-modal">×</button>
                </div>
                <form id="form-novo-processo" class="space-y-4"></form>
            </div></div>
        </div>
        <div id="admin-login-modal" class="modal-backdrop hidden fade-in">
            <div class="modal-content"><div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800"><i class="fas fa-user-lock mr-2"></i>Login de Administrador</h3>
                    <button class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl leading-none" data-modal-id="admin-login-modal">×</button>
                </div>
                <form id="admin-login-form" class="space-y-4"></form>
            </div></div>
        </div>
        
        <div id="manage-users-modal" class="modal-backdrop hidden fade-in">
            <div class="modal-content">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800"><i class="fas fa-users-cog mr-2"></i>Gerenciar Utilizadores</h3>
                        <button class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl leading-none" data-modal-id="manage-users-modal">×</button>
                    </div>
                    <button id="toggle-add-user-form-btn" class="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 rounded-md mb-4 flex justify-between items-center">
                        <span class="font-semibold text-gray-700">
                            <i class="fas fa-user-plus mr-2"></i>Adicionar Novo Utilizador
                        </span>
                        <i id="toggle-add-user-icon" class="fas fa-chevron-down text-gray-500"></i>
                    </button>
                    <div id="add-user-form-container" class="hidden mb-6 border-b pb-6">
                        <form id="add-user-form" class="space-y-4">
                            <div>
                                <label for="new-user-email" class="block text-sm font-medium text-gray-700">
                                    <i class="fas fa-at mr-2 text-gray-500"></i>E-mail do Utilizador
                                </label>
                                <input type="email" id="new-user-email" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm" required placeholder="exemplo@mppr.mp.br">
                            </div>
                            <div>
                                <label for="new-user-name" class="block text-sm font-medium text-gray-700">
                                    <i class="fas fa-user mr-2 text-gray-500"></i>Nome do Utilizador
                                </label>
                                <input type="text" id="new-user-name" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm" required placeholder="Nome Completo">
                            </div>
                            <div class="text-right pt-2">
                                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 text-sm">
                                    <i class="fas fa-plus mr-2"></i>Adicionar Utilizador
                                </button>
                            </div>
                        </form>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-list-ul mr-2"></i>Utilizadores Registados
                    </h4>
                    <div class="px-1">
                        <div id="users-list" class="max-h-96 overflow-y-auto"></div>
                    </div>
                    <p id="no-users-message" class="text-gray-500 text-center hidden">Nenhum utilizador registado.</p>
                </div>
            </div>
        </div>

        <div id="notification-modal" class="modal-backdrop hidden fade-in">
            <div class="modal-content"><div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800"><i class="fas fa-bell mr-2"></i>Atenção! Prazos Importantes</h3>
                    <button class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl leading-none" data-modal-id="notification-modal">×</button>
                </div>
                <div id="notification-content" class="space-y-3"></div>
                <div class="mt-6 text-right">
                    <button type="button" class="py-2 px-5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none close-modal-btn" data-modal-id="notification-modal">Entendi</button>
                </div>
            </div></div>
        </div>
        <div id="edit-conta-modal" class="modal-backdrop hidden fade-in">
            <div class="modal-content">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="edit-conta-modal-title" class="text-xl font-semibold text-gray-800"><i class="fas fa-edit mr-2"></i>Editar Lançamento Contábil</h3>
                        <button class="close-modal-btn text-gray-500 hover:text-gray-800 text-2xl leading-none" data-modal-id="edit-conta-modal">×</button>
                    </div>
                    <form id="form-edit-conta" class="space-y-4">
                        <input type="hidden" id="edit-conta-id"> <input type="hidden" id="edit-conta-format"> 
                        <input type="hidden" id="edit-conta-verif-index">
                        <input type="hidden" id="edit-conta-conta-index"> 
                        <div>
                            <label for="edit-contas-tipo" class="block text-sm font-medium"><i class="fas fa-tags mr-1"></i>Tipo de Registro<span class="text-red-500 ml-1">*</span></label>
                            <select id="edit-contas-tipo" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white border" required>
                                <option value="" disabled selected>Selecione o tipo...</option>
                                <option value="Alvará">Alvará (Crédito)</option>
                                <option value="Tratamento">Tratamento/Sessões (Débito)</option>
                                <option value="Despesa Geral">Despesa Geral (Débito)</option>
                            </select>
                        </div>
                        <div>
                            <label for="edit-contas-data" class="block text-sm font-medium"><i class="fas fa-calendar-alt mr-1"></i>Data da Movimentação (NF/Alvará)<span class="text-red-500 ml-1">*</span></label>
                            <input type="date" id="edit-contas-data" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border" required>
                        </div>
                        <div id="edit-contas-tratamento-fields" class="space-y-4 hidden pt-2 border-t">
                            <h5 class="text-md font-semibold text-gray-700">Detalhes do Tratamento/Despesa</h5>
                            <div>
                                <label for="edit-contas-terapia-select" class="block text-sm font-medium"><i class="fas fa-notes-medical mr-1"></i>Selecione a Terapia/Medicamento/Despesa<span class="text-red-500 ml-1">*</span></label>
                                <select id="edit-contas-terapia-select" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white border">
                                    <option value="" disabled selected>Selecione...</option>
                                    <option value="OUTRO">Outra (digitar manualmente)</option>
                                </select>
                                <input type="text" id="edit-contas-terapia-nome-manual" placeholder="Digite o nome da terapia/despesa" class="mt-2 block w-full p-2 border-gray-300 rounded-md shadow-sm border hidden">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="edit-contas-terapia-qtd" class="block text-sm font-medium"><i class="fas fa-sort-numeric-up-alt mr-1"></i>Quantidade (Sessões/Unidades)</label>
                                    <input type="number" id="edit-contas-terapia-qtd" min="0" placeholder="Ex: 10 sessões" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label for="edit-contas-terapia-mes" class="block text-sm font-medium">Mês Referência</label>
                                        <input type="number" id="edit-contas-terapia-mes" min="1" max="12" placeholder="MM" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border">
                                    </div>
                                    <div>
                                        <label for="edit-contas-terapia-ano" class="block text-sm font-medium">Ano Referência</label>
                                        <input type="number" id="edit-contas-terapia-ano" min="2000" max="2100" placeholder="AAAA" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label for="edit-contas-observacoes" class="block text-sm font-medium"><i class="fas fa-comment-alt mr-1"></i>Observações do Lançamento (Opcional)</label>
                                <textarea id="edit-contas-observacoes" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border"></textarea>
                            </div>
                        </div>
                        <div id="edit-contas-outros-fields" class="space-y-4 hidden pt-2 border-t">
                            <h5 class="text-md font-semibold text-gray-700">Detalhes da Despesa Geral</h5>
                            <div>
                                <label for="edit-contas-outros-nome-manual" class="block text-sm font-medium"><i class="fas fa-file-invoice mr-1"></i>Nome da Despesa Geral<span class="text-red-500 ml-1">*</span></label>
                                <input type="text" id="edit-contas-outros-nome-manual" placeholder="Ex: Cópia de documentos, Despesa com transporte" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border">
                            </div>
                        </div>
                        <div>
                            <label for="edit-contas-mov-processo-choice" class="block text-sm font-medium"><i class="fas fa-file-alt mr-1"></i>Mov. Processo<span class="text-red-500 ml-1">*</span></label>
                            <select id="edit-contas-mov-processo-choice" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm bg-white border">
                                <option value="Anexo">Anexo</option>
                                <option value="Digitar">Digitar número do movimento</option>
                            </select>
                            <input type="text" id="edit-contas-mov-processo-input" placeholder="Apenas números, ex: 99" class="mt-2 block w-full p-2 border-gray-300 rounded-md shadow-sm border hidden" autocomplete="off">
                        </div>
                        <div>
                            <label for="edit-contas-nf-alvara" class="block text-sm font-medium"><i class="fas fa-hashtag mr-1"></i>Nº NF/Alvará<span class="text-red-500 ml-1">*</span></label>
                            <input type="text" id="edit-contas-nf-alvara" placeholder="Apenas números, ex: 3018642025" class="mt-1 block w-full p-2 border-gray-300 rounded-md shadow-sm border" required>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="edit-contas-valor-alvara" class="block text-sm font-medium text-green-700"><i class="fas fa-arrow-down mr-1"></i>Valor do Alvará (Crédito)</label>
                                <input type="text" inputmode="numeric" id="edit-contas-valor-alvara" class="mt-1 block w-full p-2 border-green-300 rounded-md shadow-sm border" placeholder="0.00">
                            </div>
                            <div>
                                <label for="edit-contas-valor-conta" class="block text-sm font-medium text-red-700"><i class="fas fa-arrow-up mr-1"></i>Valor da Conta (Débito)</label>
                                <input type="text" inputmode="numeric" id="edit-contas-valor-conta" class="mt-1 block w-full p-2 border-red-300 rounded-md shadow-sm border" placeholder="0.00">
                            </div>
                        </div>
                        <div class="text-right">
                            <button type="button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 mr-2 close-modal-btn" data-modal-id="edit-conta-modal"><i class="fas fa-times mr-2"></i>Cancelar</button>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700"><i class="fas fa-save mr-2"></i>Salvar Alterações</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;

    // Listeners para elementos estáticos que existem desde o início
    document.getElementById('open-novo-processo-modal-btn').addEventListener('click', Handlers.openCreateModal);
    document.getElementById('search-select-input').addEventListener('input', UIService.handleSearchInput);
    document.getElementById('search-select-input').addEventListener('focus', UIService.handleSearchFocus);
    document.getElementById('open-admin-config-modal-btn').addEventListener('click', openAdminLoginModal);
    document.getElementById('open-report-advanced-search-modal-btn').addEventListener('click', Handlers.openReportAdvancedSearchModal);
    document.getElementById('generate-report-btn').addEventListener('click', Handlers.generateReportSummary);
    document.getElementById('export-pdf-btn').addEventListener('click', Handlers.exportAdvancedSearchResultsToPdf);
    document.getElementById('advanced-search-form').addEventListener('submit', Handlers.handleAdvancedSearch);
    document.getElementById('adv-prev-page').addEventListener('click', () => Handlers.changeAdvancedSearchPage(-1));
    document.getElementById('adv-next-page').addEventListener('click', () => Handlers.changeAdvancedSearchPage(1));
    
    // Listeners para formulários (que estão sempre no DOM dentro dos modais)
    document.getElementById('register-user-form').addEventListener('submit', Handlers.handleRegisterUser);
    document.getElementById('admin-login-form').addEventListener('submit', Handlers.handleAdminLogin);
    document.getElementById('add-user-form').addEventListener('submit', Handlers.handleAddUserByAdmin);
    document.getElementById('form-edit-conta').addEventListener('submit', Handlers.handleUpdateIndividualConta);
    
    // Listener para fechar a barra de pesquisa ao clicar fora
    document.addEventListener('click', (event) => {
        const searchInput = document.getElementById('search-select-input');
        const optionsPanel = document.getElementById('options-panel');
        if (!optionsPanel || optionsPanel.classList.contains('hidden')) {
            return; 
        }
        const isClickInsideSearch = searchInput.contains(event.target);
        const isClickInsidePanel = optionsPanel.contains(event.target);
        if (!isClickInsideSearch && !isClickInsidePanel) {
            optionsPanel.classList.add('hidden');
        }
    });

    // DELEGAÇÃO DE EVENTOS: Um único listener no body para todos os botões dinâmicos
    document.body.addEventListener('click', (e) => {
        const target = e.target;
        const closeModalButton = target.closest('.close-modal-btn');
        if (closeModalButton) {
            const modalId = closeModalButton.dataset.modalId || closeModalButton.closest('.modal-backdrop')?.id;
            if (modalId) Modals.closeModal(modalId);
            return;
        }
        const editProcessoButton = target.closest('#edit-processo-btn');
        if (editProcessoButton) return Handlers.openEditModal();
        const deleteProcessoButton = target.closest('#delete-processo-btn');
        if (deleteProcessoButton) return Handlers.handleDeleteProcess();
        const undoVerificationButton = target.closest('#undo-last-verification-btn');
        if (undoVerificationButton) return Handlers.handleUndoLastVerification(e);
    });

    // NOVO SCRIPT PARA O BOTÃO DE EXPANDIR/RECOLHER FORMULÁRIO
    document.getElementById('toggle-add-user-form-btn').addEventListener('click', () => {
        const formContainer = document.getElementById('add-user-form-container');
        const icon = document.getElementById('toggle-add-user-icon');
        formContainer.classList.toggle('hidden');
        if (formContainer.classList.contains('hidden')) {
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        } else {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        }
    });

    // Inicia o processo de verificação do usuário e carregamento de dados
    await DataService.checkUserStatusAndFetchData();
    showInitialNotification();

    // Inicia timers para atualizações periódicas
    setInterval(UIService.renderActiveUsersPanel, 15000);
    setInterval(async () => {
        if (appState.currentUser && appState.currentUser.isRegistered) {
            try {
                const latestUserInfo = await Utils.callBackend('getActiveUserRegisteredInfo', [], false);
                if (!latestUserInfo.isRegistered) {
                    console.log("HEARTBEAT: Acesso revogado detectado. Desconectando usuário.");
                    await Utils.showMessageBox('Seu acesso a esta aplicação foi revogado por um administrador. A página será recarregada.', 'warning', 'Acesso Revogado');
                    location.reload();
                }
            } catch (error) {
                console.error("HEARTBEAT: Erro ao verificar status do usuário:", error);
            }
        }
    }, 60000);
};

   function showInitialNotification() {
   if (!appState.currentUser.isRegistered) {
   return;
   }
   let notificationMessage = '';
   // CORREÇÃO: Lendo diretamente do estado da aplicação (appState)
   if (appState.db.painelAtrasados && appState.db.painelAtrasados.length > 0) {
   notificationMessage += `<p class="text-red-700 font-semibold mb-2"><i class="fas fa-exclamation-circle mr-2"></i>Você
     tem <span class="font-bold">${appState.db.painelAtrasados.length}</span> processo(s) ATRASADO(S)!</p>`;
   }
   if (appState.db.painelParaAtrasar && appState.db.painelParaAtrasar.length > 0) {
   notificationMessage += `<p class="text-yellow-700 font-semibold mb-2"><i class="fas fa-clock mr-2"></i>Você tem
     <span class="font-bold">${appState.db.painelParaAtrasar.length}</span> processo(s) PARA ATRASAR nos próximos 7 dias!
   </p>`;
   }
   if (notificationMessage) {
   const notificationContent = document.getElementById('notification-content');
   const notificationModal = document.getElementById('notification-modal');
   if (notificationContent && notificationModal) {
   notificationContent.innerHTML = notificationMessage;
   Modals.openModal('notification-modal');
   }
   }
   }
   // --- INICIALIZAÇÃO ---
   init();
   });
  </script>

</html>
